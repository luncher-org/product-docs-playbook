<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Register Downstream Clusters :: Rancher product documentation</title>
    <link rel="canonical" href="https://documentation.suse.com/cloudnative/continuous-delivery/v0.11/en/cluster-registration.html">
    <link rel="prev" href="installation.html">
    <link rel="next" href="cluster-group.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../_/css/vendor/light.css">
<!-- <script src="/docserv/res/lightheaded/analytics.js"
        type="text/javascript"></script> -->
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a class=" navbar-logo" href="https://documentation.suse.com/" aria-label="SUSE Documentation Home"><img class="logo"
            src="../../../_/img/logo.svg" alt="SUSE logo"/></a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">
            <img src="../../../_/img/resources.png" class="langIcon Resurces" alt="Resources" title="Resources">
          </div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/rancher/fleet-product-docs"><i class="fab fa-github"></i>&nbsp;Continuous Delivery</a>
            <div class="has-submenu">
              <a class="navbar-item" href="#" ><i class="fas fa-file-alt"></i>&nbsp;Report Issue &nbsp;<i class="fas fa-chevron-right"></i></a>
              <div class="submenu">
                <a class="navbar-item" href="https://scc.suse.com">SCC (Recommended)</a>
                <a class="navbar-item" href="https://github.com/rancher/fleet-product-docs/issues">GitHub Issue</a>
              </div>
            </div>
            <a class="navbar-item" href="https://github.com/rancher/product-docs-playbook/blob/main/CONTRIBUTING.md"><i class="fas fa-user-edit"></i>&nbsp;Contribute</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link"><img src="../../../_/img/language.png" class="langIcon Language" alt="Language"
              title="Language"></div>
          <div class="navbar-dropdown">
            <!--  </div><div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div> -->
              <a role="button" class="navbar-item" id="en" onclick="selectLanguage(this.id)">
                <!--<img src="../../../_/img/engFlag.svg" class="langIcon english">-->
                &nbsp;English
              </a>
            <!-- LANGUAGESELECTOR -->
          </div>
        </div>
        <!--
        <div class="navbar-item">
          <a href="https://twitter.com/SUSE">
            <img alt="X-logo" class="x-logo" src="../../../_/img/x-logo-white.png">
          </a>
        </div>
        -->
      </div>
    </div>

    <!--   <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
      </div> -->
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="continuous-delivery" data-version="v0.11">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="index.html">Continuous Delivery</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quickstart.html">Quickstart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tut-deployment.html">Creating a Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="uninstall.html">Uninstall</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Explanations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="concepts.html">Core Concepts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-bundle-stages.html">Bundle Lifecycle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gitrepo-content.html">Git Repository Contents</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="namespaces.html">Namespaces</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resources-during-deployment.html">Custom Resources During Deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">How-tos for Operators</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installation.html">Installation Details</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="cluster-registration.html">Register Downstream Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-group.html">Create Cluster Groups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="multi-user.html">Setup Multi User</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">How-tos for Users</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gitrepo-add.html">Create a GitRepo Resource</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gitrepo-targets.html">Mapping to Downstream Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bundle-diffs.html">Generating Diffs to Ignore Modified GitRepos</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="webhook.html">Using Webhooks Instead of Polling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="imagescan.html">Using Image Scan to Update Container Image References</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bundle-add.html">Create a Bundle Resource</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">CLI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-agent/fleet-agent.html">fleet-agent</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-agent/fleet-agent_clusterstatus.html">fleet-agent clusterstatus</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-agent/fleet-agent_register.html">fleet-agent register</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet.html">fleet</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet_apply.html">fleet apply</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet_cleanup.html">fleet cleanup</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet_deploy.html">fleet deploy</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet_target.html">fleet target</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet_test.html">fleet test</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-controller/fleetcontroller.html">fleetcontroller</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-controller/fleetcontroller_agentmanagement.html">fleetcontroller agentmanagement</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-controller/fleetcontroller_cleanup.html">fleetcontroller cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-status-fields.html">Cluster and Bundle State</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resources-list.html">Resources List</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-registration.html">Cluster Registration Internals</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-resources.html">List of Deployed Resources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-crds.html">Custom Resources Spec</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-fleet-yaml.html">fleet.yaml</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-gitrepo.html">GitRepo Resource</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-bundle.html">Bundle Resource</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="troubleshooting.html">Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Changelog</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="v0.11.1.html">v0.11.1</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Continuous Delivery</span>
    <span class="version">0.11</span>
  </div>
  <ul class="components">
        <li class="component">
          <div class="title"><a href="../../../cluster-api/v0.16/en/index.html">Cluster API</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../cluster-api/v0.16/en/index.html">0.16</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.15/en/index.html">0.15</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.11/en/index.html">0.11</a>
            </li>
          </ul>
        </li>
        <li class="component is-current">
          <div class="title"><a href="index.html">Continuous Delivery</a></div>
          <ul class="versions">
            <li class="version is-current is-latest">
              <a href="index.html">0.11</a>
            </li>
            <li class="version">
              <a href="../../v0.10/en/index.html">0.10</a>
            </li>
            <li class="version">
              <a href="../../v0.9/en/index.html">0.9</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../k3s/latest/en/introduction.html">K3s</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../k3s/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../os-manager/1.6/en/index.html">OS Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../os-manager/1.6/en/index.html">1.6</a>
            </li>
            <li class="version">
              <a href="../../../os-manager/1.5/en/index.html">1.5</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../policy-manager/1.22/en/introduction.html">Policy Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../policy-manager/1.22/en/introduction.html">1.22-next</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.21/en/introduction.html">1.21</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.20/en/introduction.html">1.20</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.19/en/introduction.html">1.19</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.18/en/introduction.html">1.18</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.17/en/introduction.html">1.17</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.16/en/introduction.html">1.16</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../rke2/latest/en/introduction.html">RKE2</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../rke2/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">SUSE® Rancher Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.10/en/about-rancher/what-is-rancher.html">v2.10</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.9/en/about-rancher/what-is-rancher.html">v2.9</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.8/en/about-rancher/what-is-rancher.html">v2.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../security/5.4/en/overview.html">SUSE® Security</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../security/5.4/en/overview.html">5.4</a>
            </li>
            <li class="version">
              <a href="../../../security/5.3/en/overview.html">5.3</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../storage/1.9.0/en/longhorn-documentation.html">SUSE® Storage</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../storage/1.9.0/en/longhorn-documentation.html">1.9.0 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../storage/1.8.0/en/longhorn-documentation.html">1.8.0 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../storage/1.7.0/en/longhorn-documentation.html">1.7.0</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../virtualization/v1.5/en/introduction/overview.html">SUSE® Virtualization</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../virtualization/v1.5/en/introduction/overview.html">v1.5 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../virtualization/v1.4/en/introduction/overview.html">v1.4 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../virtualization/v1.3/en/introduction/overview.html">v1.3</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html" aria-label="Home" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Continuous Delivery</a></li>
    <li>How-tos for Operators</li>
    <li><a href="cluster-registration.html">Register Downstream Clusters</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">0.11</button>
  <div class="version-menu">
    <a class="version is-current" href="cluster-registration.html">0.11</a>
    <a class="version" href="../../v0.10/en/cluster-registration.html">0.10</a>
    <a class="version" href="../../v0.9/en/cluster-registration.html">0.9</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/rancher/fleet-product-docs/edit/main/versions/v0.11/modules/en/pages/cluster-registration.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Register Downstream Clusters</h1>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are two specific styles to registering clusters. These styles will be referred
to as <strong>agent-initiated</strong> and <strong>manager-initiated</strong> registration. Typically one would
go with the agent-initiated registration but there are specific use cases in which
manager-initiated is a better workflow.</p>
</div>
<div class="sect2">
<h3 id="_agent_initiated_registration"><a class="anchor" href="#_agent_initiated_registration"></a>Agent-Initiated Registration</h3>
<div class="paragraph">
<p>Agent-initiated refers to a pattern in which the downstream cluster installs an agent with a
<a href="#_create_cluster_registration_tokens">cluster registration token</a> and optionally a client ID. The cluster
agent will then make a API request to the SUSE® Rancher Prime Continuous Delivery manager and initiate the registration process. Using
this process the Manager will never make an outbound API request to the downstream clusters and will thus
never need to have direct network access. The downstream cluster only needs to make outbound HTTPS
calls to the manager.</p>
</div>
</div>
<div class="sect2">
<h3 id="_manager_initiated_registration"><a class="anchor" href="#_manager_initiated_registration"></a>Manager-Initiated Registration</h3>
<div class="paragraph">
<p>Manager-initiated registration is a process in which you register an existing Kubernetes cluster
with the SUSE® Rancher Prime Continuous Delivery manager and the SUSE® Rancher Prime Continuous Delivery manager will make an API call to the downstream cluster to
deploy the agent. This style can place additional network access requirements because the Fleet
manager must be able to communicate with the downstream cluster API server for the registration process.
After the cluster is registered there is no further need for the manager to contact the downstream
cluster API.  This style is more compatible if you wish to manage the creation of all your Kubernetes
clusters through GitOps using something like <a href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a>
or <a href="https://github.com/rancher/rancher">Rancher</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_agent_initiated"><a class="anchor" href="#_agent_initiated"></a>Agent Initiated</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A downstream cluster is registered by installing an agent via helm and using the <strong>cluster registration token</strong> and optionally a <strong>client ID</strong> or <strong>cluster labels</strong>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It&#8217;s not necessary to configure the fleet manager for <a href="installation.html#_configuration_for_multi_cluster" class="xref page">multi cluster</a>, as the downstream agent we install via Helm will connect to the Kubernetes API of the upstream cluster directly.</p>
</div>
<div class="paragraph">
<p>Agent-initiated registration is normally not used with Rancher.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_cluster_registration_token_and_client_id"><a class="anchor" href="#_cluster_registration_token_and_client_id"></a>Cluster Registration Token and Client ID</h3>
<div class="paragraph">
<p>The <strong>cluster registration token</strong> is a credential that will authorize the downstream cluster agent to be
able to initiate the registration process. This is required.
The <a href="architecture.html#_security" class="xref page">cluster registration token</a> is manifested as a <code>values.yaml</code> file that will be passed to the <code>helm install</code> process.
Alternatively one can pass the token directly to the helm install command via <code>--set token="$token"</code>.</p>
</div>
<div class="paragraph">
<p>There are two styles of registering an agent. You can have the cluster for this agent dynamically created, in which
case you will probably want to specify <strong>cluster labels</strong> upon registration.  Or you can have the agent register to a predefined
cluster in the SUSE® Rancher Prime Continuous Delivery manager, in which case you will need a <strong>client ID</strong>.  The former approach is typically the easiest.</p>
</div>
</div>
<div class="sect2">
<h3 id="_install_agent_for_a_new_cluster"><a class="anchor" href="#_install_agent_for_a_new_cluster"></a>Install Agent For a New Cluster</h3>
<div class="paragraph">
<p>The SUSE® Rancher Prime Continuous Delivery agent is installed as a Helm chart. Following are explanations how to determine and set its parameters.</p>
</div>
<div class="paragraph">
<p>First, follow the <a href="#_create_cluster_registration_tokens">cluster registration token instructions</a> to obtain the <code>values.yaml</code> which contains
the registration token to authenticate against the SUSE® Rancher Prime Continuous Delivery cluster.</p>
</div>
<div class="paragraph">
<p>Second, optionally you can define labels that will assigned to the newly created cluster upon registration. After
registration is completed an agent cannot change the labels of the cluster. To add cluster labels add
<code>--set-string labels.KEY=VALUE</code> to the below Helm command. To add the labels <code>foo=bar</code> and <code>bar=baz</code> then you would
add <code>--set-string labels.foo=bar --set-string labels.bar=baz</code> to the command line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># Leave blank if you do not want any labels
CLUSTER_LABELS="--set-string labels.example=true --set-string labels.env=dev"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Third, set variables with the SUSE® Rancher Prime Continuous Delivery cluster&#8217;s API Server URL and CA, for the downstream cluster to use for connecting.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">API_SERVER_URL=https://&lt;API_URL&gt;:6443
API_SERVER_CA_DATA=...</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the API server is not listening on the https port (443), the <code>API_SERVER_URL</code> should include the port, e.g. <code><a href="https://&lt;API_URL&gt;:6443" class="bare">https://&lt;API_URL&gt;:6443</a></code>. The URL can be found in the <code>.kube/config</code> file.</p>
</div>
<div class="paragraph">
<p>Value in <code>API_SERVER_CA_DATA</code> can be obtained from a <code>.kube/config</code> file with valid data to connect to the upstream cluster
(under the <code>certificate-authority-data</code> key). Alternatively it can be obtained from within the upstream cluster itself,
by looking up the default ServiceAccount secret name (typically prefixed with <code>default-token-</code>, in the default namespace),
under the <code>ca.crt</code> key.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Use proper namespace and release name</strong>:
For the agent chart the namespace must be <code>cattle-fleet-system</code> and the release name <code>fleet-agent</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Kubectl Context</div>
<div class="paragraph">
<p><strong>Ensure you are installing to the right cluster</strong>:
Helm will use the default context in <code>${HOME}/.kube/config</code> to deploy the agent. Use <code>--kubeconfig</code> and <code>--kube-context</code>
to change which cluster Helm is installing to.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">SUSE® Rancher Prime Continuous Delivery in Rancher</div>
<div class="paragraph">
<p>Rancher has separate helm charts for SUSE® Rancher Prime Continuous Delivery and uses a different repository.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add Fleet&#8217;s Helm repo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm repo add fleet https://rancher.github.io/fleet-helm-charts/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, install the agent using Helm.</p>
</div>
<div id="_tabs_1" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_1_install" class="tab">
<p>Install</p>
</li>
<li id="_tabs_1_validate" class="tab">
<p>Validate</p>
</li>
</ul>
</div>
<div id="_tabs_1_install--panel" class="tabpanel" aria-labelledby="_tabs_1_install">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm -n cattle-fleet-system install --create-namespace --wait \
    --set clientID="$CLUSTER_CLIENT_ID" \
    --values values.yaml \
    fleet-agent fleet/fleet-agent</code></pre>
</div>
</div>
</div>
<div id="_tabs_1_validate--panel" class="tabpanel" aria-labelledby="_tabs_1_validate">
<div class="paragraph">
<p>You can check that status of the fleet pods by running the below commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># Ensure kubectl is pointing to the right cluster kubectl -n cattle-fleet-system logs -l app=fleet-agent kubectl -n cattle-fleet-system get pods -l app=fleet-agent</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The agent should now be deployed.</p>
</div>
<div class="paragraph">
<p>Additionally you should see a new cluster registered in the SUSE® Rancher Prime Continuous Delivery manager.  Below is an example of checking that a new cluster
was registered in the <code>clusters</code> <a href="namespaces.html" class="xref page">namespace</a>.  Please ensure your <code>${HOME}/.kube/config</code> is pointed to the Fleet
manager to run this command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl -n clusters get clusters.fleet.cattle.io</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                   BUNDLES-READY   NODES-READY   SAMPLE-NODE             LAST-SEEN              STATUS
cluster-ab13e54400f1   1/1             1/1           k3d-cluster2-server-0   2020-08-31T19:23:10Z</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_install_agent_for_a_predefined_cluster"><a class="anchor" href="#_install_agent_for_a_predefined_cluster"></a>Install Agent For a Predefined Cluster</h3>
<div class="paragraph">
<p>Client IDs are for the purpose of predefining clusters in the SUSE® Rancher Prime Continuous Delivery manager with existing labels and repos targeted to them.
A client ID is not required and is just one approach to managing clusters.
The <strong>client ID</strong> is a unique string that will identify the cluster.
This string is user generated and opaque to the SUSE® Rancher Prime Continuous Delivery manager and agent.  It is assumed to be sufficiently unique. For security reasons one should not be able to easily guess this value
as then one cluster could impersonate another.  The client ID is optional and if not specified the UID field of the <code>kube-system</code> namespace
resource will be used as the client ID. Upon registration if the client ID is found on a <code>Cluster</code> resource in the SUSE® Rancher Prime Continuous Delivery manager it will associate
the agent with that <code>Cluster</code>.  If no <code>Cluster</code> resource is found with that client ID a new <code>Cluster</code> resource will be created with the specific
client ID.</p>
</div>
<div class="paragraph">
<p>The SUSE® Rancher Prime Continuous Delivery agent is installed as a Helm chart. The only parameters to the helm chart installation should be the cluster registration token, which
is represented by the <code>values.yaml</code> file and the client ID.  The client ID is optional.</p>
</div>
<div class="paragraph">
<p>First, create a <code>Cluster</code> in the SUSE® Rancher Prime Continuous Delivery Manager with the random client ID you have chosen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: Cluster
apiVersion: fleet.cattle.io/v1alpha1
metadata:
  name: my-cluster
  namespace: clusters
spec:
  clientID: "really-random"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Second, follow the [cluster registration token instructions]((#create-cluster-registration-tokens) to obtain the <code>values.yaml</code> file to be used.</p>
</div>
<div class="paragraph">
<p>Third, setup your environment to use the client ID.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">CLUSTER_CLIENT_ID="really-random"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Use proper namespace and release name</strong>:
For the agent chart the namespace must be <code>cattle-fleet-system</code> and the release name <code>fleet-agent</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Ensure you are installing to the right cluster</strong>:
Helm will use the default context in <code>${HOME}/.kube/config</code> to deploy the agent. Use <code>--kubeconfig</code> and <code>--kube-context</code>
to change which cluster Helm is installing to.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add Fleet&#8217;s Helm repo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm repo add fleet https://rancher.github.io/fleet-helm-charts/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, install the agent using Helm.</p>
</div>
<div id="_tabs_2" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_2_install" class="tab">
<p>Install</p>
</li>
<li id="_tabs_2_validate" class="tab">
<p>Validate</p>
</li>
</ul>
</div>
<div id="_tabs_2_install--panel" class="tabpanel" aria-labelledby="_tabs_2_install">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">helm -n cattle-fleet-system install --create-namespace --wait \
    --set clientID="$CLUSTER_CLIENT_ID" \
    --values values.yaml \
    fleet-agent fleet/fleet-agent</code></pre>
</div>
</div>
</div>
<div id="_tabs_2_validate--panel" class="tabpanel" aria-labelledby="_tabs_2_validate">
<div class="paragraph">
<p>You can check that status of the fleet pods by running the below commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell"># Ensure kubectl is pointing to the right cluster kubectl -n cattle-fleet-system logs -l app=fleet-agent kubectl -n cattle-fleet-system get pods -l app=fleet-agent</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The agent should now be deployed.</p>
</div>
<div class="paragraph">
<p>Additionally you should see a new cluster registered in the SUSE® Rancher Prime Continuous Delivery manager.  Below is an example of checking that a new cluster
was registered in the <code>clusters</code> <a href="namespaces.html" class="xref page">namespace</a>.  Please ensure your <code>${HOME}/.kube/config</code> is pointed to the Fleet
manager to run this command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl -n clusters get clusters.fleet.cattle.io</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                   BUNDLES-READY   NODES-READY   SAMPLE-NODE             LAST-SEEN              STATUS
my-cluster             1/1             1/1           k3d-cluster2-server-0   2020-08-31T19:23:10Z</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_cluster_registration_tokens"><a class="anchor" href="#_create_cluster_registration_tokens"></a>Create Cluster Registration Tokens</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Not needed for Manager-initiated registration</strong>:
For manager-initiated registrations the token is managed by the SUSE® Rancher Prime Continuous Delivery manager and does
not need to be manually created and obtained.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For an agent-initiated registration the downstream cluster must have a <a href="architecture.html#_security" class="xref page">cluster registration token</a>.
Cluster registration tokens are used to establish a new identity for a cluster. Internally
cluster registration tokens are managed by creating Kubernetes service accounts that have the
permissions to create <code>ClusterRegistrationRequests</code> within a specific namespace.  Once the
cluster is registered a new <code>ServiceAccount</code> is created for that cluster that is used as
the unique identity of the cluster. The agent is designed to forget the cluster registration
token after registration. While the agent will not maintain a reference to the cluster registration
token after a successful registration please note that usually other system bootstrap scripts do.</p>
</div>
<div class="paragraph">
<p>Since the cluster registration token is forgotten, if you need to re-register a cluster you must
give the cluster a new registration token.</p>
</div>
<div class="sect3">
<h4 id="_token_ttl"><a class="anchor" href="#_token_ttl"></a>Token TTL</h4>
<div class="paragraph">
<p>Cluster registration tokens can be reused by any cluster in a namespace.  The tokens can be given a TTL
such that it will expire after a specific time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_new_token"><a class="anchor" href="#_create_a_new_token"></a>Create a new Token</h4>
<div class="paragraph">
<p>The <code>ClusterRegistationToken</code> is a namespaced type and should be created in the same namespace
in which you will create <code>GitRepo</code> and <code>ClusterGroup</code> resources. For in depth details on how namespaces
are used in SUSE® Rancher Prime Continuous Delivery refer to the documentation on <a href="namespaces.html" class="xref page">namespaces</a>.  Create a new
token with the below YAML.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: ClusterRegistrationToken
apiVersion: "fleet.cattle.io/v1alpha1"
metadata:
    name: new-token
    namespace: clusters
spec:
    # A duration string for how long this token is valid for. A value &lt;= 0 or null means infinite time.
    ttl: 240h</code></pre>
</div>
</div>
<div class="paragraph">
<p>After the <code>ClusterRegistrationToken</code> is created, SUSE® Rancher Prime Continuous Delivery will create a corresponding <code>Secret</code> with the same name.
As the <code>Secret</code> creation is performed asynchronously, you will need to wait until it&#8217;s available before using it.</p>
</div>
<div class="paragraph">
<p>One way to do so is via the following one-liner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">while ! kubectl --namespace=clusters  get secret new-token; do sleep 5; done</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_obtaining_token_value_agent_values_yaml"><a class="anchor" href="#_obtaining_token_value_agent_values_yaml"></a>Obtaining Token Value (Agent values.yaml)</h4>
<div class="paragraph">
<p>The token value contains YAML content for a <code>values.yaml</code> file that is expected to be passed to <code>helm install</code>
to install the SUSE® Rancher Prime Continuous Delivery agent on a downstream cluster.</p>
</div>
<div class="paragraph">
<p>Such value is contained in the <code>values</code> field of the <code>Secret</code> mentioned above. To obtain the YAML content for the
above example one can run the following one-liner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">kubectl --namespace clusters get secret new-token -o 'jsonpath={.data.values}' | base64 --decode &gt; values.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the <code>values.yaml</code> is ready it can be used repeatedly by clusters to register until the TTL expires.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_manager_initiated"><a class="anchor" href="#_manager_initiated"></a>Manager Initiated</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The manager-initiated registration flow is accomplished by creating a
<code>Cluster</code> resource in the SUSE® Rancher Prime Continuous Delivery Manager that refers to a Kubernetes
<code>Secret</code> containing a valid kubeconfig file in the data field called <code>value</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using SUSE® Rancher Prime Continuous Delivery standalone <em>without Rancher</em>, it must be installed as described in <a href="installation.html#_configuration_for_multi_cluster" class="xref page">installation details</a>.</p>
</div>
<div class="paragraph">
<p>The manager-initiated registration is used when you add a cluster from the Rancher dashboard.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_create_kubeconfig_secret"><a class="anchor" href="#_create_kubeconfig_secret"></a>Create Kubeconfig Secret</h3>
<div class="paragraph">
<p>The format of this secret is intended to match the <a href="https://cluster-api.sigs.k8s.io/developer/architecture/controllers/cluster#secrets">format</a> of the kubeconfig
secret used in <a href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a>.
This means you can use <code>cluster-api</code> to create a cluster that is dynamically registered withSUSE® Rancher Prime Continuous Delivery.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">title="Kubeconfig Secret Example"
kind: Secret
apiVersion: v1
metadata:
  name: my-cluster-kubeconfig
  namespace: clusters
data:
  value: YXBpVmVyc2lvbjogdjEKY2x1c3RlcnM6Ci0gY2x1c3RlcjoKICAgIHNlcnZlcjogaHR0cHM6Ly9leGFtcGxlLmNvbTo2NDQzCiAgbmFtZTogY2x1c3Rlcgpjb250ZXh0czoKLSBjb250ZXh0OgogICAgY2x1c3RlcjogY2x1c3RlcgogICAgdXNlcjogdXNlcgogIG5hbWU6IGRlZmF1bHQKY3VycmVudC1jb250ZXh0OiBkZWZhdWx0CmtpbmQ6IENvbmZpZwpwcmVmZXJlbmNlczoge30KdXNlcnM6Ci0gbmFtZTogdXNlcgogIHVzZXI6CiAgICB0b2tlbjogc29tZXRoaW5nCg==</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_cluster_resource"><a class="anchor" href="#_create_cluster_resource"></a>Create Cluster Resource</h3>
<div class="paragraph">
<p>The cluster resource needs to reference the kubeconfig secret.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">title="Cluster Resource Example"
apiVersion: fleet.cattle.io/v1alpha1
kind: Cluster
metadata:
  name: my-cluster
  namespace: clusters
  labels:
    demo: "true"
    env: dev
spec:
  kubeConfigSecret: my-cluster-kubeconfig</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="installation.html">Installation Details</a></span>
  <span class="next"><a href="cluster-group.html">Create Cluster Groups</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/vendor/lunr-languages.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
<script src="../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../_/js/vendor/tabs.js"></script>


  </body>
</html>
