<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cluster Registration Internals :: Rancher product documentation</title>
    <link rel="canonical" href="https://documentation.suse.com/cloudnative/continuous-delivery/v0.11/en/ref-registration.html">
    <link rel="prev" href="resources-list.html">
    <link rel="next" href="ref-configuration.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../_/css/vendor/light.css">
<!-- <script src="/docserv/res/lightheaded/analytics.js"
        type="text/javascript"></script> -->
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a class=" navbar-logo" href="https://documentation.suse.com/" aria-label="SUSE Documentation Home"><img class="logo"
            src="../../../_/img/logo.svg" alt="SUSE logo"/></a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">
            <img src="../../../_/img/resources.png" class="langIcon Resurces" alt="Resources" title="Resources">
          </div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/rancher/fleet-product-docs"><i class="fab fa-github"></i>&nbsp;Continuous Delivery</a>
            <div class="has-submenu">
              <a class="navbar-item" href="#" ><i class="fas fa-file-alt"></i>&nbsp;Report Issue &nbsp;<i class="fas fa-chevron-right"></i></a>
              <div class="submenu">
                <a class="navbar-item" href="https://scc.suse.com">SCC (Recommended)</a>
                <a class="navbar-item" href="https://github.com/rancher/fleet-product-docs/issues">GitHub Issue</a>
              </div>
            </div>
            <a class="navbar-item" href="https://github.com/rancher/product-docs-playbook/blob/main/CONTRIBUTING.md"><i class="fas fa-user-edit"></i>&nbsp;Contribute</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link"><img src="../../../_/img/language.png" class="langIcon Language" alt="Language"
              title="Language"></div>
          <div class="navbar-dropdown">
            <!--  </div><div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div> -->
              <a role="button" class="navbar-item" id="en" onclick="selectLanguage(this.id)">
                <!--<img src="../../../_/img/engFlag.svg" class="langIcon english">-->
                &nbsp;English
              </a>
            <!-- LANGUAGESELECTOR -->
          </div>
        </div>
        <!--
        <div class="navbar-item">
          <a href="https://twitter.com/SUSE">
            <img alt="X-logo" class="x-logo" src="../../../_/img/x-logo-white.png">
          </a>
        </div>
        -->
      </div>
    </div>

    <!--   <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
      </div> -->
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="continuous-delivery" data-version="v0.11">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="index.html">Continuous Delivery</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quickstart.html">Quickstart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="tut-deployment.html">Creating a Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="uninstall.html">Uninstall</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Explanations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="concepts.html">Core Concepts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-bundle-stages.html">Bundle Lifecycle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gitrepo-content.html">Git Repository Contents</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="namespaces.html">Namespaces</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resources-during-deployment.html">Custom Resources During Deployment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">How-tos for Operators</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="installation.html">Installation Details</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-registration.html">Register Downstream Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cluster-group.html">Create Cluster Groups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="multi-user.html">Setup Multi User</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">How-tos for Users</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gitrepo-add.html">Create a GitRepo Resource</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="gitrepo-targets.html">Mapping to Downstream Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bundle-diffs.html">Generating Diffs to Ignore Modified GitRepos</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="webhook.html">Using Webhooks Instead of Polling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="imagescan.html">Using Image Scan to Update Container Image References</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="bundle-add.html">Create a Bundle Resource</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">CLI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-agent/fleet-agent.html">fleet-agent</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-agent/fleet-agent_clusterstatus.html">fleet-agent clusterstatus</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-agent/fleet-agent_register.html">fleet-agent register</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet.html">fleet</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet_apply.html">fleet apply</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet_cleanup.html">fleet cleanup</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet_deploy.html">fleet deploy</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet_target.html">fleet target</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-cli/fleet_test.html">fleet test</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-controller/fleetcontroller.html">fleetcontroller</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-controller/fleetcontroller_agentmanagement.html">fleetcontroller agentmanagement</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cli/fleet-controller/fleetcontroller_cleanup.html">fleetcontroller cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-status-fields.html">Cluster and Bundle State</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="resources-list.html">Resources List</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="ref-registration.html">Cluster Registration Internals</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-configuration.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-resources.html">List of Deployed Resources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-crds.html">Custom Resources Spec</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-fleet-yaml.html">fleet.yaml</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-gitrepo.html">GitRepo Resource</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="ref-bundle.html">Bundle Resource</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="troubleshooting.html">Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Changelog</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="v0.11.1.html">v0.11.1</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Continuous Delivery</span>
    <span class="version">0.11</span>
  </div>
  <ul class="components">
        <li class="component">
          <div class="title"><a href="../../../cluster-api/v0.16/en/index.html">Cluster API</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../cluster-api/v0.16/en/index.html">0.16</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.15/en/index.html">0.15</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.11/en/index.html">0.11</a>
            </li>
          </ul>
        </li>
        <li class="component is-current">
          <div class="title"><a href="index.html">Continuous Delivery</a></div>
          <ul class="versions">
            <li class="version is-current is-latest">
              <a href="index.html">0.11</a>
            </li>
            <li class="version">
              <a href="../../v0.10/en/index.html">0.10</a>
            </li>
            <li class="version">
              <a href="../../v0.9/en/index.html">0.9</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../k3s/latest/en/introduction.html">K3s</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../k3s/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../os-manager/1.6/en/index.html">OS Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../os-manager/1.6/en/index.html">1.6</a>
            </li>
            <li class="version">
              <a href="../../../os-manager/1.5/en/index.html">1.5</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../policy-manager/1.22/en/introduction.html">Policy Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../policy-manager/1.22/en/introduction.html">1.22-next</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.21/en/introduction.html">1.21</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.20/en/introduction.html">1.20</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.19/en/introduction.html">1.19</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.18/en/introduction.html">1.18</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.17/en/introduction.html">1.17</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.16/en/introduction.html">1.16</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../rke2/latest/en/introduction.html">RKE2</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../rke2/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">SUSEÂ® Rancher Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.10/en/about-rancher/what-is-rancher.html">v2.10</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.9/en/about-rancher/what-is-rancher.html">v2.9</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.8/en/about-rancher/what-is-rancher.html">v2.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../security/5.4/en/overview.html">SUSEÂ® Security</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../security/5.4/en/overview.html">5.4</a>
            </li>
            <li class="version">
              <a href="../../../security/5.3/en/overview.html">5.3</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../storage/1.9.0/en/longhorn-documentation.html">SUSEÂ® Storage</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../storage/1.9.0/en/longhorn-documentation.html">1.9.0 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../storage/1.8.0/en/longhorn-documentation.html">1.8.0 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../storage/1.7.0/en/longhorn-documentation.html">1.7.0</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../virtualization/v1.5/en/introduction/overview.html">SUSEÂ® Virtualization</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../virtualization/v1.5/en/introduction/overview.html">v1.5 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../virtualization/v1.4/en/introduction/overview.html">v1.4 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../virtualization/v1.3/en/introduction/overview.html">v1.3</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html" aria-label="Home" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Continuous Delivery</a></li>
    <li>Reference</li>
    <li><a href="ref-registration.html">Cluster Registration Internals</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">0.11</button>
  <div class="version-menu">
    <a class="version is-current" href="ref-registration.html">0.11</a>
    <a class="version" href="../../v0.10/en/ref-registration.html">0.10</a>
    <a class="version" href="../../v0.9/en/ref-registration.html">0.9</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/rancher/fleet-product-docs/edit/main/versions/v0.11/modules/en/pages/ref-registration.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Cluster Registration Internals</h1>
<div class="sect1">
<h2 id="_how_does_cluster_registration_work"><a class="anchor" href="#_how_does_cluster_registration_work"></a>How does cluster registration work?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This text describes cluster registration with more technical details. The text ignores agent initiated registration, as it&#8217;s not commonly used.
<a href="cluster-registration.html#_agent_initiated" class="xref page">Agent initiated registration</a> is <a href="cluster-registration.html#_create_cluster_registration_tokens" class="xref page">"<code>ClusterRegistrationToken</code> first"</a>, which means pre-creating a cluster is optional.</p>
</div>
<div class="paragraph">
<p>See "<a href="cluster-registration.html" class="xref page">Register Downstream Clusters</a>" to learn how to register clusters.</p>
</div>
<div class="sect2">
<h3 id="_cluster_first"><a class="anchor" href="#_cluster_first"></a>Cluster first</h3>
<div class="paragraph">
<p><code>fleet-controller</code> starts up and may "bootstrap" the local cluster resource. In Rancher creating the local cluster resource is handled by the fleetcluster controller instead, but otherwise the process is identical.</p>
</div>
<div class="paragraph">
<p>The process is identical for the local cluster or any downstream cluster. It starts by  creating a cluster resource, which refers to a kubeconfig secret.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_the_bootstrap_secret_for_the_downstream_cluster"><a class="anchor" href="#_creating_the_bootstrap_secret_for_the_downstream_cluster"></a>Creating the Bootstrap Secret for the Downstream Cluster</h3>
<div class="paragraph">
<p>In this step a <code>ClusterRegistationToken</code> and an "import" service account are created based on a <code>Cluster</code> resource.</p>
</div>
<div class="paragraph">
<p>The SUSEÂ® Rancher Prime Continuous Delivery controller creates a <a href="https://fleet.rancher.io/architecture#security"><code>ClusterRegistrationToken</code></a>
and waits for it to be complete. The <code>ClusterRegistationToken</code> triggers the creation of the "import" service account, which can create
<code>ClusterRegistrations</code> and read any secret in the system registration namespace (eg "cattle-fleet-clusters-system"). The <code>import.go</code> controller will
enqueue itself until the "import" service account exists, because that account is needed to create the <code>fleet-agent-bootstrap</code> secret.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_the_suse_rancher_prime_continuous_delivery_agent_deployment"><a class="anchor" href="#_creating_the_suse_rancher_prime_continuous_delivery_agent_deployment"></a>Creating the SUSEÂ® Rancher Prime Continuous Delivery Agent Deployment</h3>
<div class="paragraph">
<p>The SUSEÂ® Rancher Prime Continuous Delivery controller will now create the SUSEÂ® Rancher Prime Continuous Delivery agent deployment and the bootstrap secret on the downstream cluster.</p>
</div>
<div class="paragraph">
<p>The bootstrap secret contains the API server URL of the upstream cluster and is used to build a kubeconfig to access the upstream cluster. Both values are taken from the SUSEÂ® Rancher Prime Continuous Delivery controller config configmap. That configmap is part of the helm chart.</p>
</div>
</div>
<div class="sect2">
<h3 id="_suse_rancher_prime_continuous_delivery_agent_starts_registration_upgrades_to_request_account"><a class="anchor" href="#_suse_rancher_prime_continuous_delivery_agent_starts_registration_upgrades_to_request_account"></a>SUSEÂ® Rancher Prime Continuous Delivery Agent Starts Registration, Upgrades to Request Account</h3>
<div class="paragraph">
<p>The agent uses the "import" account to upgrade to a request account.</p>
</div>
<div class="paragraph">
<p>Immediately the SUSEÂ® Rancher Prime Continuous Delivery agent checks for a <code>fleet-agent-bootstrap</code> secret. If the bootstrap secret, which contains the "import" kubeconfig, is present the agent starts registering.</p>
</div>
<div class="paragraph">
<p>Then agent creates the final <code>ClusterRegistration</code> resource in fleet-default on the management cluster, with a random number. The random number will be used for the registration secret&#8217;s name.</p>
</div>
<div class="paragraph">
<p>The SUSEÂ® Rancher Prime Continuous Delivery controller triggers and tries to grant the <code>ClusterRegistration</code> request to create agent&#8217;s service account and create the 'c-*' registration secret with the client&#8217;s new kubeconfig. The registration secret name is <code>hash("clientID-clientRandom")</code>.</p>
</div>
<div class="paragraph">
<p>The new kubeconfig uses the "request" account. The "request" account can access the cluster status, <code>BundleDeployments</code> and <code>Contents</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/FleetRegistrationToken.svg" alt="Static" width="600">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_suse_rancher_prime_continuous_delivery_agent_is_registered_watches_for_bundledeployments"><a class="anchor" href="#_suse_rancher_prime_continuous_delivery_agent_is_registered_watches_for_bundledeployments"></a>SUSEÂ® Rancher Prime Continuous Delivery Agent is Registered, Watches for <code>BundleDeployments</code></h3>
<div class="paragraph">
<p>At this point the agent is fully registered and will persist the "request" account into a <code>fleet-agent</code> secret.
The API server URL and CA are copied from the bootstrap secret, which inherited these values from the SUSEÂ® Rancher Prime Continuous Delivery controller&#8217;s helm chart values.</p>
</div>
<div class="paragraph">
<p>The bootstrap secret is deleted. When the agent restarts, it will not re-register, since the bootstrap secret is missing.</p>
</div>
<div class="paragraph">
<p>The agent starts watching its <a href="namespaces.html#_cluster_namespaces" class="xref page">Cluster Namespace</a>" for <code>BundleDeployments</code>. At this point the agent is ready to deploy workloads.</p>
</div>
</div>
<div class="sect2">
<h3 id="_notes"><a class="anchor" href="#_notes"></a>Notes</h3>
<div class="ulist">
<ul>
<li>
<p>The registration starts with the "import" account and pivots to the "request" account.</p>
</li>
<li>
<p>The fleet-default namespace has all the cluster registrations, the "import" account uses a separate namespace.</p>
</li>
<li>
<p>Once the agent is registered, <code>fleet-controller</code> will trigger on a cluster or namespace change. The <code>manageagent</code> controller will then create a bundle to adopt the existing agent deployment. The agent will update itself to the bundle and since the "generation" environment variable changes, it will restart.</p>
</li>
<li>
<p>If no bootstrap secret exists, the agent will not re-register.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_diagram"><a class="anchor" href="#_diagram"></a>Diagram</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_registration_process_and_controllers"><a class="anchor" href="#_registration_process_and_controllers"></a>Registration Process and Controllers</h3>
<div class="paragraph">
<p>Detailed analysis of the registration process for clusters. This shows the interaction of controllers, resources and service accounts during the registration of a new downstream cluster or the local cluster.</p>
</div>
<div class="paragraph">
<p>It is important to note that there are multiple ways to start this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creating a bootstrap config. SUSEÂ® Rancher Prime Continuous Delivery does this for the local agent.</p>
</li>
<li>
<p>Creating a <code>Cluster</code> resource with a kubeconfig. Rancher does this for downstream clusters. See <a href="cluster-registration.html#_manager_initiated" class="xref page">manager-initiated registration</a>.</p>
</li>
<li>
<p>Create a <code>ClusterRegistrationToken</code> resource, optionally create a <code>Cluster</code> resource for a pre-defined (<code>clientID</code>) cluster. See <a href="cluster-registration.html#_agent_initiated" class="xref page">agent-initiated registration</a>.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/FleetRegistration.svg" alt="Registration">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_secrets_during_agent_deployment"><a class="anchor" href="#_secrets_during_agent_deployment"></a>Secrets during Agent Deployment</h3>
<div class="paragraph">
<p>This diagram shows the resources created during registration and focuses on the k8s API server configuration.</p>
</div>
<div class="paragraph">
<p>The <code>import.go</code> controller triggers on Cluster creation/update events and deploys the agent.</p>
</div>
<div class="paragraph">
<p><strong>This image shows how the API server URL and CA propagates through the secrets during registration:</strong></p>
</div>
<div class="paragraph">
<p>The arrows in the diagram show how the API server values are copied from
the Helm values to the cluster registration secret on the upstream
cluster and finally downstream to the bootstrap secret of the agent.</p>
</div>
<div class="paragraph">
<p>There is one special case, if the agent is for the local/"bootstrap"
cluster, the server values also exist in the kubeconfig secret,
referenced by the Cluster resource. In this case the kubeconfig secret
contains the upstream server URL and CA, next to the downstream&#8217;s
kubeconfig. If the settings are present in the kubeconfig secret, they
override the configured values.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/FleetRegistrationSecrets.svg" alt="Registration Secrets">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_suse_rancher_prime_continuous_delivery_cluster_registration_in_rancher"><a class="anchor" href="#_suse_rancher_prime_continuous_delivery_cluster_registration_in_rancher"></a>SUSEÂ® Rancher Prime Continuous Delivery Cluster Registration in Rancher</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Rancher installs the fleet helm chart. The API server URL and CA are <a href="https://github.com/rancher/rancher/blob/release/v2.9/pkg/controllers/dashboard/fleetcharts/controller.go#L111-L112">derived from Rancher&#8217;s settings</a>.</p>
</div>
<div class="paragraph">
<p>SUSEÂ® Rancher Prime Continuous Delivery will pass these values to a SUSEÂ® Rancher Prime Continuous Delivery agent, so it can connect back to the SUSEÂ® Rancher Prime Continuous Delivery controller.</p>
</div>
<div class="sect2">
<h3 id="_import_cluster_into_rancher"><a class="anchor" href="#_import_cluster_into_rancher"></a>Import Cluster into Rancher</h3>
<div class="paragraph">
<p>When the user runs <code>curl | kubectl apply</code>, the applied manifest includes the rancher agent deployment.</p>
</div>
<div class="paragraph">
<p>The deployment contains a secret <code>cattle-credentials-</code> which contains the API URL and a token.</p>
</div>
<div class="paragraph">
<p>The Rancher agent starts up and reports downstream&#8217;s kubeconfig to upstream.</p>
</div>
<div class="paragraph">
<p>Rancher then creates the fleet Cluster resource, which references a <a href="https://github.com/rancher/rancher/blob/871b6d9137246bd93733f01184ea435f40c5d56c/pkg/provisioningv2/kubeconfig/manager.go#L69">kubeconfig secret</a>.</p>
</div>
<div class="paragraph">
<p>ðŸ‘‰SUSEÂ® Rancher Prime Continuous Delivery will use this kubeconfig to deploy the agent on the downstream cluster.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="resources-list.html">Resources List</a></span>
  <span class="next"><a href="ref-configuration.html">Configuration</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/vendor/lunr-languages.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
<script src="../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../_/js/vendor/tabs.js"></script>


  </body>
</html>
