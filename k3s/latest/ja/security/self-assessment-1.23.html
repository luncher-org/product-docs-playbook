<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CIS 1.23 自己評価ガイド :: Rancher product documentation</title>
    <link rel="canonical" href="https://documentation.suse.com/cloudnative/k3s/latest/ja/security/self-assessment-1.23.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../_/css/search.css">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../../_/css/vendor/light.css">
<!-- <script src="/docserv/res/lightheaded/analytics.js"
        type="text/javascript"></script> -->
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a class=" navbar-logo" href="https://documentation.suse.com/" aria-label="SUSE Documentation Home"><img class="logo"
            src="../../../../_/img/logo.svg" alt="SUSE logo"/></a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">
            <img src="../../../../_/img/resources.png" class="langIcon Resurces" alt="Resources" title="Resources">
          </div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/rancher/k3s-product-docs"><i class="fab fa-github"></i>&nbsp;K3s</a>
            <div class="has-submenu">
              <a class="navbar-item" href="#" ><i class="fas fa-file-alt"></i>&nbsp;Report Issue &nbsp;<i class="fas fa-chevron-right"></i></a>
              <div class="submenu">
                <a class="navbar-item" href="https://scc.suse.com">SCC (Recommended)</a>
                <a class="navbar-item" href="https://github.com/rancher/k3s-product-docs/issues">GitHub Issue</a>
              </div>
            </div>
            <a class="navbar-item" href="https://github.com/rancher/product-docs-playbook/blob/main/CONTRIBUTING.md"><i class="fas fa-user-edit"></i>&nbsp;Contribute</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link"><img src="../../../../_/img/language.png" class="langIcon Language" alt="Language"
              title="Language"></div>
          <div class="navbar-dropdown">
            <!--  </div><div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div> -->
              <a role="button" class="navbar-item" id="en" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/engFlag.svg" class="langIcon english">-->
                &nbsp;English
              </a>
              <a role="button" class="navbar-item" id="zh" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/china.svg" class="langIcon china">-->
                &nbsp;中文
              </a>
              <a role="button" class="navbar-item" id="ko" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/koFlag.svg" class="langIcon korea">-->
                &nbsp;한국어
              </a>
              <a role="button" class="navbar-item" id="ja" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/jaFlag.svg" class="langIcon japan">-->
                &nbsp;日本語
              </a>
            <!-- LANGUAGESELECTOR -->
          </div>
        </div>
        <!--
        <div class="navbar-item">
          <a href="https://twitter.com/SUSE">
            <img alt="X-logo" class="x-logo" src="../../../../_/img/x-logo-white.png">
          </a>
        </div>
        -->
      </div>
    </div>

    <!--   <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
      </div> -->
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="k3s" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../en/introduction.html">K3s</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction.html">K3s - 軽量なKubernetes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quick-start.html">クイックスタートガイド</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../installation/installation.html">インストール</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/requirements.html">要件</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/configuration.html">設定オプション</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/private-registry.html">プライベートレジストリの設定</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/registry-mirror.html">埋め込みレジストリミラー</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/airgap.html">エアギャップインストール</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/server-roles.html">サーバーロールの管理</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/packaged-components.html">パッケージ化されたコンポーネントの管理</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/uninstall.html">K3sのアンインストール</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../datastore/datastore.html">クラスタデータストア</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/backup-restore.html">バックアップとリストア</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/ha-embedded.html">高可用性組み込みetcd</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/ha.html">高可用性外部データベース</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/cluster-loadbalancer.html">クラスター・ロードバランサー</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../upgrades/upgrades.html">アップグレード</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrades/killall.html">K3sの停止</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrades/manual.html">手動アップグレード</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrades/automated.html">自動アップグレード</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="security.html">セキュリティ</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="secrets-encryption.html">secretの暗号化設定</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hardening-guide.html">CIS ハードニングガイド</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="self-assessment-1.8.html">CIS 1.8 セルフアセスメントガイド</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="self-assessment-1.7.html">CIS 1.7 セルフアセスメントガイド</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="self-assessment-1.24.html">CIS 1.24 自己評価ガイド</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../cli/cli.html">CLIツール</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/server.html">server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/agent.html">k3s エージェント</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/certificate.html">certificate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/etcd-snapshot.html">etcd-snapshot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/secrets-encrypt.html">secrets-encrypt</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/token.html">token</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture.html">アーキテクチャ</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../cluster-access.html">クラスターアクセス</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../storage.html">ボリュームとストレージ</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../networking/networking.html">ネットワーキング</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/basic-network-options.html">基本的なネットワークオプション</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/distributed-multicloud.html">分散型ハイブリッドまたはマルチクラウドクラスター</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/multus-ipams.html">Multus and IPAM plugins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/networking-services.html">ネットワーキングサービス</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../helm.html">Helm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../advanced.html">高度なオプション / 設定</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/env-variables.html">環境変数</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/flag-deprecation.html">フラグの非推奨化</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/resource-profiling.html">リソースプロファイリング</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Release Notes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.32.X.html">v1.32.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.31.X.html">v1.31.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.30.X.html">v1.30.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.29.X.html">v1.29.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.28.X.html">v1.28.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.27.X.html">v1.27.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.26.X.html">v1.26.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.25.X.html">v1.25.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.24.X.html">v1.24.X</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../related-projects.html">関連プロジェクト</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../known-issues.html">既知の問題</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../faq.html">FAQ</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">K3s</span>
    <span class="version">Latest</span>
  </div>
  <ul class="components">
        <li class="component">
          <div class="title"><a href="../../../../cluster-api/v0.16/en/index.html">Cluster API</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../cluster-api/v0.16/en/index.html">0.16</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.15/en/index.html">0.15</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.11/en/index.html">0.11</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../continuous-delivery/v0.11/en/index.html">Continuous Delivery</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../continuous-delivery/v0.11/en/index.html">0.11</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.10/en/index.html">0.10</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.9/en/index.html">0.9</a>
            </li>
          </ul>
        </li>
        <li class="component is-current">
          <div class="title"><a href="../../en/introduction.html">K3s</a></div>
          <ul class="versions">
            <li class="version is-current is-latest">
              <a href="../../en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../os-manager/1.6/en/index.html">OS Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../os-manager/1.6/en/index.html">1.6</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/1.5/en/index.html">1.5</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../policy-manager/1.22/en/introduction.html">Policy Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../policy-manager/1.22/en/introduction.html">1.22-next</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.21/en/introduction.html">1.21</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.20/en/introduction.html">1.20</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.19/en/introduction.html">1.19</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.18/en/introduction.html">1.18</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.17/en/introduction.html">1.17</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.16/en/introduction.html">1.16</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../rke2/latest/en/introduction.html">RKE2</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../rke2/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">SUSE® Rancher Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.10/en/about-rancher/what-is-rancher.html">v2.10</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.9/en/about-rancher/what-is-rancher.html">v2.9</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.8/en/about-rancher/what-is-rancher.html">v2.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../security/5.4/en/overview.html">SUSE® Security</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../security/5.4/en/overview.html">5.4</a>
            </li>
            <li class="version">
              <a href="../../../../security/5.3/en/overview.html">5.3</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../storage/1.9.0/en/longhorn-documentation.html">SUSE® Storage</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../storage/1.9.0/en/longhorn-documentation.html">1.9.0 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.8.0/en/longhorn-documentation.html">1.8.0 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.7.0/en/longhorn-documentation.html">1.7.0</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../virtualization/v1.5/en/introduction/overview.html">SUSE® Virtualization</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../virtualization/v1.5/en/introduction/overview.html">v1.5 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../virtualization/v1.4/en/introduction/overview.html">v1.4 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../virtualization/v1.3/en/introduction/overview.html">v1.3</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html" aria-label="Home" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../en/introduction.html">K3s</a></li>
    <li><a href="self-assessment-1.23.html">CIS 1.23 自己評価ガイド</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/rancher/k3s-product-docs/edit/main/versions/latest/modules/ja/pages/security/self-assessment-1.23.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">CIS 1.23 自己評価ガイド</h1>
<div class="sect1">
<h2 id="_概要"><a class="anchor" href="#_概要"></a>概要</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このドキュメントは<a href="hardening-guide.html" class="xref page">K3sセキュリティ強化ガイド</a>の補足資料です。強化ガイドはK3sの本番インストールを強化するための具体的な指針を提供し、このベンチマークガイドはCIS Kubernetesベンチマークの各コントロールに対して強化されたクラスターのセキュリティレベルを評価するのに役立ちます。K3sのオペレーター、セキュリティチーム、監査人、意思決定者が使用することを目的としています。</p>
</div>
<div class="paragraph">
<p>このガイドはK3sの<strong>v1.22-v1.23</strong>リリースラインおよびCIS Kubernetesベンチマークの<strong>v1.23</strong>リリースに特化しています。</p>
</div>
<div class="paragraph">
<p>各コントロールに関する詳細な説明やテスト失敗時の修正方法については、CIS Kubernetesベンチマークv1.6の該当セクションを参照してください。ベンチマークは<a href="https://www.cisecurity.org/benchmark/kubernetes/">Center for Internet Security (CIS)</a>で無料アカウントを作成後にダウンロードできます。</p>
</div>
<div class="sect2">
<h3 id="_コントロールテストの方法論"><a class="anchor" href="#_コントロールテストの方法論"></a>コントロールテストの方法論</h3>
<div class="paragraph">
<p>CIS Kubernetesベンチマークの各コントロールは、付随する強化ガイドに従って設定されたK3sクラスターに対して評価されました。</p>
</div>
<div class="paragraph">
<p>コントロール監査が元のCISベンチマークと異なる場合、K3sに特化した監査コマンドがテスト用に提供されます。</p>
</div>
<div class="paragraph">
<p>各コントロールの結果は以下の通りです：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>合格</strong> - テスト対象のK3sクラスターがベンチマークに記載された監査に合格しました。</p>
</li>
<li>
<p><strong>該当なし</strong> - コントロールはK3sの設計上適用されません。修正セクションでその理由を説明します。</p>
</li>
<li>
<p><strong>警告</strong> - コントロールはCISベンチマークで手動とされており、クラスターの使用ケースやその他の要因に依存します。これらのコントロールはK3sがその実装を妨げないことを確認するために評価されていますが、テスト対象のクラスターのさらなる設定や監査は行われていません。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>このガイドは、K3sがSystemdユニットとして実行されていることを前提としています。インストール方法が異なる場合は、「監査」コマンドをシナリオに合わせて調整する必要があります。</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>注意: このガイドでは<code>自動化された</code>テスト（以前は<code>スコア付き</code>と呼ばれていたもの）のみを対象としています。</p>
</div>
</blockquote>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_1_1_コントロールプレーンノードの設定ファイル"><a class="anchor" href="#_1_1_コントロールプレーンノードの設定ファイル"></a>1.1 コントロールプレーンノードの設定ファイル</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_1_1_apiサーバーポッド仕様ファイルの権限が644以上に設定されていることを確認する自動化"><a class="anchor" href="#_1_1_1_apiサーバーポッド仕様ファイルの権限が644以上に設定されていることを確認する自動化"></a>1.1.1 APIサーバーポッド仕様ファイルの権限が644以上に設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：<code>chmod 644 /etc/kubernetes/manifests/kube-apiserver.yaml</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_2_apiサーバーポッド仕様ファイルの所有者がrootrootに設定されていることを確認する自動化"><a class="anchor" href="#_1_1_2_apiサーバーポッド仕様ファイルの所有者がrootrootに設定されていることを確認する自動化"></a>1.1.2 APIサーバーポッド仕様ファイルの所有者がroot:rootに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：<code>chown root:root /etc/kubernetes/manifests/kube-apiserver.yaml</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_3_コントローラーマネージャーポッド仕様ファイルの権限が644以上に設定されていることを確認する自動化"><a class="anchor" href="#_1_1_3_コントローラーマネージャーポッド仕様ファイルの権限が644以上に設定されていることを確認する自動化"></a>1.1.3 コントローラーマネージャーポッド仕様ファイルの権限が644以上に設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：<code>chmod 644 /etc/kubernetes/manifests/kube-controller-manager.yaml</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_4_コントローラーマネージャーポッド仕様ファイルの所有者がrootrootに設定されていることを確認する自動化"><a class="anchor" href="#_1_1_4_コントローラーマネージャーポッド仕様ファイルの所有者がrootrootに設定されていることを確認する自動化"></a>1.1.4 コントローラーマネージャーポッド仕様ファイルの所有者がroot:rootに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：<code>chown root:root /etc/kubernetes/manifests/kube-controller-manager.yaml</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_5_スケジューラーポッド仕様ファイルの権限が644以上に設定されていることを確認する自動化"><a class="anchor" href="#_1_1_5_スケジューラーポッド仕様ファイルの権限が644以上に設定されていることを確認する自動化"></a>1.1.5 スケジューラーポッド仕様ファイルの権限が644以上に設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：<code>chmod 644 /etc/kubernetes/manifests/kube-scheduler.yaml</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_6_スケジューラーポッド仕様ファイルの所有者がrootrootに設定されていることを確認する自動化"><a class="anchor" href="#_1_1_6_スケジューラーポッド仕様ファイルの所有者がrootrootに設定されていることを確認する自動化"></a>1.1.6 スケジューラーポッド仕様ファイルの所有者がroot:rootに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：<code>chown root:root /etc/kubernetes/manifests/kube-scheduler.yaml</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_7_etcdポッド仕様ファイルの権限が644以上に設定されていることを確認する自動化"><a class="anchor" href="#_1_1_7_etcdポッド仕様ファイルの権限が644以上に設定されていることを確認する自動化"></a>1.1.7 etcdポッド仕様ファイルの権限が644以上に設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：<code>chmod 644 /etc/kubernetes/manifests/etcd.yaml</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_8_etcdポッド仕様ファイルの所有者がrootrootに設定されていることを確認する自動化"><a class="anchor" href="#_1_1_8_etcdポッド仕様ファイルの所有者がrootrootに設定されていることを確認する自動化"></a>1.1.8 etcdポッド仕様ファイルの所有者がroot:rootに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：<code>chown root:root /etc/kubernetes/manifests/etcd.yaml</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_9_コンテナネットワークインターフェースファイルの権限が644以上に設定されていることを確認する手動"><a class="anchor" href="#_1_1_9_コンテナネットワークインターフェースファイルの権限が644以上に設定されていることを確認する手動"></a>1.1.9 コンテナネットワークインターフェースファイルの権限が644以上に設定されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：<code>chmod 644 &lt;path/to/cni/files&gt;</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_10_コンテナネットワークインターフェースファイルの所有者がrootrootに設定されていることを確認する手動"><a class="anchor" href="#_1_1_10_コンテナネットワークインターフェースファイルの所有者がrootrootに設定されていることを確認する手動"></a>1.1.10 コンテナネットワークインターフェースファイルの所有者がroot:rootに設定されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：<code>chown root:root &lt;path/to/cni/files&gt;</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_11_etcdデータディレクトリの権限が700以上に設定されていることを確認する自動化"><a class="anchor" href="#_1_1_11_etcdデータディレクトリの権限が700以上に設定されていることを確認する自動化"></a>1.1.11 etcdデータディレクトリの権限が700以上に設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
etcdサーバーノードで、コマンド&#8217;ps -ef | grep etcd&#8217;から引数&#8212;&#8203;data-dirとして渡されるetcdデータディレクトリを取得します。
以下のコマンドを実行します（上記で見つかったetcdデータディレクトリに基づく）。例：chmod 700 /var/lib/etcd</p>
</div>
<div class="paragraph">
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

# このスクリプトは、k3sが実際にetcdを実行していること（sqlite3などの他のデータベースではないこと）を確認してから要件をチェックします
set -eE

handle_error() {
    echo "false"
}

trap 'handle_error' ERR

if [[ "$(journalctl -D /var/log/journal -u k3s | grep 'Managed etcd cluster initializing' | grep -v grep | wc -l)" -gt 0 ]]; then
    case $1 in
        "1.1.11")
            echo $(stat -c %a /var/lib/rancher/k3s/server/db/etcd);;
        "1.2.29")
            echo $(journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'etcd-');;
        "2.1")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.2")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.3")
            echo $(grep 'auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.4")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.5")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.6")
            echo $(grep 'peer-auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.7")
            echo $(grep 'trusted-ca-file' /var/lib/rancher/k3s/server/db/etcd/config);;
    esac
else
# 別のデータベースが実行されている場合、スキャンに合格するために必要なものを返します
    case $1 in
        "1.1.11")
            echo "700";;
        "1.2.29")
            echo "--etcd-certfile AND --etcd-keyfile";;
        "2.1")
            echo "cert-file AND key-file";;
        "2.2")
            echo "--client-cert-auth=true";;
        "2.3")
            echo "false";;
        "2.4")
            echo "peer-cert-file AND peer-key-file";;
        "2.5")
            echo "--client-cert-auth=true";;
        "2.6")
            echo "--peer-auto-tls=false";;
        "2.7")
            echo "--trusted-ca-file";;
    esac
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査実行:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./check_for_k3s_etcd.sh 1.1.11</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'700' は '700' と等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">700</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_12_etcdデータディレクトリの所有者がetcdetcdに設定されていることを確認する自動化"><a class="anchor" href="#_1_1_12_etcdデータディレクトリの所有者がetcdetcdに設定されていることを確認する自動化"></a>1.1.12 etcdデータディレクトリの所有者がetcd:etcdに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
etcdサーバーノードで、コマンド&#8217;ps -ef | grep etcd&#8217;から引数&#8212;&#8203;data-dirとして渡されるetcdデータディレクトリを取得します。
以下のコマンドを実行します（上記で見つかったetcdデータディレクトリに基づく）。
例：chown etcd:etcd /var/lib/etcd</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_13_admin_confファイルの権限が600以上に設定されていることを確認する自動化"><a class="anchor" href="#_1_1_13_admin_confファイルの権限が600以上に設定されていることを確認する自動化"></a>1.1.13 admin.confファイルの権限が600以上に設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：chmod 600 /var/lib/rancher/k3s/server/cred/admin.kubeconfig</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_14_admin_confファイルの所有者がrootrootに設定されていることを確認する自動化"><a class="anchor" href="#_1_1_14_admin_confファイルの所有者がrootrootに設定されていることを確認する自動化"></a>1.1.14 admin.confファイルの所有者がroot:rootに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：chown root:root /etc/kubernetes/admin.conf</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/sh -c 'if test -e /var/lib/rancher/k3s/server/cred/admin.kubeconfig; then stat -c %U:%G /var/lib/rancher/k3s/server/cred/admin.kubeconfig; fi'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'root:root' は 'root:root' と等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">root:root</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_15_scheduler_confファイルの権限が644以上に設定されていることを確認する自動化"><a class="anchor" href="#_1_1_15_scheduler_confファイルの権限が644以上に設定されていることを確認する自動化"></a>1.1.15 scheduler.confファイルの権限が644以上に設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例：chmod 644 scheduler</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/sh -c 'if test -e /var/lib/rancher/k3s/server/cred/scheduler.kubeconfig; then stat -c permissions=%a /var/lib/rancher/k3s/server/cred/scheduler.kubeconfig; fi'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">permissionsは644の権限を持ち、期待される権限は644以上</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">permissions=644</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_16_scheduler_confファイルの所有者がrootrootに設定されていることを確認する自動化"><a class="anchor" href="#_1_1_16_scheduler_confファイルの所有者がrootrootに設定されていることを確認する自動化"></a>1.1.16 scheduler.confファイルの所有者がroot:rootに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例えば、<code>chown root:root scheduler</code></p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/sh -c 'if test -e /var/lib/rancher/k3s/server/cred/scheduler.kubeconfig; then stat -c %U:%G /var/lib/rancher/k3s/server/cred/scheduler.kubeconfig; fi'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'root:root' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">root:root</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_17_コントローラーマネージャー_confファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化"><a class="anchor" href="#_1_1_17_コントローラーマネージャー_confファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化"></a>1.1.17 コントローラーマネージャー.confファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例えば、
chmod 644 controllermanager</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/sh -c 'if test -e /var/lib/rancher/k3s/server/cred/controller.kubeconfig; then stat -c permissions=%a /var/lib/rancher/k3s/server/cred/controller.kubeconfig; fi'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">permissions が644のパーミッションを持ち、期待されるパーミッションは644またはそれ以上に制限されている</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">permissions=644</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_18_コントローラーマネージャー_confファイルの所有者がrootrootに設定されていることを確認する自動化"><a class="anchor" href="#_1_1_18_コントローラーマネージャー_confファイルの所有者がrootrootに設定されていることを確認する自動化"></a>1.1.18 コントローラーマネージャー.confファイルの所有者がroot:rootに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例えば、
chown root:root controllermanager</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stat -c %U:%G /var/lib/rancher/k3s/server/tls</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'root:root' が 'root:root' と等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">root:root</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_19_kubernetes_pkiディレクトリおよびファイルの所有者がrootrootに設定されていることを確認する自動化"><a class="anchor" href="#_1_1_19_kubernetes_pkiディレクトリおよびファイルの所有者がrootrootに設定されていることを確認する自動化"></a>1.1.19 Kubernetes PKIディレクトリおよびファイルの所有者がroot:rootに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例えば、
chown -R root:root /etc/kubernetes/pki/</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">find /var/lib/rancher/k3s/server/tls | xargs stat -c %U:%G</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'root:root' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root root:root</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_20_kubernetes_pki証明書ファイルのパーミッションが644またはそれ以上に制限されていることを確認する手動"><a class="anchor" href="#_1_1_20_kubernetes_pki証明書ファイルのパーミッションが644またはそれ以上に制限されていることを確認する手動"></a>1.1.20 Kubernetes PKI証明書ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例えば、
chmod -R 644 /etc/kubernetes/pki/*.crt</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stat -c %n %a /var/lib/rancher/k3s/server/tls/*.crt</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_1_21_kubernetes_pkiキーのファイルパーミッションが600に設定されていることを確認する手動"><a class="anchor" href="#_1_1_21_kubernetes_pkiキーのファイルパーミッションが600に設定されていることを確認する手動"></a>1.1.21 Kubernetes PKIキーのファイルパーミッションが600に設定されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例えば、
chmod -R 600 /etc/kubernetes/pki/*.key</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stat -c %n %a /var/lib/rancher/k3s/server/tls/*.key</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_1_2_apiサーバー"><a class="anchor" href="#_1_2_apiサーバー"></a>1.2 APIサーバー</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_2_1_anonymous_auth引数がfalseに設定されていることを確認する手動"><a class="anchor" href="#_1_2_1_anonymous_auth引数がfalseに設定されていることを確認する手動"></a>1.2.1 --anonymous-auth引数がfalseに設定されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、以下のパラメータを設定します。
--anonymous-auth=false</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'anonymous-auth'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_2_token_auth_fileパラメータが設定されていないことを確認する自動化"><a class="anchor" href="#_1_2_2_token_auth_fileパラメータが設定されていないことを確認する自動化"></a>1.2.2 --token-auth-fileパラメータが設定されていないことを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ドキュメントに従って認証のための代替メカニズムを構成します。その後、コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、<code>--token-auth-file=&lt;filename&gt;</code> パラメータを削除します。</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/ps -ef | grep containerd | grep -v grep</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--token-auth-file' が存在しない</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">root 1616 1600 6 13:26 ? 00:01:28 containerd -c /var/lib/rancher/k3s/agent/etc/containerd/config.toml -a /run/k3s/containerd/containerd.sock --state /run/k3s/containerd --root /var/lib/rancher/k3s/agent/containerd root 2318 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id b41ec3297be4625c2406ad8b7b4f8b91cddd60850c420050c4c3273f809b3e7e -address /run/k3s/containerd/containerd.sock root 2341 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id e7999a65ae0a4e9969f32317ec48ae4f7071b62f92e5236696737973be77c2e1 -address /run/k3s/containerd/containerd.sock root 3199 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 90c4e63d6ee29d40a48c2fdaf2738c2472cba1139dde8a550466c452184f8528 -address /run/k3s/containerd/containerd.sock root 3923 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id be5f4b9bd1ed9239362b7000b47f353acb8bc8ca52a9c9145cba0e902ec1c4b9 -address /run/k3s/containerd/containerd.sock root 4559 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 04cd40ea6b6078797f177c902c89412c70e523ad2a687a62829bf1d16ff0e19c -address /run/k3s/containerd/containerd.sock root 4647 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 48f37a480315b6adce2d2a5c5d67a85412dd0ba7a2e82816434e0deb9fa75de9 -address /run/k3s/containerd/containerd.sock root 6610 1 0 13:47 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1cf71c22f568468055e517ab363437c0e54e45274c64024d337cc5bcce66341d -address /run/k3s/containerd/containerd.sock</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_3_denyserviceexternalipsが設定されていないことを確認する自動化"><a class="anchor" href="#_1_2_3_denyserviceexternalipsが設定されていないことを確認する自動化"></a>1.2.3 --DenyServiceExternalIPsが設定されていないことを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、<code>DenyServiceExternalIPs</code> を有効なアドミッションプラグインから削除します。</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/ps -ef | grep containerd | grep -v grep</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--enable-admission-plugins' が存在する または '--enable-admission-plugins' が存在しない</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">root 1616 1600 6 13:26 ? 00:01:28 containerd -c /var/lib/rancher/k3s/agent/etc/containerd/config.toml -a /run/k3s/containerd/containerd.sock --state /run/k3s/containerd --root /var/lib/rancher/k3s/agent/containerd root 2318 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id b41ec3297be4625c2406ad8b7b4f8b91cddd60850c420050c4c3273f809b3e7e -address /run/k3s/containerd/containerd.sock root 2341 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id e7999a65ae0a4e9969f32317ec48ae4f7071b62f92e5236696737973be77c2e1 -address /run/k3s/containerd/containerd.sock root 3199 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 90c4e63d6ee29d40a48c2fdaf2738c2472cba1139dde8a550466c452184f8528 -address /run/k3s/containerd/containerd.sock root 3923 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id be5f4b9bd1ed9239362b7000b47f353acb8bc8ca52a9c9145cba0e902ec1c4b9 -address /run/k3s/containerd/containerd.sock root 4559 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 04cd40ea6b6078797f177c902c89412c70e523ad2a687a62829bf1d16ff0e19c -address /run/k3s/containerd/containerd.sock root 4647 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 48f37a480315b6adce2d2a5c5d67a85412dd0ba7a2e82816434e0deb9fa75de9 -address /run/k3s/containerd/containerd.sock root 6610 1 0 13:47 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1cf71c22f568468055e517ab363437c0e54e45274c64024d337cc5bcce66341d -address /run/k3s/containerd/containerd.sock</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_4_kubelet_https引数がtrueに設定されていることを確認する自動化"><a class="anchor" href="#_1_2_4_kubelet_https引数がtrueに設定されていることを確認する自動化"></a>1.2.4 --kubelet-https引数がtrueに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--kubelet-httpsパラメータを削除します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_5_kubelet_client_certificateおよびkubelet_client_key引数が適切に設定されていることを確認する自動化"><a class="anchor" href="#_1_2_5_kubelet_client_certificateおよびkubelet_client_key引数が適切に設定されていることを確認する自動化"></a>1.2.5 --kubelet-client-certificateおよび&#8212;&#8203;kubelet-client-key引数が適切に設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従って、apiserverとkubelets間のTLS接続を設定します。その後、コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、以下のようにkubeletクライアント証明書とキーのパラメータを設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>--kubelet-client-certificate=&lt;path/to/client-certificate-file&gt;
--kubelet-client-key=&lt;path/to/client-key-file&gt;</pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'kubelet-certificate-authority'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--kubelet-client-certificate' が存在し、'--kubelet-client-key' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_6_ensure_that_the_kubelet_certificate_authority_argument_is_set_as_appropriate_automated"><a class="anchor" href="#_1_2_6_ensure_that_the_kubelet_certificate_authority_argument_is_set_as_appropriate_automated"></a>1.2.6 Ensure that the --kubelet-certificate-authority argument is set as appropriate (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Follow the Kubernetes documentation and setup the TLS connection between
the apiserver and kubelets. Then, edit the API server pod specification file
/etc/kubernetes/manifests/kube-apiserver.yaml on the control plane node and set the
--kubelet-certificate-authority parameter to the path to the cert file for the certificate authority
<code>--kubelet-certificate-authority=&lt;ca-string&gt;</code>.</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'kubelet-certificate-authority'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--kubelet-certificate-authority' is present</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_7_ensure_that_the_authorization_mode_argument_is_not_set_to_alwaysallow_automated"><a class="anchor" href="#_1_2_7_ensure_that_the_authorization_mode_argument_is_not_set_to_alwaysallow_automated"></a>1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml
on the control plane node and set the --authorization-mode parameter to values other than AlwaysAllow.
One such example could be as below.
--authorization-mode=RBAC</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'authorization-mode'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--authorization-mode' does not have 'AlwaysAllow'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_8_ensure_that_the_authorization_mode_argument_includes_node_automated"><a class="anchor" href="#_1_2_8_ensure_that_the_authorization_mode_argument_includes_node_automated"></a>1.2.8 Ensure that the --authorization-mode argument includes Node (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml
on the control plane node and set the --authorization-mode parameter to a value that includes Node.
--authorization-mode=Node,RBAC</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'authorization-mode'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--authorization-mode' has 'Node'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_6_ensure_that_the_kubelet_certificate_authority_argument_is_set_as_appropriate_automated_2"><a class="anchor" href="#_1_2_6_ensure_that_the_kubelet_certificate_authority_argument_is_set_as_appropriate_automated_2"></a>1.2.6 Ensure that the --kubelet-certificate-authority argument is set as appropriate (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Follow the Kubernetes documentation and setup the TLS connection between
the apiserver and kubelets. Then, edit the API server pod specification file
/etc/kubernetes/manifests/kube-apiserver.yaml on the control plane node and set the
--kubelet-certificate-authority parameter to the path to the cert file for the certificate authority
<code>--kubelet-certificate-authority=&lt;ca-string&gt;</code>.</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'kubelet-certificate-authority'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--kubelet-certificate-authority' is present</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_7_ensure_that_the_authorization_mode_argument_is_not_set_to_alwaysallow_automated_2"><a class="anchor" href="#_1_2_7_ensure_that_the_authorization_mode_argument_is_not_set_to_alwaysallow_automated_2"></a>1.2.7 Ensure that the --authorization-mode argument is not set to AlwaysAllow (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml
on the control plane node and set the --authorization-mode parameter to values other than AlwaysAllow.
One such example could be as below.
--authorization-mode=RBAC</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'authorization-mode'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--authorization-mode' does not have 'AlwaysAllow'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_9_ensure_that_the_authorization_mode_argument_includes_rbac_automated"><a class="anchor" href="#_1_2_9_ensure_that_the_authorization_mode_argument_includes_rbac_automated"></a>1.2.9 Ensure that the --authorization-mode argument includes RBAC (Automated)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--authorization-mode パラメータをRBACを含む値に設定します。例えば <code>--authorization-mode=Node,RBAC</code>。</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'authorization-mode'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--authorization-mode' に 'RBAC' が含まれている</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_10_ensure_that_the_admission_control_plugin_eventratelimit_is_set_manual"><a class="anchor" href="#_1_2_10_ensure_that_the_admission_control_plugin_eventratelimit_is_set_manual"></a>1.2.10 Ensure that the admission control plugin EventRateLimit is set (Manual)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、設定ファイルに希望する制限を設定します。その後、APIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、以下のパラメータを設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">--enable-admission-plugins=...,EventRateLimit,...
--admission-control-config-file=&lt;path/to/configuration/file&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'enable-admission-plugins'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--enable-admission-plugins' に 'EventRateLimit' が含まれている</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_11_ensure_that_the_admission_control_plugin_alwaysadmit_is_not_set_automated"><a class="anchor" href="#_1_2_11_ensure_that_the_admission_control_plugin_alwaysadmit_is_not_set_automated"></a>1.2.11 Ensure that the admission control plugin AlwaysAdmit is not set (Automated)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--enable-admission-plugins パラメータを削除するか、AlwaysAdmitを含まない値に設定します。</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'enable-admission-plugins'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--enable-admission-plugins' に 'AlwaysAdmit' が含まれていない または '--enable-admission-plugins' が存在しない</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_12_ensure_that_the_admission_control_plugin_alwayspullimages_is_set_manual"><a class="anchor" href="#_1_2_12_ensure_that_the_admission_control_plugin_alwayspullimages_is_set_manual"></a>1.2.12 Ensure that the admission control plugin AlwaysPullImages is set (Manual)</h3>
<div class="paragraph">
<p><strong>Result:</strong> warn</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
APIサーバーポッドの仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml をコントロールプレーンノードで編集し、--enable-admission-plugins パラメータに AlwaysPullImages を含めるように設定します。
--enable-admission-plugins=&#8230;&#8203;,AlwaysPullImages,&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/ps -ef | grep containerd | grep -v grep</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--enable-admission-plugins' is present</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">root 1616 1600 6 13:26 ? 00:01:28 containerd -c /var/lib/rancher/k3s/agent/etc/containerd/config.toml -a /run/k3s/containerd/containerd.sock --state /run/k3s/containerd --root /var/lib/rancher/k3s/agent/containerd root 2318 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id b41ec3297be4625c2406ad8b7b4f8b91cddd60850c420050c4c3273f809b3e7e -address /run/k3s/containerd/containerd.sock root 2341 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id e7999a65ae0a4e9969f32317ec48ae4f7071b62f92e5236696737973be77c2e1 -address /run/k3s/containerd/containerd.sock root 3199 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 90c4e63d6ee29d40a48c2fdaf2738c2472cba1139dde8a550466c452184f8528 -address /run/k3s/containerd/containerd.sock root 3923 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id be5f4b9bd1ed9239362b7000b47f353acb8bc8ca52a9c9145cba0e902ec1c4b9 -address /run/k3s/containerd/containerd.sock root 4559 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 04cd40ea6b6078797f177c902c89412c70e523ad2a687a62829bf1d16ff0e19c -address /run/k3s/containerd/containerd.sock root 4647 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 48f37a480315b6adce2d2a5c5d67a85412dd0ba7a2e82816434e0deb9fa75de9 -address /run/k3s/containerd/containerd.sock root 6610 1 0 13:47 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1cf71c22f568468055e517ab363437c0e54e45274c64024d337cc5bcce66341d -address /run/k3s/containerd/containerd.sock</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_13_ensure_that_the_admission_control_plugin_securitycontextdeny_is_set_if_podsecuritypolicy_is_not_used_manual"><a class="anchor" href="#_1_2_13_ensure_that_the_admission_control_plugin_securitycontextdeny_is_set_if_podsecuritypolicy_is_not_used_manual"></a>1.2.13 Ensure that the admission control plugin SecurityContextDeny is set if PodSecurityPolicy is not used (Manual)</h3>
<div class="paragraph">
<p><strong>Result:</strong> warn</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
APIサーバーポッドの仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml をコントロールプレーンノードで編集し、--enable-admission-plugins パラメータに SecurityContextDeny を含めるように設定します。ただし、PodSecurityPolicy が既に設定されている場合は除きます。
--enable-admission-plugins=&#8230;&#8203;,SecurityContextDeny,&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'enable-admission-plugins'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--enable-admission-plugins' has 'SecurityContextDeny' OR '--enable-admission-plugins' has 'PodSecurityPolicy'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_14_ensure_that_the_admission_control_plugin_serviceaccount_is_set_automated"><a class="anchor" href="#_1_2_14_ensure_that_the_admission_control_plugin_serviceaccount_is_set_automated"></a>1.2.14 Ensure that the admission control plugin ServiceAccount is set (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
ドキュメントに従い、環境に応じて ServiceAccount オブジェクトを作成します。その後、APIサーバーポッドの仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml をコントロールプレーンノードで編集し、--disable-admission-plugins パラメータが ServiceAccount を含まない値に設定されていることを確認します。</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep -v grep</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--disable-admission-plugins' is present OR '--disable-admission-plugins' is not present</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_15_namespacelifecycle_アドミッションコントロールプラグインが設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_15_namespacelifecycle_アドミッションコントロールプラグインが設定されていることを確認する_自動化"></a>1.2.15 NamespaceLifecycle アドミッションコントロールプラグインが設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードの API サーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--disable-admission-plugins パラメータを設定して NamespaceLifecycle が含まれていないことを確認します。</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep -v grep</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--disable-admission-plugins' が存在するか '--disable-admission-plugins' が存在しない</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_16_noderestriction_アドミッションコントロールプラグインが設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_16_noderestriction_アドミッションコントロールプラグインが設定されていることを確認する_自動化"></a>1.2.16 NodeRestriction アドミッションコントロールプラグインが設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetes のドキュメントに従い、kubelet に NodeRestriction プラグインを設定します。その後、コントロールプレーンノードの API サーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--enable-admission-plugins パラメータに NodeRestriction を含む値を設定します。
--enable-admission-plugins=&#8230;&#8203;,NodeRestriction,&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'enable-admission-plugins'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--enable-admission-plugins' に 'NodeRestriction' が含まれている</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_17_secure_port_引数が_0_に設定されていないことを確認する_自動化"><a class="anchor" href="#_1_2_17_secure_port_引数が_0_に設定されていないことを確認する_自動化"></a>1.2.17 --secure-port 引数が 0 に設定されていないことを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードの API サーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、--secure-port パラメータを削除するか、0 以外の異なるポートに設定します。</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'secure-port'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--secure-port' が 0 より大きいか '--secure-port' が存在しない</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_18_profiling_引数が_false_に設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_18_profiling_引数が_false_に設定されていることを確認する_自動化"></a>1.2.18 --profiling 引数が false に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、以下のパラメータを設定します。
--profiling=false</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'profiling'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--profiling' が 'false' に等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_19_audit_log_path_引数が設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_19_audit_log_path_引数が設定されていることを確認する_自動化"></a>1.2.19 --audit-log-path 引数が設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、--audit-log-path パラメータを適切なパスとファイルに設定します。例えば、
--audit-log-path=/var/log/apiserver/audit.log</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_20_audit_log_maxage_引数が_30_または適切な値に設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_20_audit_log_maxage_引数が_30_または適切な値に設定されていることを確認する_自動化"></a>1.2.20 --audit-log-maxage 引数が 30 または適切な値に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、--audit-log-maxage パラメータを 30 または適切な日数に設定します。例えば、
--audit-log-maxage=30</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_21_audit_log_maxbackup_引数が_10_または適切な値に設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_21_audit_log_maxbackup_引数が_10_または適切な値に設定されていることを確認する_自動化"></a>1.2.21 --audit-log-maxbackup 引数が 10 または適切な値に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、--audit-log-maxbackup パラメータを 10 または適切な値に設定します。例えば、
--audit-log-maxbackup=10</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_22_audit_log_maxsize_引数が_100_または適切な値に設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_22_audit_log_maxsize_引数が_100_または適切な値に設定されていることを確認する_自動化"></a>1.2.22 --audit-log-maxsize 引数が 100 または適切な値に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、--audit-log-maxsize パラメータを適切なサイズ（MB単位）に設定します。例えば、100 MB に設定する場合、
--audit-log-maxsize=100</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_24_service_account_lookup_引数が_true_に設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_24_service_account_lookup_引数が_true_に設定されていることを確認する_自動化"></a>1.2.24 --service-account-lookup 引数が true に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、以下のパラメータを設定します。
--service-account-lookup=true
または、このファイルから --service-account-lookup パラメータを削除してデフォルトを有効にします。</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep -v grep</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--service-account-lookup' が存在しない、または '--service-account-lookup' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_25_request_timeout_引数が適切に設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_25_request_timeout_引数が適切に設定されていることを確認する_自動化"></a>1.2.25 --request-timeout 引数が適切に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、--service-account-key-file パラメータをサービスアカウントの公開鍵ファイルに設定します。例えば、
<code>--service-account-key-file=&lt;filename&gt;</code>。</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_26_etcd_certfile_および_etcd_keyfile_引数が適切に設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_26_etcd_certfile_および_etcd_keyfile_引数が適切に設定されていることを確認する_自動化"></a>1.2.26 --etcd-certfile および --etcd-keyfile 引数が適切に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetes のドキュメントに従って、apiserver と etcd 間の TLS 接続を設定します。その後、コントロールプレーンノードの /etc/kubernetes/manifests/kube-apiserver.yaml ファイルを編集し、etcd 証明書および鍵ファイルのパラメータを設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>--etcd-certfile=&lt;path/to/client-certificate-file&gt;
--etcd-keyfile=&lt;path/to/client-key-file&gt;</pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

# このスクリプトは、k3sが実際にetcdを実行していること（sqlite3などの他のデータベースではないこと）を確認するために使用されます。
# 要件を確認する前に
set -eE

handle_error() {
    echo "false"
}

trap 'handle_error' ERR


if [[ "$(journalctl -D /var/log/journal -u k3s | grep 'Managed etcd cluster initializing' | grep -v grep | wc -l)" -gt 0 ]]; then
    case $1 in
        "1.1.11")
            echo $(stat -c %a /var/lib/rancher/k3s/server/db/etcd);;
        "1.2.29")
            echo $(journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'etcd-');;
        "2.1")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.2")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.3")
            echo $(grep 'auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.4")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.5")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.6")
            echo $(grep 'peer-auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.7")
            echo $(grep 'trusted-ca-file' /var/lib/rancher/k3s/server/db/etcd/config);;
    esac
else
# 別のデータベースが実行されている場合、スキャンを通過するために必要なものを返します
    case $1 in
        "1.1.11")
            echo "700";;
        "1.2.29")
            echo "--etcd-certfile AND --etcd-keyfile";;
        "2.1")
            echo "cert-file AND key-file";;
        "2.2")
            echo "--client-cert-auth=true";;
        "2.3")
            echo "false";;
        "2.4")
            echo "peer-cert-file AND peer-key-file";;
        "2.5")
            echo "--client-cert-auth=true";;
        "2.6")
            echo "--peer-auto-tls=false";;
        "2.7")
            echo "--trusted-ca-file";;
    esac
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査実行:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./check_for_k3s_etcd.sh 1.2.29</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--etcd-certfile' が存在し、'--etcd-keyfile' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">--etcd-certfile AND --etcd-keyfile</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_27_tls_cert_file_および_tls_private_key_file_引数が適切に設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_27_tls_cert_file_および_tls_private_key_file_引数が適切に設定されていることを確認する_自動化"></a>1.2.27 <code>--tls-cert-file</code> および <code>--tls-private-key-file</code> 引数が適切に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、apiserverでTLS接続を設定します。
次に、コントロールプレーンノードのAPIサーバーポッド仕様ファイル <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> を編集し、TLS証明書および秘密鍵ファイルのパラメータを設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>--tls-cert-file=&lt;path/to/tls-certificate-file&gt;
--tls-private-key-file=&lt;path/to/tls-key-file&gt;</pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep -A1 'Running kube-apiserver' | tail -n2</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--tls-cert-file' が存在し、'--tls-private-key-file' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key" Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-scheduler --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-scheduler --kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --profiling=false --secure-port=10259"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_28_client_ca_file_引数が適切に設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_28_client_ca_file_引数が適切に設定されていることを確認する_自動化"></a>1.2.28 <code>--client-ca-file</code> 引数が適切に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、apiserverでTLS接続を設定します。
次に、コントロールプレーンノードのAPIサーバーポッド仕様ファイル <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> を編集し、クライアント証明書認証局ファイルを設定します。
<code>--client-ca-file=&lt;path/to/client-ca-file&gt;</code></p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'client-ca-file'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--client-ca-file' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_29_etcd_cafile_引数が適切に設定されていることを確認する_自動化"><a class="anchor" href="#_1_2_29_etcd_cafile_引数が適切に設定されていることを確認する_自動化"></a>1.2.29 <code>--etcd-cafile</code> 引数が適切に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、apiserverとetcd間のTLS接続を設定します。
次に、コントロールプレーンノードのAPIサーバーポッド仕様ファイル <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> を編集し、etcd証明書認証局ファイルのパラメータを設定します。
<code>--etcd-cafile=&lt;path/to/ca-file&gt;</code></p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'etcd-cafile'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--etcd-cafile' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_30_ensure_that_the_encryption_provider_config_argument_is_set_as_appropriate_manual"><a class="anchor" href="#_1_2_30_ensure_that_the_encryption_provider_config_argument_is_set_as_appropriate_manual"></a>1.2.30 Ensure that the --encryption-provider-config argument is set as appropriate (Manual)</h3>
<div class="paragraph">
<p><strong>Result:</strong> warn</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Follow the Kubernetes documentation and configure a EncryptionConfig file.
Then, edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml
on the control plane node and set the --encryption-provider-config parameter to the path of that file.
For example, <code>--encryption-provider-config=&lt;/path/to/EncryptionConfig/File&gt;</code></p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'encryption-provider-config'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_31_ensure_that_encryption_providers_are_appropriately_configured_manual"><a class="anchor" href="#_1_2_31_ensure_that_encryption_providers_are_appropriately_configured_manual"></a>1.2.31 Ensure that encryption providers are appropriately configured (Manual)</h3>
<div class="paragraph">
<p><strong>Result:</strong> warn</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Follow the Kubernetes documentation and configure a EncryptionConfig file.
In this file, choose aescbc, kms or secretbox as the encryption provider.</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">grep aescbc /path/to/encryption-config.json</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_32_ensure_that_the_api_server_only_makes_use_of_strong_cryptographic_ciphers_manual"><a class="anchor" href="#_1_2_32_ensure_that_the_api_server_only_makes_use_of_strong_cryptographic_ciphers_manual"></a>1.2.32 Ensure that the API Server only makes use of Strong Cryptographic Ciphers (Manual)</h3>
<div class="paragraph">
<p><strong>Result:</strong> warn</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the API server pod specification file /etc/kubernetes/manifests/kube-apiserver.yaml
on the control plane node and set the below parameter.
--tls-cipher-suites=TLS_AES_128_GCM_SHA256,TLS_AES_256_GCM_SHA384,TLS_CHACHA20_POLY1305_SHA256,
TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,
TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,
TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,
TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,
TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,
TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256,TLS_RSA_WITH_3DES_EDE_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA,
TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA,TLS_RSA_WITH_AES_256_GCM_SHA384</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'tls-cipher-suites'</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_1_3_controller_manager"><a class="anchor" href="#_1_3_controller_manager"></a>1.3 Controller Manager</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_3_1_ensure_that_the_terminated_pod_gc_threshold_argument_is_set_as_appropriate_manual"><a class="anchor" href="#_1_3_1_ensure_that_the_terminated_pod_gc_threshold_argument_is_set_as_appropriate_manual"></a>1.3.1 Ensure that the --terminated-pod-gc-threshold argument is set as appropriate (Manual)</h3>
<div class="paragraph">
<p><strong>Result:</strong> warn</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and set the --terminated-pod-gc-threshold to an appropriate threshold,
for example, --terminated-pod-gc-threshold=10</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-controller-manager' | tail -n1 | grep 'terminated-pod-gc-threshold'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_3_2_ensure_that_the_profiling_argument_is_set_to_false_automated"><a class="anchor" href="#_1_3_2_ensure_that_the_profiling_argument_is_set_to_false_automated"></a>1.3.2 Ensure that the --profiling argument is set to false (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and set the below parameter.
--profiling=false</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-controller-manager' | tail -n1 | grep 'profiling'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--profiling' is equal to 'false'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-controller-manager --cluster-cidr=10.42.0.0/16 --cluster-signing-kube-apiserver-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kube-apiserver-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kubelet-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-serving-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-kubelet-serving-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --cluster-signing-legacy-unknown-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-legacy-unknown-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --configure-cloud-routes=false --controllers=*,-service,-route,-cloud-node-lifecycle --feature-gates=JobTrackingWithFinalizers=true --kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --profiling=false --root-ca-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --secure-port=10257 --service-account-private-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --use-service-account-credentials=true"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_3_3_ensure_that_the_use_service_account_credentials_argument_is_set_to_true_automated"><a class="anchor" href="#_1_3_3_ensure_that_the_use_service_account_credentials_argument_is_set_to_true_automated"></a>1.3.3 Ensure that the --use-service-account-credentials argument is set to true (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node to set the below parameter.
--use-service-account-credentials=true</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-controller-manager' | tail -n1 | grep 'use-service-account-credentials'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--use-service-account-credentials' is not equal to 'false'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-controller-manager --cluster-cidr=10.42.0.0/16 --cluster-signing-kube-apiserver-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kube-apiserver-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kubelet-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-serving-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-kubelet-serving-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --cluster-signing-legacy-unknown-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-legacy-unknown-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --configure-cloud-routes=false --controllers=*,-service,-route,-cloud-node-lifecycle --feature-gates=JobTrackingWithFinalizers=true --kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --profiling=false --root-ca-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --secure-port=10257 --service-account-private-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --use-service-account-credentials=true"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_3_4_ensure_that_the_service_account_private_key_file_argument_is_set_as_appropriate_automated"><a class="anchor" href="#_1_3_4_ensure_that_the_service_account_private_key_file_argument_is_set_as_appropriate_automated"></a>1.3.4 Ensure that the --service-account-private-key-file argument is set as appropriate (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and set the --service-account-private-key-file parameter
to the private key file for service accounts. For example,
<code>--service-account-private-key-file=&lt;filename&gt;</code>.</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-controller-manager' | tail -n1 | grep 'service-account-private-key-file'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--service-account-private-key-file' is present</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-controller-manager --cluster-cidr=10.42.0.0/16 --cluster-signing-kube-apiserver-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kube-apiserver-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kubelet-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-serving-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-kubelet-serving-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --cluster-signing-legacy-unknown-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-legacy-unknown-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --configure-cloud-routes=false --controllers=*,-service,-route,-cloud-node-lifecycle --feature-gates=JobTrackingWithFinalizers=true --kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --profiling=false --root-ca-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --secure-port=10257 --service-account-private-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --use-service-account-credentials=true"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_30_適切に設定された_encryption_provider_config_引数を確認する_手動"><a class="anchor" href="#_1_2_30_適切に設定された_encryption_provider_config_引数を確認する_手動"></a>1.2.30 適切に設定された --encryption-provider-config 引数を確認する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、EncryptionConfigファイルを設定します。
次に、コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、
--encryption-provider-config パラメータをそのファイルのパスに設定します。
例: <code>--encryption-provider-config=&lt;/path/to/EncryptionConfig/File&gt;</code></p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'encryption-provider-config'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_31_適切に設定された暗号化プロバイダーを確認する_手動"><a class="anchor" href="#_1_2_31_適切に設定された暗号化プロバイダーを確認する_手動"></a>1.2.31 適切に設定された暗号化プロバイダーを確認する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、EncryptionConfigファイルを設定します。
このファイルで、暗号化プロバイダーとしてaescbc、kms、またはsecretboxを選択します。</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">grep aescbc /path/to/encryption-config.json</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_2_32_apiサーバーが強力な暗号化スイートのみを使用していることを確認する_手動"><a class="anchor" href="#_1_2_32_apiサーバーが強力な暗号化スイートのみを使用していることを確認する_手動"></a>1.2.32 APIサーバーが強力な暗号化スイートのみを使用していることを確認する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードのAPIサーバーポッド仕様ファイル /etc/kubernetes/manifests/kube-apiserver.yaml を編集し、
以下のパラメータを設定します。
--tls-cipher-suites=TLS_AES_128_GCM_SHA256,TLS_AES_256_GCM_SHA384,TLS_CHACHA20_POLY1305_SHA256,
TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,
TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,
TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256,
TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,
TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,
TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256,TLS_RSA_WITH_3DES_EDE_CBC_SHA,TLS_RSA_WITH_AES_128_CBC_SHA,
TLS_RSA_WITH_AES_128_GCM_SHA256,TLS_RSA_WITH_AES_256_CBC_SHA,TLS_RSA_WITH_AES_256_GCM_SHA384</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'tls-cipher-suites'</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_1_3_コントローラーマネージャー"><a class="anchor" href="#_1_3_コントローラーマネージャー"></a>1.3 コントローラーマネージャー</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_3_1_適切に設定された_terminated_pod_gc_threshold_引数を確認する_手動"><a class="anchor" href="#_1_3_1_適切に設定された_terminated_pod_gc_threshold_引数を確認する_手動"></a>1.3.1 適切に設定された --terminated-pod-gc-threshold 引数を確認する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードのコントローラーマネージャーポッド仕様ファイル /etc/kubernetes/manifests/kube-controller-manager.yaml を編集し、
--terminated-pod-gc-threshold を適切な閾値に設定します。
例: --terminated-pod-gc-threshold=10</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-controller-manager' | tail -n1 | grep 'terminated-pod-gc-threshold'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_3_2_profiling_引数が_false_に設定されていることを確認する_自動"><a class="anchor" href="#_1_3_2_profiling_引数が_false_に設定されていることを確認する_自動"></a>1.3.2 --profiling 引数が false に設定されていることを確認する (自動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
コントロールプレーンノードのコントローラーマネージャーポッド仕様ファイル /etc/kubernetes/manifests/kube-controller-manager.yaml を編集し、
以下のパラメータを設定します。
--profiling=false</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-controller-manager' | tail -n1 | grep 'profiling'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--profiling' が 'false' に等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-controller-manager --cluster-cidr=10.42.0.0/16 --cluster-signing-kube-apiserver-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kube-apiserver-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kubelet-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-serving-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-kubelet-serving-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --cluster-signing-legacy-unknown-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-legacy-unknown-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --configure-cloud-routes=false --controllers=*,-service,-route,-cloud-node-lifecycle --feature-gates=JobTrackingWithFinalizers=true --kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --profiling=false --root-ca-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --secure-port=10257 --service-account-private-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --use-service-account-credentials=true"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_3_5_ensure_that_the_root_ca_file_argument_is_set_as_appropriate_automated"><a class="anchor" href="#_1_3_5_ensure_that_the_root_ca_file_argument_is_set_as_appropriate_automated"></a>1.3.5 Ensure that the --root-ca-file argument is set as appropriate (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and set the --root-ca-file parameter to the certificate bundle file.
<code>--root-ca-file=&lt;path/to/file&gt;</code></p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-controller-manager' | tail -n1 | grep 'root-ca-file'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--root-ca-file' is present</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-controller-manager --allocate-node-cidrs=true --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-controller-manager --cluster-cidr=10.42.0.0/16 --cluster-signing-kube-apiserver-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kube-apiserver-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-client-cert-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --cluster-signing-kubelet-client-key-file=/var/lib/rancher/k3s/server/tls/client-ca.key --cluster-signing-kubelet-serving-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-kubelet-serving-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --cluster-signing-legacy-unknown-cert-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --cluster-signing-legacy-unknown-key-file=/var/lib/rancher/k3s/server/tls/server-ca.key --configure-cloud-routes=false --controllers=*,-service,-route,-cloud-node-lifecycle --feature-gates=JobTrackingWithFinalizers=true --kubeconfig=/var/lib/rancher/k3s/server/cred/controller.kubeconfig --profiling=false --root-ca-file=/var/lib/rancher/k3s/server/tls/server-ca.crt --secure-port=10257 --service-account-private-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --use-service-account-credentials=true"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_3_6_ensure_that_the_rotatekubeletservercertificate_argument_is_set_to_true_automated"><a class="anchor" href="#_1_3_6_ensure_that_the_rotatekubeletservercertificate_argument_is_set_to_true_automated"></a>1.3.6 Ensure that the RotateKubeletServerCertificate argument is set to true (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> Not Applicable</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and set the --feature-gates parameter to include RotateKubeletServerCertificate=true.
--feature-gates=RotateKubeletServerCertificate=true</p>
</div>
</div>
<div class="sect2">
<h3 id="_1_3_7_ensure_that_the_bind_address_argument_is_set_to_127_0_0_1_automated"><a class="anchor" href="#_1_3_7_ensure_that_the_bind_address_argument_is_set_to_127_0_0_1_automated"></a>1.3.7 Ensure that the --bind-address argument is set to 127.0.0.1 (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the Controller Manager pod specification file /etc/kubernetes/manifests/kube-controller-manager.yaml
on the control plane node and ensure the correct value for the --bind-address parameter</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/ps -ef | grep containerd | grep -v grep</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--bind-address' is present OR '--bind-address' is not present</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">root 1616 1600 6 13:26 ? 00:01:28 containerd -c /var/lib/rancher/k3s/agent/etc/containerd/config.toml -a /run/k3s/containerd/containerd.sock --state /run/k3s/containerd --root /var/lib/rancher/k3s/agent/containerd root 2318 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id b41ec3297be4625c2406ad8b7b4f8b91cddd60850c420050c4c3273f809b3e7e -address /run/k3s/containerd/containerd.sock root 2341 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id e7999a65ae0a4e9969f32317ec48ae4f7071b62f92e5236696737973be77c2e1 -address /run/k3s/containerd/containerd.sock root 3199 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 90c4e63d6ee29d40a48c2fdaf2738c2472cba1139dde8a550466c452184f8528 -address /run/k3s/containerd/containerd.sock root 3923 1 0 13:27 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id be5f4b9bd1ed9239362b7000b47f353acb8bc8ca52a9c9145cba0e902ec1c4b9 -address /run/k3s/containerd/containerd.sock root 4559 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 04cd40ea6b6078797f177c902c89412c70e523ad2a687a62829bf1d16ff0e19c -address /run/k3s/containerd/containerd.sock root 4647 1 0 13:28 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 48f37a480315b6adce2d2a5c5d67a85412dd0ba7a2e82816434e0deb9fa75de9 -address /run/k3s/containerd/containerd.sock root 6610 1 0 13:47 ? 00:00:00 /var/lib/rancher/k3s/data/577968fa3d58539cc4265245941b7be688833e6bf5ad7869fa2afe02f15f1cd2/bin/containerd-shim-runc-v2 -namespace k8s.io -id 1cf71c22f568468055e517ab363437c0e54e45274c64024d337cc5bcce66341d -address /run/k3s/containerd/containerd.sock</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_1_4_scheduler"><a class="anchor" href="#_1_4_scheduler"></a>1.4 Scheduler</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_4_1_ensure_that_the_profiling_argument_is_set_to_false_automated"><a class="anchor" href="#_1_4_1_ensure_that_the_profiling_argument_is_set_to_false_automated"></a>1.4.1 Ensure that the --profiling argument is set to false (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the Scheduler pod specification file /etc/kubernetes/manifests/kube-scheduler.yaml file
on the control plane node and set the below parameter.
--profiling=false</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-scheduler' | tail -n1</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--profiling' is equal to 'false'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-scheduler --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-scheduler --kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --profiling=false --secure-port=10259"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_1_4_2_ensure_that_the_bind_address_argument_is_set_to_127_0_0_1_automated"><a class="anchor" href="#_1_4_2_ensure_that_the_bind_address_argument_is_set_to_127_0_0_1_automated"></a>1.4.2 Ensure that the --bind-address argument is set to 127.0.0.1 (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Edit the Scheduler pod specification file /etc/kubernetes/manifests/kube-scheduler.yaml
on the control plane node and ensure the correct value for the --bind-address parameter</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-scheduler' | tail -n1 | grep 'bind-address'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--bind-address' is equal to '127.0.0.1' OR '--bind-address' is not present</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-scheduler --authentication-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --authorization-kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/kube-scheduler --kubeconfig=/var/lib/rancher/k3s/server/cred/scheduler.kubeconfig --profiling=false --secure-port=10259"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_2_etcd_node_configuration"><a class="anchor" href="#_2_etcd_node_configuration"></a>2 Etcd Node Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_2_1_ensure_that_the_cert_file_and_key_file_arguments_are_set_as_appropriate_automated"><a class="anchor" href="#_2_1_ensure_that_the_cert_file_and_key_file_arguments_are_set_as_appropriate_automated"></a>2.1 Ensure that the --cert-file and --key-file arguments are set as appropriate (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
Follow the etcd service documentation and configure TLS encryption.
Then, edit the etcd pod specification file /etc/kubernetes/manifests/etcd.yaml
on the master node and set the below parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>--cert-file=&lt;/path/to/ca-file&gt;
--key-file=&lt;/path/to/key-file&gt;</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Audit Script:</strong> <code>check_for_k3s_etcd.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

# This script is used to ensure that k3s is actually running etcd (and not other databases like sqlite3)
# before it checks the requirement
set -eE

handle_error() {
    echo "false"
}

trap 'handle_error' ERR


if [[ "$(journalctl -D /var/log/journal -u k3s | grep 'Managed etcd cluster initializing' | grep -v grep | wc -l)" -gt 0 ]]; then
    case $1 in
        "1.1.11")
            echo $(stat -c %a /var/lib/rancher/k3s/server/db/etcd);;
        "1.2.29")
            echo $(journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'etcd-');;
        "2.1")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.2")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.3")
            echo $(grep 'auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.4")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.5")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.6")
            echo $(grep 'peer-auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.7")
            echo $(grep 'trusted-ca-file' /var/lib/rancher/k3s/server/db/etcd/config);;
    esac
else
# If another database is running, return whatever is required to pass the scan
    case $1 in
        "1.1.11")
            echo "700";;
        "1.2.29")
            echo "--etcd-certfile AND --etcd-keyfile";;
        "2.1")
            echo "cert-file AND key-file";;
        "2.2")
            echo "--client-cert-auth=true";;
        "2.3")
            echo "false";;
        "2.4")
            echo "peer-cert-file AND peer-key-file";;
        "2.5")
            echo "--client-cert-auth=true";;
        "2.6")
            echo "--peer-auto-tls=false";;
        "2.7")
            echo "--trusted-ca-file";;
    esac
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査実行:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./check_for_k3s_etcd.sh 2.1</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'cert-file' が存在し、かつ 'key-file' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cert-file AND key-file cert-file: /var/lib/rancher/k3s/server/tls/etcd/server-client.crt key-file: /var/lib/rancher/k3s/server/tls/etcd/server-client.key cert-file AND key-file</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_2_client_cert_auth_引数が_true_に設定されていることを確認する_自動化"><a class="anchor" href="#_2_2_client_cert_auth_引数が_true_に設定されていることを確認する_自動化"></a>2.2 --client-cert-auth 引数が true に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、以下のパラメータを設定します。
--client-cert-auth="true"</p>
</div>
<div class="paragraph">
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

# このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます
# 要件を確認する前に
set -eE

handle_error() {
    echo "false"
}

trap 'handle_error' ERR


if [[ "$(journalctl -D /var/log/journal -u k3s | grep 'Managed etcd cluster initializing' | grep -v grep | wc -l)" -gt 0 ]]; then
    case $1 in
        "1.1.11")
            echo $(stat -c %a /var/lib/rancher/k3s/server/db/etcd);;
        "1.2.29")
            echo $(journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'etcd-');;
        "2.1")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.2")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.3")
            echo $(grep 'auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.4")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.5")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.6")
            echo $(grep 'peer-auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.7")
            echo $(grep 'trusted-ca-file' /var/lib/rancher/k3s/server/db/etcd/config);;
    esac
else
# 別のデータベースが実行されている場合、スキャンを通過するために必要なものを返します
    case $1 in
        "1.1.11")
            echo "700";;
        "1.2.29")
            echo "--etcd-certfile AND --etcd-keyfile";;
        "2.1")
            echo "cert-file AND key-file";;
        "2.2")
            echo "--client-cert-auth=true";;
        "2.3")
            echo "false";;
        "2.4")
            echo "peer-cert-file AND peer-key-file";;
        "2.5")
            echo "--client-cert-auth=true";;
        "2.6")
            echo "--peer-auto-tls=false";;
        "2.7")
            echo "--trusted-ca-file";;
    esac
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査実行:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./check_for_k3s_etcd.sh 2.2</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--client-cert-auth' が存在する、または 'client-cert-auth' が 'true' に等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">--client-cert-auth=true client-cert-auth: true --client-cert-auth=true</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_3_auto_tls_引数が_true_に設定されていないことを確認する_自動化"><a class="anchor" href="#_2_3_auto_tls_引数が_true_に設定されていないことを確認する_自動化"></a>2.3 --auto-tls 引数が true に設定されていないことを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、--auto-tls パラメータを削除するか、false に設定します。
 --auto-tls=false</p>
</div>
<div class="paragraph">
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

# このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます
# 要件を確認する前に
set -eE

handle_error() {
    echo "false"
}

trap 'handle_error' ERR


if [[ "$(journalctl -D /var/log/journal -u k3s | grep 'Managed etcd cluster initializing' | grep -v grep | wc -l)" -gt 0 ]]; then
    case $1 in
        "1.1.11")
            echo $(stat -c %a /var/lib/rancher/k3s/server/db/etcd);;
        "1.2.29")
            echo $(journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'etcd-');;
        "2.1")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.2")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.3")
            echo $(grep 'auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.4")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.5")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.6")
            echo $(grep 'peer-auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.7")
            echo $(grep 'trusted-ca-file' /var/lib/rancher/k3s/server/db/etcd/config);;
    esac
else
# 別のデータベースが実行されている場合、スキャンを通過するために必要なものを返します
    case $1 in
        "1.1.11")
            echo "700";;
        "1.2.29")
            echo "--etcd-certfile AND --etcd-keyfile";;
        "2.1")
            echo "cert-file AND key-file";;
        "2.2")
            echo "--client-cert-auth=true";;
        "2.3")
            echo "false";;
        "2.4")
            echo "peer-cert-file AND peer-key-file";;
        "2.5")
            echo "--client-cert-auth=true";;
        "2.6")
            echo "--peer-auto-tls=false";;
        "2.7")
            echo "--trusted-ca-file";;
    esac
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査実行:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./check_for_k3s_etcd.sh 2.3</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'ETCD_AUTO_TLS' が存在しない、または 'ETCD_AUTO_TLS' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">error: process ID list syntax error Usage: ps [options] Try 'ps --help &lt;simple|list|output|threads|misc|all&gt;' or 'ps --help &lt;s|l|o|t|m|a&gt;' for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory error: process ID list syntax error Usage: ps [options] Try 'ps --help &lt;simple|list|output|threads|misc|all&gt;' or 'ps --help &lt;s|l|o|t|m|a&gt;' for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory error: process ID list syntax error Usage: ps [options] Try 'ps --help &lt;simple|list|output|threads|misc|all&gt;' or 'ps --help &lt;s|l|o|t|m|a&gt;' for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_4_peer_cert_file_および_peer_key_file_引数が適切に設定されていることを確認する_自動化"><a class="anchor" href="#_2_4_peer_cert_file_および_peer_key_file_引数が適切に設定されていることを確認する_自動化"></a>2.4 --peer-cert-file および --peer-key-file 引数が適切に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
etcd サービスのドキュメントに従い、etcd クラスターに適したピア TLS 暗号化を構成します。
次に、マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、以下のパラメータを設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>--peer-client-file=&lt;/path/to/peer-cert-file&gt;
--peer-key-file=&lt;/path/to/peer-key-file&gt;</pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

# このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます
# 要件を確認する前に
set -eE

handle_error() {
    echo "false"
}

trap 'handle_error' ERR


if [[ "$(journalctl -D /var/log/journal -u k3s | grep 'Managed etcd cluster initializing' | grep -v grep | wc -l)" -gt 0 ]]; then
    case $1 in
        "1.1.11")
            echo $(stat -c %a /var/lib/rancher/k3s/server/db/etcd);;
        "1.2.29")
            echo $(journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'etcd-');;
        "2.1")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.2")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.3")
            echo $(grep 'auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.4")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.5")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.6")
            echo $(grep 'peer-auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.7")
            echo $(grep 'trusted-ca-file' /var/lib/rancher/k3s/server/db/etcd/config);;
    esac
else
# 別のデータベースが実行されている場合、スキャンを通過するために必要なものを返します
    case $1 in
        "1.1.11")
            echo "700";;
        "1.2.29")
            echo "--etcd-certfile AND --etcd-keyfile";;
        "2.1")
            echo "cert-file AND key-file";;
        "2.2")
            echo "--client-cert-auth=true";;
        "2.3")
            echo "false";;
        "2.4")
            echo "peer-cert-file AND peer-key-file";;
        "2.5")
            echo "--client-cert-auth=true";;
        "2.6")
            echo "--peer-auto-tls=false";;
        "2.7")
            echo "--trusted-ca-file";;
    esac
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査実行:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./check_for_k3s_etcd.sh 2.3</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'ETCD_AUTO_TLS' が存在しない、または 'ETCD_AUTO_TLS' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">error: process ID list syntax error Usage: ps [options] Try 'ps --help &lt;simple|list|output|threads|misc|all&gt;' or 'ps --help &lt;s|l|o|t|m|a&gt;' for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory error: process ID list syntax error Usage: ps [options] Try 'ps --help &lt;simple|list|output|threads|misc|all&gt;' or 'ps --help &lt;s|l|o|t|m|a&gt;' for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory error: process ID list syntax error Usage: ps [options] Try 'ps --help &lt;simple|list|output|threads|misc|all&gt;' or 'ps --help &lt;s|l|o|t|m|a&gt;' for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">            echo "cert-file AND key-file";;
        "2.2")
            echo "--client-cert-auth=true";;
        "2.3")
            echo "false";;
        "2.4")
            echo "peer-cert-file AND peer-key-file";;
        "2.5")
            echo "--client-cert-auth=true";;
        "2.6")
            echo "--peer-auto-tls=false";;
        "2.7")
            echo "--trusted-ca-file";;
    esac
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査実行:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./check_for_k3s_etcd.sh 2.4</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'cert-file' が存在し、かつ 'key-file' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">peer-cert-file AND peer-key-file cert-file: /var/lib/rancher/k3s/server/tls/etcd/peer-server-client.crt key-file: /var/lib/rancher/k3s/server/tls/etcd/peer-server-client.key peer-cert-file AND peer-key-file</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_5_peer_client_cert_auth_引数が_true_に設定されていることを確認する_自動化"><a class="anchor" href="#_2_5_peer_client_cert_auth_引数が_true_に設定されていることを確認する_自動化"></a>2.5 --peer-client-cert-auth 引数が true に設定されていることを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、以下のパラメータを設定します。
--peer-client-cert-auth=true</p>
</div>
<div class="paragraph">
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

# このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます
# 要件を確認する前に
set -eE

handle_error() {
    echo "false"
}

trap 'handle_error' ERR


if [[ "$(journalctl -D /var/log/journal -u k3s | grep 'Managed etcd cluster initializing' | grep -v grep | wc -l)" -gt 0 ]]; then
    case $1 in
        "1.1.11")
            echo $(stat -c %a /var/lib/rancher/k3s/server/db/etcd);;
        "1.2.29")
            echo $(journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'etcd-');;
        "2.1")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.2")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.3")
            echo $(grep 'auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.4")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.5")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.6")
            echo $(grep 'peer-auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.7")
            echo $(grep 'trusted-ca-file' /var/lib/rancher/k3s/server/db/etcd/config);;
    esac
else
# 別のデータベースが実行されている場合、スキャンをパスするために必要なものを返します
    case $1 in
        "1.1.11")
            echo "700";;
        "1.2.29")
            echo "--etcd-certfile AND --etcd-keyfile";;
        "2.1")
            echo "cert-file AND key-file";;
        "2.2")
            echo "--client-cert-auth=true";;
        "2.3")
            echo "false";;
        "2.4")
            echo "peer-cert-file AND peer-key-file";;
        "2.5")
            echo "--client-cert-auth=true";;
        "2.6")
            echo "--peer-auto-tls=false";;
        "2.7")
            echo "--trusted-ca-file";;
    esac
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査実行:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./check_for_k3s_etcd.sh 2.5</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--client-cert-auth' が存在する、または 'client-cert-auth' が 'true' と等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">--client-cert-auth=true client-cert-auth: true --client-cert-auth=true</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_6_peer_auto_tls_引数が_true_に設定されていないことを確認する_自動化"><a class="anchor" href="#_2_6_peer_auto_tls_引数が_true_に設定されていないことを確認する_自動化"></a>2.6 --peer-auto-tls 引数が true に設定されていないことを確認する (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、--peer-auto-tls パラメータを削除するか、false に設定します。
--peer-auto-tls=false</p>
</div>
<div class="paragraph">
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

# このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます
# 要件を確認する前に
set -eE

handle_error() {
    echo "false"
}

trap 'handle_error' ERR


if [[ "$(journalctl -D /var/log/journal -u k3s | grep 'Managed etcd cluster initializing' | grep -v grep | wc -l)" -gt 0 ]]; then
    case $1 in
        "1.1.11")
            echo $(stat -c %a /var/lib/rancher/k3s/server/db/etcd);;
        "1.2.29")
            echo $(journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'etcd-');;
        "2.1")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.2")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.3")
            echo $(grep 'auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.4")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.5")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.6")
            echo $(grep 'peer-auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.7")
            echo $(grep 'trusted-ca-file' /var/lib/rancher/k3s/server/db/etcd/config);;
    esac
else
# 別のデータベースが実行されている場合、スキャンをパスするために必要なものを返します
    case $1 in
        "1.1.11")
            echo "700";;
        "1.2.29")
            echo "--etcd-certfile AND --etcd-keyfile";;
        "2.1")
            echo "cert-file AND key-file";;
        "2.2")
            echo "--client-cert-auth=true";;
        "2.3")
            echo "false";;
        "2.4")
            echo "peer-cert-file AND peer-key-file";;
        "2.5")
            echo "--client-cert-auth=true";;
        "2.6")
            echo "--peer-auto-tls=false";;
        "2.7")
            echo "--trusted-ca-file";;
    esac
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査実行:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./check_for_k3s_etcd.sh 2.6</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--peer-auto-tls' が存在しない、または '--peer-auto-tls' が 'false' と等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">--peer-auto-tls=false error: process ID list syntax error Usage: ps [options] Try 'ps --help &lt;simple|list|output|threads|misc|all&gt;' or 'ps --help &lt;s|l|o|t|m|a&gt;' for additional help text. For more details see ps(1). cat: /proc//environ: No such file or directory --peer-auto-tls=false</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_7_etcd_に対して一意の証明書認証局が使用されていることを確認する_手動"><a class="anchor" href="#_2_7_etcd_に対して一意の証明書認証局が使用されていることを確認する_手動"></a>2.7 etcd に対して一意の証明書認証局が使用されていることを確認する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong></p>
</div>
<div class="paragraph">
<p>etcd のドキュメントに従い、etcd サービス用の専用証明書認証局セットアップを作成します。
その後、マスターノードの etcd ポッド仕様ファイル /etc/kubernetes/manifests/etcd.yaml を編集し、以下のパラメータを設定します。
<code>--trusted-ca-file=&lt;/path/to/ca-file&gt;</code></p>
</div>
<div class="paragraph">
<p><strong>監査スクリプト:</strong> <code>check_for_k3s_etcd.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash

# このスクリプトは、k3s が実際に etcd を実行していること（sqlite3 などの他のデータベースではないこと）を確認するために使用されます
# 要件を確認する前に
set -eE

handle_error() {
    echo "false"
}

trap 'handle_error' ERR


if [[ "$(journalctl -D /var/log/journal -u k3s | grep 'Managed etcd cluster initializing' | grep -v grep | wc -l)" -gt 0 ]]; then
    case $1 in
        "1.1.11")
            echo $(stat -c %a /var/lib/rancher/k3s/server/db/etcd);;
        "1.2.29")
            echo $(journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'etcd-');;
        "2.1")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.2")
            echo $(grep -A 5 'client-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.3")
            echo $(grep 'auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.4")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep -E 'cert-file|key-file');;
        "2.5")
            echo $(grep -A 5 'peer-transport-security' /var/lib/rancher/k3s/server/db/etcd/config | grep 'client-cert-auth');;
        "2.6")
            echo $(grep 'peer-auto-tls' /var/lib/rancher/k3s/server/db/etcd/config);;
        "2.7")
            echo $(grep 'trusted-ca-file' /var/lib/rancher/k3s/server/db/etcd/config);;
    esac
else
# 別のデータベースが実行されている場合、スキャンをパスするために必要なものを返します
    case $1 in
        "1.1.11")
            echo "700";;
        "1.2.29")
            echo "--etcd-certfile AND --etcd-keyfile";;
        "2.1")
            echo "cert-file AND key-file";;
        "2.2")
            echo "--client-cert-auth=true";;
        "2.3")
            echo "false";;
        "2.4")
            echo "peer-cert-file AND peer-key-file";;
        "2.5")
            echo "--client-cert-auth=true";;
        "2.6")
            echo "--peer-auto-tls=false";;
        "2.7")
            echo "--trusted-ca-file";;
    esac
fi</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査実行:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./check_for_k3s_etcd.sh 2.7</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'trusted-ca-file' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">--trusted-ca-file trusted-ca-file: /var/lib/rancher/k3s/server/tls/etcd/server-ca.crt trusted-ca-file: /var/lib/rancher/k3s/server/tls/etcd/peer-ca.crt --trusted-ca-file</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_1_認証と認可"><a class="anchor" href="#_3_1_認証と認可"></a>3.1 認証と認可</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_3_1_1_クライアント証明書認証はユーザーに対して使用されるべきではない_手動"><a class="anchor" href="#_3_1_1_クライアント証明書認証はユーザーに対して使用されるべきではない_手動"></a>3.1.1 クライアント証明書認証はユーザーに対して使用されるべきではない (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
クライアント証明書の代わりに、OIDC の使用など Kubernetes が提供する代替メカニズムを実装するべきです。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_2_ロギング"><a class="anchor" href="#_3_2_ロギング"></a>3.2 ロギング</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_3_2_1_最小限の監査ポリシーが作成されていることを確認する_手動"><a class="anchor" href="#_3_2_1_最小限の監査ポリシーが作成されていることを確認する_手動"></a>3.2.1 最小限の監査ポリシーが作成されていることを確認する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
クラスター用の監査ポリシーファイルを作成します。</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kube-apiserver' | tail -n1 | grep 'audit-policy-file'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_3_2_2_監査ポリシーが主要なセキュリティ問題をカバーしていることを確認する_手動"><a class="anchor" href="#_3_2_2_監査ポリシーが主要なセキュリティ問題をカバーしていることを確認する_手動"></a>3.2.2 監査ポリシーが主要なセキュリティ問題をカバーしていることを確認する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
クラスターに提供される監査ポリシーを確認し、少なくとも以下の領域をカバーしていることを確認します。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>クラスターによって管理されるSecretsへのアクセス。Secrets、ConfigMaps、およびTokenReviewsへのリクエストのメタデータのみをログに記録するように注意し、機密データのログ記録のリスクを避ける。</p>
</li>
<li>
<p>PodおよびDeploymentオブジェクトの変更。</p>
</li>
<li>
<p><code>pods/exec</code>、<code>pods/portforward</code>、<code>pods/proxy</code>、および`services/proxy`の使用。
ほとんどのリクエストに対して、最低限メタデータレベルでのログ記録が推奨される（最も基本的なログ記録レベル）。</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_1_ワーカーノードの構成ファイル"><a class="anchor" href="#_4_1_ワーカーノードの構成ファイル"></a>4.1 ワーカーノードの構成ファイル</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_4_1_1_kubeletサービスファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化"><a class="anchor" href="#_4_1_1_kubeletサービスファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化"></a>4.1.1 kubeletサービスファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例: chmod 644 /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</p>
</div>
</div>
<div class="sect2">
<h3 id="_4_1_2_kubeletサービスファイルの所有者がrootrootに設定されていることを確認する自動化"><a class="anchor" href="#_4_1_2_kubeletサービスファイルの所有者がrootrootに設定されていることを確認する自動化"></a>4.1.2 kubeletサービスファイルの所有者がroot:rootに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例:
chown root:root /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</p>
</div>
</div>
<div class="sect2">
<h3 id="_4_1_3_プロキシkubeconfigファイルが存在する場合パーミッションが644またはそれ以上に制限されていることを確認する手動"><a class="anchor" href="#_4_1_3_プロキシkubeconfigファイルが存在する場合パーミッションが644またはそれ以上に制限されていることを確認する手動"></a>4.1.3 プロキシkubeconfigファイルが存在する場合、パーミッションが644またはそれ以上に制限されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例:
chmod 644 /var/lib/rancher/k3s/agent/kubeproxy.kubeconfig</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stat -c %a /var/lib/rancher/k3s/agent/kubeproxy.kubeconfig</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'permissions'が存在する または '/var/lib/rancher/k3s/agent/kubeproxy.kubeconfig'が存在しない</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">644 644</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_1_4_プロキシkubeconfigファイルが存在する場合所有者がrootrootに設定されていることを確認する手動"><a class="anchor" href="#_4_1_4_プロキシkubeconfigファイルが存在する場合所有者がrootrootに設定されていることを確認する手動"></a>4.1.4 プロキシkubeconfigファイルが存在する場合、所有者がroot:rootに設定されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例: chown root:root /var/lib/rancher/k3s/agent/kubeproxy.kubeconfig</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/sh -c 'if test -e /var/lib/rancher/k3s/agent/kubeproxy.kubeconfig; then stat -c %U:%G /var/lib/rancher/k3s/agent/kubeproxy.kubeconfig; fi'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'root:root'が存在する または '/var/lib/rancher/k3s/agent/kubeproxy.kubeconfig'が存在しない</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">root:root root:root</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_1_5_kubeconfig_kubelet_confファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化"><a class="anchor" href="#_4_1_5_kubeconfig_kubelet_confファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化"></a>4.1.5 --kubeconfig kubelet.confファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例:
chmod 644 /var/lib/rancher/k3s/server/cred/admin.kubeconfig</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stat -c %a /var/lib/rancher/k3s/agent/kubelet.kubeconfig</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'644'が'644'と等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">644 644</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_1_6_kubeconfig_kubelet_confファイルの所有者がrootrootに設定されていることを確認する自動化"><a class="anchor" href="#_4_1_6_kubeconfig_kubelet_confファイルの所有者がrootrootに設定されていることを確認する自動化"></a>4.1.6 --kubeconfig kubelet.confファイルの所有者がroot:rootに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
各ワーカーノードで以下のコマンドを実行します（システム上のファイルの場所に基づく）。
例:
chown root:root /var/lib/rancher/k3s/server/cred/admin.kubeconfig</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stat -c %U:%G /var/lib/rancher/k3s/agent/kubelet.kubeconfig</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'root:root'が'root:root'と等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">root:root root:root</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_1_7_証明書認証局ファイルのパーミッションが644またはそれ以上に制限されていることを確認する手動"><a class="anchor" href="#_4_1_7_証明書認証局ファイルのパーミッションが644またはそれ以上に制限されていることを確認する手動"></a>4.1.7 証明書認証局ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
--client-ca-fileのファイルパーミッションを変更するために以下のコマンドを実行します: <code>chmod 644 &lt;filename&gt;</code></p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stat -c %a /var/lib/rancher/k3s/server/tls/server-ca.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'644'が存在する または '640'が存在する または '600'が'600'と等しい または '444'が存在する または '440'が存在する または '400'が存在する または '000'が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">644 600</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_1_8_クライアント証明書認証局ファイルの所有者がrootrootに設定されていることを確認する手動"><a class="anchor" href="#_4_1_8_クライアント証明書認証局ファイルの所有者がrootrootに設定されていることを確認する手動"></a>4.1.8 クライアント証明書認証局ファイルの所有者がroot:rootに設定されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
--client-ca-fileの所有者を変更するために以下のコマンドを実行します:
<code>chown root:root &lt;filename&gt;</code>.</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stat -c %U:%G /var/lib/rancher/k3s/server/tls/client-ca.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'root:root'が'root:root'と等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">root:root root:root</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_1_9_kubelet_config構成ファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化"><a class="anchor" href="#_4_1_9_kubelet_config構成ファイルのパーミッションが644またはそれ以上に制限されていることを確認する自動化"></a>4.1.9 kubelet --config構成ファイルのパーミッションが644またはそれ以上に制限されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
監査ステップで特定された構成ファイルの場所を使用して以下のコマンドを実行します
chmod 644 /var/lib/kubelet/config.yaml</p>
</div>
</div>
<div class="sect2">
<h3 id="_4_1_10_kubelet_config構成ファイルの所有者がrootrootに設定されていることを確認する自動化"><a class="anchor" href="#_4_1_10_kubelet_config構成ファイルの所有者がrootrootに設定されていることを確認する自動化"></a>4.1.10 kubelet --config構成ファイルの所有者がroot:rootに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
監査ステップで特定された構成ファイルの場所を使用して以下のコマンドを実行します
chown root:root /var/lib/kubelet/config.yaml</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_4_2_kubelet"><a class="anchor" href="#_4_2_kubelet"></a>4.2 Kubelet</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_4_2_1_anonymous_auth引数がfalseに設定されていることを確認する自動化"><a class="anchor" href="#_4_2_1_anonymous_auth引数がfalseに設定されていることを確認する自動化"></a>4.2.1 --anonymous-auth引数がfalseに設定されていることを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubelet構成ファイルを使用している場合、ファイルを編集して<code>authentication: anonymous: enabled</code>を<code>false</code>に設定します。
実行可能な引数を使用している場合、各ワーカーノードのkubeletサービスファイル
/etc/systemd/system/kubelet.service.d/10-kubeadm.confを編集し、以下のパラメータをKUBELET_SYSTEM_PODS_ARGS変数に設定します。
<code>--anonymous-auth=false</code>
システムに基づいて、kubeletサービスを再起動します。例:
systemctl daemon-reload
systemctl restart kubelet.service</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/sh -c 'if test $(journalctl -D /var/log/journal -u k3s | grep "Running kube-apiserver" | wc -l) -gt 0; then journalctl -D /var/log/journal -u k3s | grep "Running kube-apiserver" | tail -n1 | grep "anonymous-auth" | grep -v grep; else echo "--anonymous-auth=false"; fi'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--anonymous-auth'が'false'と等しい</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">--anonymous-auth=false Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_2_authorization_mode引数がalwaysallowに設定されていないことを確認する自動化"><a class="anchor" href="#_4_2_2_authorization_mode引数がalwaysallowに設定されていないことを確認する自動化"></a>4.2.2 --authorization-mode引数がAlwaysAllowに設定されていないことを確認する（自動化）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubelet構成ファイルを使用している場合、ファイルを編集して<code>authorization.mode</code>をWebhookに設定します。実行可能な引数を使用している場合、各ワーカーノードのkubeletサービスファイル
/etc/systemd/system/kubelet.service.d/10-kubeadm.confを編集し、以下のパラメータをKUBELET_AUTHZ_ARGS変数に設定します。
--authorization-mode=Webhook
システムに基づいて、kubeletサービスを再起動します。例:
systemctl daemon-reload
systemctl restart kubelet.service</p>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/sh -c 'if test $(journalctl -D /var/log/journal -u k3s | grep "Running kube-apiserver" | wc -l) -gt 0; then journalctl -D /var/log/journal -u k3s | grep "Running kube-apiserver" | tail -n1 | grep "authorization-mode" | grep -v grep; else echo "--authorization-mode=Webhook"; fi'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--authorization-mode'に'AlwaysAllow'が含まれていない</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返される値</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">--authorization-mode=Webhook Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_3_ensure_that_the_client_ca_file_argument_is_set_as_appropriate_automated"><a class="anchor" href="#_4_2_3_ensure_that_the_client_ca_file_argument_is_set_as_appropriate_automated"></a>4.2.3 Ensure that the --client-ca-file argument is set as appropriate (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
If using a Kubelet config file, edit the file to set <code>authentication.x509.clientCAFile</code> to
the location of the client CA file.
If using command line arguments, edit the kubelet service file
/etc/systemd/system/kubelet.service.d/10-kubeadm.conf on each worker node and
set the below parameter in KUBELET_AUTHZ_ARGS variable.
<code>--client-ca-file=&lt;path/to/client-ca-file&gt;</code>
Based on your system, restart the kubelet service. For example,
systemctl daemon-reload
systemctl restart kubelet.service</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/sh -c 'if test $(journalctl -D /var/log/journal -u k3s | grep "Running kube-apiserver" | wc -l) -gt 0; then journalctl -D /var/log/journal -u k3s | grep "Running kube-apiserver" | tail -n1 | grep "client-ca-file" | grep -v grep; else echo "--client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt"; fi'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--client-ca-file' is present</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">--client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt Sep 13 13:26:40 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:40Z" level=info msg="Running kube-apiserver --advertise-address=172.31.0.140 --advertise-port=6443 --allow-privileged=true --anonymous-auth=false --api-audiences=https://kubernetes.default.svc.cluster.local,k3s --authorization-mode=Node,RBAC --bind-address=127.0.0.1 --cert-dir=/var/lib/rancher/k3s/server/tls/temporary-certs --client-ca-file=/var/lib/rancher/k3s/server/tls/client-ca.crt --egress-selector-config-file=/var/lib/rancher/k3s/server/etc/egress-selector-config.yaml --enable-admission-plugins=NodeRestriction --enable-aggregator-routing=true --etcd-cafile=/var/lib/rancher/k3s/server/tls/etcd/server-ca.crt --etcd-certfile=/var/lib/rancher/k3s/server/tls/etcd/client.crt --etcd-keyfile=/var/lib/rancher/k3s/server/tls/etcd/client.key --etcd-servers=https://127.0.0.1:2379 --feature-gates=JobTrackingWithFinalizers=true --kubelet-certificate-authority=/var/lib/rancher/k3s/server/tls/server-ca.crt --kubelet-client-certificate=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.crt --kubelet-client-key=/var/lib/rancher/k3s/server/tls/client-kube-apiserver.key --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname --profiling=false --proxy-client-cert-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.crt --proxy-client-key-file=/var/lib/rancher/k3s/server/tls/client-auth-proxy.key --requestheader-allowed-names=system:auth-proxy --requestheader-client-ca-file=/var/lib/rancher/k3s/server/tls/request-header-ca.crt --requestheader-extra-headers-prefix=X-Remote-Extra- --requestheader-group-headers=X-Remote-Group --requestheader-username-headers=X-Remote-User --secure-port=6444 --service-account-issuer=https://kubernetes.default.svc.cluster.local --service-account-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-account-signing-key-file=/var/lib/rancher/k3s/server/tls/service.key --service-cluster-ip-range=10.43.0.0/16 --service-node-port-range=30000-32767 --storage-backend=etcd3 --tls-cert-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.crt --tls-private-key-file=/var/lib/rancher/k3s/server/tls/serving-kube-apiserver.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_4_ensure_that_the_read_only_port_argument_is_set_to_0_manual"><a class="anchor" href="#_4_2_4_ensure_that_the_read_only_port_argument_is_set_to_0_manual"></a>4.2.4 Ensure that the --read-only-port argument is set to 0 (Manual)</h3>
<div class="paragraph">
<p><strong>Result:</strong> pass</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
If using a Kubelet config file, edit the file to set <code>readOnlyPort</code> to 0.
If using command line arguments, edit the kubelet service file
/etc/systemd/system/kubelet.service.d/10-kubeadm.conf on each worker node and
set the below parameter in KUBELET_SYSTEM_PODS_ARGS variable.
--read-only-port=0
Based on your system, restart the kubelet service. For example,
systemctl daemon-reload
systemctl restart kubelet.service</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kubelet' | tail -n1 | grep 'read-only-port'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Expected Result</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--read-only-port' is equal to '0' OR '--read-only-port' is not present</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Returned Value</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:50 k3s-123-cis-pool2-98604672-hr9p5 k3s[1592]: time="2022-09-13T13:26:50Z" level=info msg="Running kubelet --address=0.0.0.0 --anonymous-auth=false --authentication-token-webhook=true --authorization-mode=Webhook --cgroup-driver=systemd --client-ca-file=/var/lib/rancher/k3s/agent/client-ca.crt --cloud-provider=external --cluster-dns=10.43.0.10 --cluster-domain=cluster.local --container-runtime-endpoint=unix:///run/k3s/containerd/containerd.sock --containerd=/run/k3s/containerd/containerd.sock --eviction-hard=imagefs.available&lt;5%,nodefs.available&lt;5% --eviction-minimum-reclaim=imagefs.available=10%,nodefs.available=10% --fail-swap-on=false --healthz-bind-address=127.0.0.1 --hostname-override=k3s-123-cis-pool2-98604672-hr9p5 --kubeconfig=/var/lib/rancher/k3s/agent/kubelet.kubeconfig --node-labels=rke.cattle.io/machine=00c4e7a0-5497-4367-a70c-0b836757eae8 --pod-infra-container-image=rancher/mirrored-pause:3.6 --pod-manifest-path=/var/lib/rancher/k3s/agent/pod-manifests --read-only-port=0 --resolv-conf=/run/systemd/resolve/resolv.conf --serialize-image-pulls=false --tls-cert-file=/var/lib/rancher/k3s/agent/serving-kubelet.crt --tls-private-key-file=/var/lib/rancher/k3s/agent/serving-kubelet.key" Sep 13 13:26:44 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:44Z" level=info msg="Running kubelet --address=0.0.0.0 --anonymous-auth=false --authentication-token-webhook=true --authorization-mode=Webhook --cgroup-driver=systemd --client-ca-file=/var/lib/rancher/k3s/agent/client-ca.crt --cloud-provider=external --cluster-dns=10.43.0.10 --cluster-domain=cluster.local --container-runtime-endpoint=unix:///run/k3s/containerd/containerd.sock --containerd=/run/k3s/containerd/containerd.sock --eviction-hard=imagefs.available&lt;5%,nodefs.available&lt;5% --eviction-minimum-reclaim=imagefs.available=10%,nodefs.available=10% --fail-swap-on=false --healthz-bind-address=127.0.0.1 --hostname-override=k3s-123-cis-pool3-b403f678-bzdg5 --kubeconfig=/var/lib/rancher/k3s/agent/kubelet.kubeconfig --node-labels=rke.cattle.io/machine=109d596c-89f5-4c10-8c7f-6b82a38edd8f --pod-infra-container-image=rancher/mirrored-pause:3.6 --pod-manifest-path=/var/lib/rancher/k3s/agent/pod-manifests --read-only-port=0 --resolv-conf=/run/systemd/resolve/resolv.conf --serialize-image-pulls=false --tls-cert-file=/var/lib/rancher/k3s/agent/serving-kubelet.crt --tls-private-key-file=/var/lib/rancher/k3s/agent/serving-kubelet.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_5_ensure_that_the_streaming_connection_idle_timeout_argument_is_not_set_to_0_manual"><a class="anchor" href="#_4_2_5_ensure_that_the_streaming_connection_idle_timeout_argument_is_not_set_to_0_manual"></a>4.2.5 Ensure that the --streaming-connection-idle-timeout argument is not set to 0 (Manual)</h3>
<div class="paragraph">
<p><strong>Result:</strong> warn</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
If using a Kubelet config file, edit the file to set <code>streamingConnectionIdleTimeout</code> to a
value other than 0.
If using command line arguments, edit the kubelet service file
/etc/systemd/system/kubelet.service.d/10-kubeadm.conf on each worker node and
set the below parameter in KUBELET_SYSTEM_PODS_ARGS variable.
--streaming-connection-idle-timeout=5m
Based on your system, restart the kubelet service. For example,
systemctl daemon-reload
systemctl restart kubelet.service</p>
</div>
<div class="paragraph">
<p><strong>Audit:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kubelet' | tail -n1 | grep 'streaming-connection-idle-timeout'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_6_ensure_that_the_protect_kernel_defaults_argument_is_set_to_true_automated"><a class="anchor" href="#_4_2_6_ensure_that_the_protect_kernel_defaults_argument_is_set_to_true_automated"></a>4.2.6 Ensure that the --protect-kernel-defaults argument is set to true (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> Not Applicable</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong>
If using a Kubelet config file, edit the file to set <code>protectKernelDefaults</code> to <code>true</code>.
If using command line arguments, edit the kubelet service file
/etc/systemd/system/kubelet.service.d/10-kubeadm.conf on each worker node and
set the below parameter in KUBELET_SYSTEM_PODS_ARGS variable.
--protect-kernel-defaults=true
Based on your system, restart the kubelet service. For example:
systemctl daemon-reload
systemctl restart kubelet.service</p>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_7_ensure_that_the_make_iptables_util_chains_argument_is_set_to_true_automated"><a class="anchor" href="#_4_2_7_ensure_that_the_make_iptables_util_chains_argument_is_set_to_true_automated"></a>4.2.7 Ensure that the --make-iptables-util-chains argument is set to true (Automated)</h3>
<div class="paragraph">
<p><strong>Result:</strong> Not Applicable</p>
</div>
<div class="paragraph">
<p><strong>Remediation:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>もし Kubelet の設定ファイルを使用している場合は、ファイルを編集して `makeIPTablesUtilChains` を `true` に設定します。
コマンドライン引数を使用している場合は、各ワーカーノードの kubelet サービスファイル
`/etc/systemd/system/kubelet.service.d/10-kubeadm.conf` を編集し、
`KUBELET_SYSTEM_PODS_ARGS` 変数から `--make-iptables-util-chains` 引数を削除します。
システムに基づいて、kubelet サービスを再起動します。例えば：

[,bash]
systemctl daemon-reload
systemctl restart kubelet.service</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_8_hostname_override_引数が設定されていないことを確認する手動"><a class="anchor" href="#_4_2_8_hostname_override_引数が設定されていないことを確認する手動"></a>4.2.8 <code>--hostname-override</code> 引数が設定されていないことを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
各ワーカーノードの kubelet サービスファイル <code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
<code>KUBELET_SYSTEM_PODS_ARGS</code> 変数から <code>--hostname-override</code> 引数を削除します。
システムに基づいて、kubelet サービスを再起動します。例えば：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl daemon-reload
systemctl restart kubelet.service</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_9_event_qps_引数が_0_または適切なイベントキャプチャを確保するレベルに設定されていることを確認する手動"><a class="anchor" href="#_4_2_9_event_qps_引数が_0_または適切なイベントキャプチャを確保するレベルに設定されていることを確認する手動"></a>4.2.9 <code>--event-qps</code> 引数が 0 または適切なイベントキャプチャを確保するレベルに設定されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubelet の設定ファイルを使用している場合は、ファイルを編集して <code>eventRecordQPS</code> を適切なレベルに設定します。
コマンドライン引数を使用している場合は、各ワーカーノードの kubelet サービスファイル
<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
以下のパラメータを <code>KUBELET_SYSTEM_PODS_ARGS</code> 変数に設定します。
システムに基づいて、kubelet サービスを再起動します。例えば：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl daemon-reload
systemctl restart kubelet.service</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/ps -fC containerd</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_10_tls_cert_file_および_tls_private_key_file_引数が適切に設定されていることを確認する手動"><a class="anchor" href="#_4_2_10_tls_cert_file_および_tls_private_key_file_引数が適切に設定されていることを確認する手動"></a>4.2.10 <code>--tls-cert-file</code> および <code>--tls-private-key-file</code> 引数が適切に設定されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 合格</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubelet の設定ファイルを使用している場合は、ファイルを編集して <code>tlsCertFile</code> をこの Kubelet を識別するために使用する証明書ファイルの場所に設定し、
<code>tlsPrivateKeyFile</code> を対応する秘密鍵ファイルの場所に設定します。
コマンドライン引数を使用している場合は、各ワーカーノードの kubelet サービスファイル
<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
以下のパラメータを <code>KUBELET_CERTIFICATE_ARGS</code> 変数に設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>--tls-cert-file=&lt;path/to/tls-certificate-file&gt;
--tls-private-key-file=&lt;path/to/tls-key-file&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>システムに基づいて、kubelet サービスを再起動します。例えば：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl daemon-reload
systemctl restart kubelet.service</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">journalctl -D /var/log/journal -u k3s | grep 'Running kubelet' | tail -n1</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>期待される結果:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">'--tls-cert-file' が存在し、'--tls-private-key-file' が存在する</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>返された値:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Sep 13 13:26:50 k3s-123-cis-pool2-98604672-hr9p5 k3s[1592]: time="2022-09-13T13:26:50Z" level=info msg="Running kubelet --address=0.0.0.0 --anonymous-auth=false --authentication-token-webhook=true --authorization-mode=Webhook --cgroup-driver=systemd --client-ca-file=/var/lib/rancher/k3s/agent/client-ca.crt --cloud-provider=external --cluster-dns=10.43.0.10 --cluster-domain=cluster.local --container-runtime-endpoint=unix:///run/k3s/containerd/containerd.sock --containerd=/run/k3s/containerd/containerd.sock --eviction-hard=imagefs.available&lt;5%,nodefs.available&lt;5% --eviction-minimum-reclaim=imagefs.available=10%,nodefs.available=10% --fail-swap-on=false --healthz-bind-address=127.0.0.1 --hostname-override=k3s-123-cis-pool2-98604672-hr9p5 --kubeconfig=/var/lib/rancher/k3s/agent/kubelet.kubeconfig --node-labels=rke.cattle.io/machine=00c4e7a0-5497-4367-a70c-0b836757eae8 --pod-infra-container-image=rancher/mirrored-pause:3.6 --pod-manifest-path=/var/lib/rancher/k3s/agent/pod-manifests --read-only-port=0 --resolv-conf=/run/systemd/resolve/resolv.conf --serialize-image-pulls=false --tls-cert-file=/var/lib/rancher/k3s/agent/serving-kubelet.crt --tls-private-key-file=/var/lib/rancher/k3s/agent/serving-kubelet.key" Sep 13 13:26:44 k3s-123-cis-pool3-b403f678-bzdg5 k3s[1600]: time="2022-09-13T13:26:44Z" level=info msg="Running kubelet --address=0.0.0.0 --anonymous-auth=false --authentication-token-webhook=true --authorization-mode=Webhook --cgroup-driver=systemd --client-ca-file=/var/lib/rancher/k3s/agent/client-ca.crt --cloud-provider=external --cluster-dns=10.43.0.10 --cluster-domain=cluster.local --container-runtime-endpoint=unix:///run/k3s/containerd/containerd.sock --containerd=/run/k3s/containerd/containerd.sock --eviction-hard=imagefs.available&lt;5%,nodefs.available&lt;5% --eviction-minimum-reclaim=imagefs.available=10%,nodefs.available=10% --fail-swap-on=false --healthz-bind-address=127.0.0.1 --hostname-override=k3s-123-cis-pool3-b403f678-bzdg5 --kubeconfig=/var/lib/rancher/k3s/agent/kubelet.kubeconfig --node-labels=rke.cattle.io/machine=109d596c-89f5-4c10-8c7f-6b82a38edd8f --pod-infra-container-image=rancher/mirrored-pause:3.6 --pod-manifest-path=/var/lib/rancher/k3s/agent/pod-manifests --read-only-port=0 --resolv-conf=/run/systemd/resolve/resolv.conf --serialize-image-pulls=false --tls-cert-file=/var/lib/rancher/k3s/agent/serving-kubelet.crt --tls-private-key-file=/var/lib/rancher/k3s/agent/serving-kubelet.key"</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_11_rotate_certificates_引数が_false_に設定されていないことを確認する自動"><a class="anchor" href="#_4_2_11_rotate_certificates_引数が_false_に設定されていないことを確認する自動"></a>4.2.11 <code>--rotate-certificates</code> 引数が <code>false</code> に設定されていないことを確認する（自動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubelet の設定ファイルを使用している場合は、ファイルを編集して <code>rotateCertificates</code> を <code>true</code> に設定するか、
デフォルト値を使用するために削除します。
コマンドライン引数を使用している場合は、各ワーカーノードの kubelet サービスファイル
<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
<code>KUBELET_CERTIFICATE_ARGS</code> 変数から <code>--rotate-certificates=false</code> 引数を削除します。
システムに基づいて、kubelet サービスを再起動します。例えば：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl daemon-reload
systemctl restart kubelet.service</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_12_rotatekubeletservercertificate_引数が_true_に設定されていることを確認する手動"><a class="anchor" href="#_4_2_12_rotatekubeletservercertificate_引数が_true_に設定されていることを確認する手動"></a>4.2.12 <code>RotateKubeletServerCertificate</code> 引数が <code>true</code> に設定されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 該当なし</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
各ワーカーノードの kubelet サービスファイル <code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
以下のパラメータを <code>KUBELET_CERTIFICATE_ARGS</code> 変数に設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>--feature-gates=RotateKubeletServerCertificate=true</pre>
</div>
</div>
<div class="paragraph">
<p>システムに基づいて、kubelet サービスを再起動します。例えば：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl daemon-reload
systemctl restart kubelet.service</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_2_13_kubelet_が強力な暗号化スイートのみを使用していることを確認する手動"><a class="anchor" href="#_4_2_13_kubelet_が強力な暗号化スイートのみを使用していることを確認する手動"></a>4.2.13 Kubelet が強力な暗号化スイートのみを使用していることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubelet の設定ファイルを使用している場合は、ファイルを編集して <code>TLSCipherSuites</code> を
<code>TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256</code>
またはこれらの値のサブセットに設定します。
実行可能な引数を使用している場合は、各ワーカーノードの kubelet サービスファイル
<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> を編集し、
以下のように <code>--tls-cipher-suites</code> パラメータを設定します。またはこれらの値のサブセットに設定します。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>--tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_256_GCM_SHA384,TLS_RSA_WITH_AES_128_GCM_SHA256</pre>
</div>
</div>
<div class="paragraph">
<p>システムに基づいて、kubelet サービスを再起動します。例えば：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl daemon-reload
systemctl restart kubelet.service</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>監査:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/bin/ps -fC containerd</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_1_rbac_とサービスアカウント"><a class="anchor" href="#_5_1_rbac_とサービスアカウント"></a>5.1 RBAC とサービスアカウント</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_5_1_1_cluster_admin_ロールが必要な場合にのみ使用されていることを確認する手動"><a class="anchor" href="#_5_1_1_cluster_admin_ロールが必要な場合にのみ使用されていることを確認する手動"></a>5.1.1 <code>cluster-admin</code> ロールが必要な場合にのみ使用されていることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
<code>cluster-admin</code> ロールへのすべての <code>clusterrolebinding</code> を特定します。それらが使用されているかどうか、
このロールが必要かどうか、またはより少ない権限のロールを使用できるかどうかを確認します。
可能な場合は、まずユーザーを低権限のロールにバインドし、その後 <code>cluster-admin</code> ロールへの <code>clusterrolebinding</code> を削除します：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete clusterrolebinding [name]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_5_1_2_シークレットへのアクセスを最小限に抑える手動"><a class="anchor" href="#_5_1_2_シークレットへのアクセスを最小限に抑える手動"></a>5.1.2 シークレットへのアクセスを最小限に抑える（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
可能な場合は、クラスター内のシークレットオブジェクトへの <code>get</code>、<code>list</code>、および <code>watch</code> アクセスを削除します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_1_3_ロールおよびクラスターロールでワイルドカードの使用を最小限に抑える手動"><a class="anchor" href="#_5_1_3_ロールおよびクラスターロールでワイルドカードの使用を最小限に抑える手動"></a>5.1.3 ロールおよびクラスターロールでワイルドカードの使用を最小限に抑える（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
可能な場合は、クラスターロールおよびロールでのワイルドカードの使用を特定のオブジェクトまたはアクションに置き換えます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_1_4_ポッドの作成アクセスを最小限に抑える手動"><a class="anchor" href="#_5_1_4_ポッドの作成アクセスを最小限に抑える手動"></a>5.1.4 ポッドの作成アクセスを最小限に抑える（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
可能な場合は、クラスター内のポッドオブジェクトへの作成アクセスを削除します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_1_5_デフォルトのサービスアカウントが積極的に使用されていないことを確認する手動"><a class="anchor" href="#_5_1_5_デフォルトのサービスアカウントが積極的に使用されていないことを確認する手動"></a>5.1.5 デフォルトのサービスアカウントが積極的に使用されていないことを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetes ワークロードが Kubernetes API サーバーへの特定のアクセスを必要とする場合は、明示的なサービスアカウントを作成します。
各デフォルトのサービスアカウントの設定を変更して、この値を含めます：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">automountServiceAccountToken: false</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_5_1_6_サービスアカウントトークンが必要な場合にのみマウントされることを確認する手動"><a class="anchor" href="#_5_1_6_サービスアカウントトークンが必要な場合にのみマウントされることを確認する手動"></a>5.1.6 サービスアカウントトークンが必要な場合にのみマウントされることを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
サービスアカウントトークンをマウントする必要がないポッドおよびサービスアカウントの定義を変更して無効にします。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_1_7_systemmasters_グループの使用を避ける手動"><a class="anchor" href="#_5_1_7_systemmasters_グループの使用を避ける手動"></a>5.1.7 <code>system:masters</code> グループの使用を避ける（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
クラスター内のすべてのユーザーから <code>system:masters</code> グループを削除します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_1_8_kubernetes_クラスター内での_bindimpersonateおよび_escalate_権限の使用を制限する手動"><a class="anchor" href="#_5_1_8_kubernetes_クラスター内での_bindimpersonateおよび_escalate_権限の使用を制限する手動"></a>5.1.8 Kubernetes クラスター内での <code>Bind</code>、<code>Impersonate</code>、および <code>Escalate</code> 権限の使用を制限する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
可能な場合は、<code>impersonate</code>、<code>bind</code>、および <code>escalate</code> 権限をサブジェクトから削除します。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_2_ポッドセキュリティ基準"><a class="anchor" href="#_5_2_ポッドセキュリティ基準"></a>5.2 ポッドセキュリティ基準</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_5_2_1_クラスターに少なくとも1つのアクティブなポリシー制御メカニズムが存在することを確認する手動"><a class="anchor" href="#_5_2_1_クラスターに少なくとも1つのアクティブなポリシー制御メカニズムが存在することを確認する手動"></a>5.2.1 クラスターに少なくとも1つのアクティブなポリシー制御メカニズムが存在することを確認する（手動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ユーザーワークロードを含むすべてのネームスペースに対して、Pod Security Admission または外部ポリシー制御システムが存在することを確認します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_2_特権コンテナの許可を最小限に抑える自動"><a class="anchor" href="#_5_2_2_特権コンテナの許可を最小限に抑える自動"></a>5.2.2 特権コンテナの許可を最小限に抑える（自動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ユーザーワークロードを含むクラスター内の各ネームスペースにポリシーを追加して、
特権コンテナの許可を制限します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_3_ホストプロセスidネームスペースを共有しようとするコンテナの許可を最小限に抑える自動"><a class="anchor" href="#_5_2_3_ホストプロセスidネームスペースを共有しようとするコンテナの許可を最小限に抑える自動"></a>5.2.3 ホストプロセスIDネームスペースを共有しようとするコンテナの許可を最小限に抑える（自動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ユーザーワークロードを含むクラスター内の各ネームスペースにポリシーを追加して、
<code>hostPID</code> コンテナの許可を制限します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_4_ホストipcネームスペースを共有しようとするコンテナの許可を最小限に抑える自動"><a class="anchor" href="#_5_2_4_ホストipcネームスペースを共有しようとするコンテナの許可を最小限に抑える自動"></a>5.2.4 ホストIPCネームスペースを共有しようとするコンテナの許可を最小限に抑える（自動）</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ユーザーワークロードを含むクラスター内の各ネームスペースにポリシーを追加して、
<code>hostIPC</code> コンテナの許可を制限します。
<strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>hostIPC</code>コンテナのアドミッションを制限します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_5_ホストネットワークネームスペースを共有しようとするコンテナのアドミッションを最小限に抑える_自動化"><a class="anchor" href="#_5_2_5_ホストネットワークネームスペースを共有しようとするコンテナのアドミッションを最小限に抑える_自動化"></a>5.2.5 ホストネットワークネームスペースを共有しようとするコンテナのアドミッションを最小限に抑える (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>hostNetwork</code>コンテナのアドミッションを制限します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_6_allowprivilegeescalationを持つコンテナのアドミッションを最小限に抑える_自動化"><a class="anchor" href="#_5_2_6_allowprivilegeescalationを持つコンテナのアドミッションを最小限に抑える_自動化"></a>5.2.6 allowPrivilegeEscalationを持つコンテナのアドミッションを最小限に抑える (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>.spec.allowPrivilegeEscalation</code>が<code>true</code>に設定されているコンテナのアドミッションを制限します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_7_ルートコンテナのアドミッションを最小限に抑える_自動化"><a class="anchor" href="#_5_2_7_ルートコンテナのアドミッションを最小限に抑える_自動化"></a>5.2.7 ルートコンテナのアドミッションを最小限に抑える (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
クラスター内の各ネームスペースにポリシーを作成し、<code>MustRunAsNonRoot</code>またはUIDの範囲に0を含まない<code>MustRunAs</code>が設定されていることを確認します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_8_net_raw機能を持つコンテナのアドミッションを最小限に抑える_自動化"><a class="anchor" href="#_5_2_8_net_raw機能を持つコンテナのアドミッションを最小限に抑える_自動化"></a>5.2.8 NET_RAW機能を持つコンテナのアドミッションを最小限に抑える (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>NET_RAW</code>機能を持つコンテナのアドミッションを制限します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_9_追加された機能を持つコンテナのアドミッションを最小限に抑える_自動化"><a class="anchor" href="#_5_2_9_追加された機能を持つコンテナのアドミッションを最小限に抑える_自動化"></a>5.2.9 追加された機能を持つコンテナのアドミッションを最小限に抑える (自動化)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
<code>allowedCapabilities</code>が空の配列に設定されていない限り、クラスターのポリシーに存在しないことを確認します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_10_機能が割り当てられたコンテナのアドミッションを最小限に抑える_手動"><a class="anchor" href="#_5_2_10_機能が割り当てられたコンテナのアドミッションを最小限に抑える_手動"></a>5.2.10 機能が割り当てられたコンテナのアドミッションを最小限に抑える (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
クラスター上で実行されているアプリケーションの機能の使用を確認します。ネームスペースにLinux機能を必要としないアプリケーションが含まれている場合、すべての機能を削除しないコンテナのアドミッションを禁止するPSPを追加することを検討します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_11_windows_hostprocessコンテナのアドミッションを最小限に抑える_手動"><a class="anchor" href="#_5_2_11_windows_hostprocessコンテナのアドミッションを最小限に抑える_手動"></a>5.2.11 Windows HostProcessコンテナのアドミッションを最小限に抑える (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>.securityContext.windowsOptions.hostProcess</code>が<code>true</code>に設定されているコンテナのアドミッションを制限します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_12_hostpathボリュームのアドミッションを最小限に抑える_手動"><a class="anchor" href="#_5_2_12_hostpathボリュームのアドミッションを最小限に抑える_手動"></a>5.2.12 HostPathボリュームのアドミッションを最小限に抑える (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>hostPath</code>ボリュームを持つコンテナのアドミッションを制限します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_2_13_hostportsを使用するコンテナのアドミッションを最小限に抑える_手動"><a class="anchor" href="#_5_2_13_hostportsを使用するコンテナのアドミッションを最小限に抑える_手動"></a>5.2.13 HostPortsを使用するコンテナのアドミッションを最小限に抑える (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ユーザーのワークロードがあるクラスター内の各ネームスペースにポリシーを追加し、<code>hostPort</code>セクションを使用するコンテナのアドミッションを制限します。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_3_ネットワークポリシーとcni"><a class="anchor" href="#_5_3_ネットワークポリシーとcni"></a>5.3 ネットワークポリシーとCNI</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_5_3_1_使用中のcniがネットワークポリシーをサポートしていることを確認する_手動"><a class="anchor" href="#_5_3_1_使用中のcniがネットワークポリシーをサポートしていることを確認する_手動"></a>5.3.1 使用中のCNIがネットワークポリシーをサポートしていることを確認する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
使用中のCNIプラグインがネットワークポリシーをサポートしていない場合、別のプラグインを使用するか、Kubernetesクラスター内のトラフィックを制限するための代替メカニズムを検討します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_3_2_すべてのネームスペースにネットワークポリシーが定義されていることを確認する_手動"><a class="anchor" href="#_5_3_2_すべてのネームスペースにネットワークポリシーが定義されていることを確認する_手動"></a>5.3.2 すべてのネームスペースにネットワークポリシーが定義されていることを確認する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ドキュメントに従い、必要に応じてNetworkPolicyオブジェクトを作成します。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_4_シークレット管理"><a class="anchor" href="#_5_4_シークレット管理"></a>5.4 シークレット管理</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_5_4_1_環境変数としてのシークレットよりもファイルとしてのシークレットを使用することを推奨する_手動"><a class="anchor" href="#_5_4_1_環境変数としてのシークレットよりもファイルとしてのシークレットを使用することを推奨する_手動"></a>5.4.1 環境変数としてのシークレットよりもファイルとしてのシークレットを使用することを推奨する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
可能であれば、アプリケーションコードを変更して、環境変数ではなくマウントされたシークレットファイルからシークレットを読み取るようにします。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_4_2_外部シークレットストレージを検討する_手動"><a class="anchor" href="#_5_4_2_外部シークレットストレージを検討する_手動"></a>5.4.2 外部シークレットストレージを検討する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
クラウドプロバイダーやサードパーティのシークレット管理ソリューションが提供するシークレット管理オプションを参照します。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_5_拡張可能なアドミッションコントロール"><a class="anchor" href="#_5_5_拡張可能なアドミッションコントロール"></a>5.5 拡張可能なアドミッションコントロール</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_5_5_1_imagepolicywebhookアドミッションコントローラーを使用してイメージの出所を設定する_手動"><a class="anchor" href="#_5_5_1_imagepolicywebhookアドミッションコントローラーを使用してイメージの出所を設定する_手動"></a>5.5.1 ImagePolicyWebhookアドミッションコントローラーを使用してイメージの出所を設定する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、イメージの出所を設定します。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_5_7_一般的なポリシー"><a class="anchor" href="#_5_7_一般的なポリシー"></a>5.7 一般的なポリシー</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_5_7_1_ネームスペースを使用してリソース間に管理境界を作成する_手動"><a class="anchor" href="#_5_7_1_ネームスペースを使用してリソース間に管理境界を作成する_手動"></a>5.7.1 ネームスペースを使用してリソース間に管理境界を作成する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
ドキュメントに従い、デプロイメント内のオブジェクトに必要なネームスペースを作成します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_7_2_pod定義でseccompプロファイルがdockerdefaultに設定されていることを確認する_手動"><a class="anchor" href="#_5_7_2_pod定義でseccompプロファイルがdockerdefaultに設定されていることを確認する_手動"></a>5.7.2 Pod定義でseccompプロファイルがdocker/defaultに設定されていることを確認する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
<code>securityContext</code>を使用して、Pod定義でdocker/default seccompプロファイルを有効にします。以下はその例です：
 securityContext:
 seccompProfile:
 type: RuntimeDefault</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_7_3_podおよびコンテナにsecuritycontextを適用する_手動"><a class="anchor" href="#_5_7_3_podおよびコンテナにsecuritycontextを適用する_手動"></a>5.7.3 PodおよびコンテナにSecurityContextを適用する (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetesのドキュメントに従い、PodにSecurityContextを適用します。推奨されるSecurityContextのリストについては、CIS Security Benchmark for Docker Containersを参照してください。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_7_4_デフォルトのネームスペースは使用しない_手動"><a class="anchor" href="#_5_7_4_デフォルトのネームスペースは使用しない_手動"></a>5.7.4 デフォルトのネームスペースは使用しない (手動)</h3>
<div class="paragraph">
<p><strong>結果:</strong> 警告</p>
</div>
<div class="paragraph">
<p><strong>修正方法:</strong>
Kubernetesリソースの適切な分離を可能にするためにネームスペースが作成されていることを確認し、すべての新しいリソースが特定のネームスペースに作成されるようにします。</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/vendor/lunr-languages.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
<script src="../../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../../_/js/vendor/tabs.js"></script>


  </body>
</html>
