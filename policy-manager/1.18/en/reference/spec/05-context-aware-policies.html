<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Context aware policies :: Rancher product documentation</title>
    <link rel="canonical" href="https://documentation.suse.com/cloudnative/policy-manager/1.22/en/reference/spec/05-context-aware-policies.html">
    <link rel="prev" href="04-mutating-policies.html">
    <link rel="next" href="host-capabilities/01-intro-host-capabilities.html">
    <meta name="description" content="Context aware policies.">
    <meta name="keywords" content="["kubewarden", "kubernetes", "policy specification", "context aware policies"]">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../../_/css/search.css">
<link rel="icon" href="../../../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../../../_/css/vendor/light.css">
<!-- <script src="/docserv/res/lightheaded/analytics.js"
        type="text/javascript"></script> -->
    <script>var uiRootPath = '../../../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a class=" navbar-logo" href="https://documentation.suse.com/" aria-label="SUSE Documentation Home"><img class="logo"
            src="../../../../../_/img/logo.svg" alt="SUSE logo"/></a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">
            <img src="../../../../../_/img/resources.png" class="langIcon Resurces" alt="Resources" title="Resources">
          </div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/rancher/kubewarden-product-docs"><i class="fab fa-github"></i>&nbsp;Policy Manager</a>
            <div class="has-submenu">
              <a class="navbar-item" href="#" ><i class="fas fa-file-alt"></i>&nbsp;Report Issue &nbsp;<i class="fas fa-chevron-right"></i></a>
              <div class="submenu">
                <a class="navbar-item" href="https://scc.suse.com">SCC (Recommended)</a>
                <a class="navbar-item" href="https://github.com/rancher/kubewarden-product-docs/issues">GitHub Issue</a>
              </div>
            </div>
            <a class="navbar-item" href="https://github.com/rancher/product-docs-playbook/blob/main/CONTRIBUTING.md"><i class="fas fa-user-edit"></i>&nbsp;Contribute</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link"><img src="../../../../../_/img/language.png" class="langIcon Language" alt="Language"
              title="Language"></div>
          <div class="navbar-dropdown">
            <!--  </div><div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div> -->
              <a role="button" class="navbar-item" id="en" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../../_/img/engFlag.svg" class="langIcon english">-->
                &nbsp;English
              </a>
            <!-- LANGUAGESELECTOR -->
          </div>
        </div>
        <!--
        <div class="navbar-item">
          <a href="https://twitter.com/SUSE">
            <img alt="X-logo" class="x-logo" src="../../../../../_/img/x-logo-white.png">
          </a>
        </div>
        -->
      </div>
    </div>

    <!--   <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
      </div> -->
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="policy-manager" data-version="1.18">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../introduction.html">Policy Manager</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../quick-start.html">Quick start</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Tutorials</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../tutorials/writing-policies/index.html">Writing Kubewarden policies</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../tutorials/writing-policies/CEL/01-intro-cel.html">Introduction to CEL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/CEL/02-reusing-vap.html">Reusing ValidatingAdmissionPolicies</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/CEL/03-context-aware.html">Context-aware CEL policies</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/CEL/04-example-sigstore.html">Sigstore host capabilities</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../tutorials/writing-policies/rust/01-intro-rust.html">Rust</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/rust/02-create-policy.html">Creating a policy</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/rust/03-define-policy-settings.html">Defining policy settings</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/rust/04-write-validation-logic.html">Writing validation logic</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/rust/05-mutation-policy.html">Creating a new mutation policy</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/rust/06-logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/rust/07-build-and-distribute.html">Building and distributing policies</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/rust/08-raw-policies.html">Raw policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../tutorials/writing-policies/go/01-intro-go.html">Writing policies in Go</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/go/02-scaffold.html">Creating a new validation policy</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/go/03-policy-settings.html">Defining policy settings</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/go/04-validation.html">Writing the validation logic</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/go/05-e2e-tests.html">End-to-end testing</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/go/06-logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/go/07-automate.html">Integrating with GitHub Actions</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/go/08-distribute.html">Distributing policy</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/go/09-validation-with-queries.html">Validation using JSON queries</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/go/10-raw-policies.html">Writing raw policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../tutorials/writing-policies/rego/01-intro-rego.html">Rego</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/rego/02-builtin-support.html">Builtin support</a>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Open Policy Agent</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../tutorials/writing-policies/rego/open-policy-agent/01-intro.html">Introduction to Open Policy Agent</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../tutorials/writing-policies/rego/open-policy-agent/02-create-policy.html">Creating a new policy</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../tutorials/writing-policies/rego/open-policy-agent/03-build-and-run.html">Build and run a OPA policy for Kubewarden</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../tutorials/writing-policies/rego/open-policy-agent/04-distribute.html">Distributing an OPA policy with Kubewarden</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../tutorials/writing-policies/rego/open-policy-agent/05-raw-policies.html">Writing raw policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="4">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Gatekeeper</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../tutorials/writing-policies/rego/gatekeeper/01-intro.html">Gatekeeper support</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../tutorials/writing-policies/rego/gatekeeper/02-create-policy.html">Creating a new Gatekeeper Rego policy</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../tutorials/writing-policies/rego/gatekeeper/03-build-and-run.html">Build and run a Gatekeeper policy</a>
  </li>
  <li class="nav-item" data-depth="5">
    <a class="nav-link" href="../../tutorials/writing-policies/rego/gatekeeper/04-distribute.html">Distributing a Gatekeeper policy with Kubewarden</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tutorials/writing-policies/dotnet.html">C#</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tutorials/writing-policies/swift.html">Swift</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tutorials/writing-policies/typescript.html">Typescript</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tutorials/writing-policies/other-languages.html">Other languages</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">WASI</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/wasi/01-intro-wasi.html">WASI</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../tutorials/writing-policies/wasi/02-raw-policies.html">Writing raw policies</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tutorials/writing-policies/metadata.html">Policy metadata</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Testing policies</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tutorials/testing-policies/index.html">Policy testing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tutorials/testing-policies/02-policy-authors.html">Testing for policy authors</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tutorials/testing-policies/03-cluster-operators.html">Testing for cluster operators</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../tutorials/verifying-kubewarden.html">Verifying Kubewarden</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../tutorials/publish-policy-to-artifact-hub.html">Publish policies to Artifact Hub</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Explanations</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../explanations/mutating-policies.html">Mutating policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../explanations/context-aware-policies.html">Context aware policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../explanations/policy-groups.html">Policy Groups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../explanations/certificates.html">Certificate rotation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../explanations/distributing-policies.html">Distributing policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Comparisons</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../explanations/comparisons/opa-comparison.html">Kubewarden vs OPA Gatekeeper</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../explanations/audit-scanner/audit-scanner.html">What is the Audit Scanner?</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../explanations/audit-scanner/limitations.html">Audit Scanner - Limitations</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../explanations/audit-scanner/policy-reports.html">Audit Scanner - Policy Reports</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../explanations/architecture.html">Admission Policy Manager architecture</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Howtos</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/tasks.html">Common tasks</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/psp-migration.html">PodSecurityPolicy migration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/pod-security-admission-with-kubewarden.html">Using Pod Security Admission with Kubewarden</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/policy-groups.html">How to use policy groups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/vap-migration.html">ValidatingAdmissionPolicy migration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/secure-supply-chain.html">Secure supply chain</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/custom-certificate-authorities.html">Custom certificate authorities</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/raw-policies.html">Raw policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/audit-scanner.html">Audit Scanner</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Configuring Policy Servers</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/policy-servers/01-custom-cas.html">Using custom certificate authorities</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/policy-servers/02-private-registry.html">Configuring PolicyServers to use private registries</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/policy-servers/03-production-deployments.html">Configuring PolicyServers for production</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/policies.html">Configuring policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Airgap</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/airgap/01-requirements.html">Requirements for a Kubewarden air gap installation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/airgap/02-install.html">Air gap installation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Rancher UI extension</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/ui-extension/01-install.html">Rancher UI extension quickstart</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/ui-extension/02-metrics.html">Monitoring</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/ui-extension/03-tracing.html">Tracing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Telemetry quick starts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/telemetry/20-tracing-qs.html">Tracing quickstart</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/telemetry/30-metrics-qs.html">Metrics quickstart</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/telemetry/10-opentelemetry-qs.html">Open Telemetry quick start</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../howtos/Rancher-Fleet.html">Managing Kubewarden with Rancher Fleet</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../howtos/contribution-guide/contribution-guide.html">Contribution guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/contribution-guide/contributing.html">Contributing to Kubewarden documentation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../howtos/contribution-guide/suggesting-an-improvement.html">Suggesting a doc improvement</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../CRDs.html">Custom Resource Definitions (CRD)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../dependency-matrix.html">Dependency matrix</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrade-path.html">Upgrade path</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../metrics-reference.html">Metrics reference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../monitor-mode.html">Monitor mode</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Policy specification</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="01-intro-spec.html">Policy communication specification</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="02-settings.html">Policy settings</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="03-validating-policies.html">Validating policies</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="04-mutating-policies.html">Mutating policies</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="05-context-aware-policies.html">Context aware policies</a>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Host capabilities</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="host-capabilities/01-intro-host-capabilities.html">Host capabilities specification</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="host-capabilities/02-signature-verifier-policies.html">Signature verifier policies</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="host-capabilities/03-container-registry.html">Container registry capabilities</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="host-capabilities/04-net.html">Network capabilities</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="host-capabilities/05-crypto.html">Cryptographic capabilities</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="host-capabilities/06-kubernetes.html">Kubernetes capabilities</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../oci-registries-support.html">OCI registry support for Kubewarden</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../threat-model.html">Threat Model</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../policy-evaluation-timeout.html">Policy evaluation timeout protection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../verification-config.html">Verification configuration format</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../sources_yaml.html">Reference for sources.yaml</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../disclosure.html">Security disclosure</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Policy Manager</span>
    <span class="version">1.18</span>
  </div>
  <ul class="components">
        <li class="component">
          <div class="title"><a href="../../../../../cluster-api/v0.16/en/index.html">Cluster API</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../../cluster-api/v0.16/en/index.html">0.16</a>
            </li>
            <li class="version">
              <a href="../../../../../cluster-api/v0.15/en/index.html">0.15</a>
            </li>
            <li class="version">
              <a href="../../../../../cluster-api/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../../../cluster-api/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../../../cluster-api/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../../../cluster-api/v0.11/en/index.html">0.11</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../../continuous-delivery/v0.11/en/index.html">Continuous Delivery</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../../continuous-delivery/v0.11/en/index.html">0.11</a>
            </li>
            <li class="version">
              <a href="../../../../../continuous-delivery/v0.10/en/index.html">0.10</a>
            </li>
            <li class="version">
              <a href="../../../../../continuous-delivery/v0.9/en/index.html">0.9</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../../k3s/latest/en/introduction.html">K3s</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../../k3s/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../../os-manager/1.6/en/index.html">OS Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../../os-manager/1.6/en/index.html">1.6</a>
            </li>
            <li class="version">
              <a href="../../../../../os-manager/1.5/en/index.html">1.5</a>
            </li>
          </ul>
        </li>
        <li class="component is-current">
          <div class="title"><a href="../../../../1.22/en/introduction.html">Policy Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../1.22/en/introduction.html">1.22-next</a>
            </li>
            <li class="version">
              <a href="../../../../1.21/en/introduction.html">1.21</a>
            </li>
            <li class="version">
              <a href="../../../../1.20/en/introduction.html">1.20</a>
            </li>
            <li class="version">
              <a href="../../../../1.19/en/introduction.html">1.19</a>
            </li>
            <li class="version is-current">
              <a href="../../introduction.html">1.18</a>
            </li>
            <li class="version">
              <a href="../../../../1.17/en/introduction.html">1.17</a>
            </li>
            <li class="version">
              <a href="../../../../1.16/en/introduction.html">1.16</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../../rke2/latest/en/introduction.html">RKE2</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../../rke2/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">SUSE® Rancher Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../../../rancher-manager/v2.10/en/about-rancher/what-is-rancher.html">v2.10</a>
            </li>
            <li class="version">
              <a href="../../../../../rancher-manager/v2.9/en/about-rancher/what-is-rancher.html">v2.9</a>
            </li>
            <li class="version">
              <a href="../../../../../rancher-manager/v2.8/en/about-rancher/what-is-rancher.html">v2.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../../security/5.4/en/overview.html">SUSE® Security</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../../security/5.4/en/overview.html">5.4</a>
            </li>
            <li class="version">
              <a href="../../../../../security/5.3/en/overview.html">5.3</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../../storage/1.9.0/en/longhorn-documentation.html">SUSE® Storage</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../../storage/1.9.0/en/longhorn-documentation.html">1.9.0 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../../storage/1.8.0/en/longhorn-documentation.html">1.8.0 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../../storage/1.7.0/en/longhorn-documentation.html">1.7.0</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../../virtualization/v1.5/en/introduction/overview.html">SUSE® Virtualization</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../../virtualization/v1.5/en/introduction/overview.html">v1.5 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../../virtualization/v1.4/en/introduction/overview.html">v1.4 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../../virtualization/v1.3/en/introduction/overview.html">v1.3</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html" aria-label="Home" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../introduction.html">Policy Manager</a></li>
    <li>Reference</li>
    <li>Policy specification</li>
    <li><a href="05-context-aware-policies.html">Context aware policies</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">1.18</button>
  <div class="version-menu">
    <a class="version" href="../../../../1.22/en/reference/spec/05-context-aware-policies.html">1.22-next</a>
    <a class="version" href="../../../../1.21/en/reference/spec/05-context-aware-policies.html">1.21</a>
    <a class="version" href="../../../../1.20/en/reference/spec/05-context-aware-policies.html">1.20</a>
    <a class="version" href="../../../../1.19/en/reference/spec/05-context-aware-policies.html">1.19</a>
    <a class="version is-current" href="05-context-aware-policies.html">1.18</a>
    <a class="version" href="../../../../1.17/en/reference/spec/05-context-aware-policies.html">1.17</a>
    <a class="version" href="../../../../1.16/en/reference/spec/05-context-aware-policies.html">1.16</a>
  </div>
</div>
  <div class="edit-this-page"><a href="https://github.com/rancher/kubewarden-product-docs/edit/main/docs/version-1.18/modules/en/pages/reference/spec/05-context-aware-policies.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Context aware policies</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The <code>policy-server</code> has the capability to expose cluster information to
policies,
so that they can take decisions based on other existing resources,
and not only based on the details provided by the admission request.</p>
</div>
<div class="paragraph">
<p>The retrieval of Kubernetes resources is performed by the Policy Server hosting the policy.
Access to Kubernetes is regulated by RBAC rules applied to the Service Account used by the Policy Server.</p>
</div>
<div class="paragraph">
<p>The <code>default</code> Policy Server deployed by Kubewarden helm charts has access to the following Kubernetes resources:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Namespaces</p>
</li>
<li>
<p>Services</p>
</li>
<li>
<p>Ingresses</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The policy server performs caching of the results obtained from the Kubernetes API server to reduce the amount of load on this core part of Kubernetes.
That means some information might be stale or missing.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_support_matrix"><a class="anchor" href="#_support_matrix"></a>Support matrix</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Policy type</th>
<th class="tableblock halign-center valign-top">Support</th>
<th class="tableblock halign-left valign-top">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Traditional programming languages</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✅</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rego</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✅</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Since Kubewarden 1.9 release</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WASI</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">✅</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Since Kubewarden 1.10.0 release, only for Go SDK</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_constraints"><a class="anchor" href="#_constraints"></a>Constraints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kubewarden&#8217;s priority is to reduce the number of queries done against the Kubernetes API server. Because of that two constraints have to be
considered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Memory usage: data fetched from Kubernetes is cached in memory by the Policy Server process. The more data is fetched, the more memory is going
to be consumed by the Policy Server Pods.</p>
</li>
<li>
<p>Consistency: the cache kept by Policy Server could contain stale data. New resources might be missing, deleted resources might still be
available and changed ones could have old data. This could affect policy evaluation.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_listing_multiple_resources"><a class="anchor" href="#_listing_multiple_resources"></a>Listing multiple resources</h3>
<div class="paragraph">
<p>Kubewarden policies can fetch multiple resources at the same time. For example, they can make a query like
"get all the Pods defined inside of the <code>default</code> namespace that have the label <code>color</code> set to <code>green</code>".</p>
</div>
<div class="paragraph">
<p>When such a query is done, the Policy Server fetches all the resources matching the user criteria. Resources are fetched in batches to reduce the
load on the Kubernetes API server.
Before storing the resources in memory, the <code>managedFields</code> attribute of each resource is dropped to reduce the amount of memory consumed.
This attribute is not useful for policies and takes a significant amount of memory.</p>
</div>
<div class="paragraph">
<p>The Policy Server then creates a <a href="https://kubernetes.io/docs/reference/using-api/api-concepts/#efficient-detection-of-changes">Kubernetes watch</a> to keep
the cached list of objects updated.
The Policy Server doesn&#8217;t control the speed at which the Kubernetes API Server sends notifications about resource changes. This depends on different external
factors, like the number of watches created against the Kubernetes API server and its load.</p>
</div>
<div class="paragraph">
<p>Finally, the current code suffers from the following limitation. Given these two queries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kubectl get pods -n default</code></p>
</li>
<li>
<p><code>kubectl get pods -n default -l color=green</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Policy Server will create two watches and will duplicate all the Pods of the second query.
We will work to remove this limitation in future releases of Kubewarden.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fetching_a_specific_resource"><a class="anchor" href="#_fetching_a_specific_resource"></a>Fetching a specific resource</h3>
<div class="paragraph">
<p>Kubewarden policies can get a specific resource defined inside of the cluster. For example, they can make a query like
"get the Pod named <code>psql-0</code> defined inside of the <code>db</code> namespace".</p>
</div>
<div class="paragraph">
<p>By default this query fetches the object and stores it inside of an in-memory cache. The cache entry is wiped after 5 seconds.
During this time window, the cached data is served to policies.</p>
</div>
<div class="paragraph">
<p>The policy author can also decide to make a direct query, one that skips the cache entirely. In this way, fresh data is always
served. This however can cause more load on the Kubernetes API server (depending on how frequently the policy is triggered)
and introduces more latency when evaluating an admission request.</p>
</div>
<div class="paragraph">
<p>The direct/cached query behavior can be configured on a per-query level by the policy author using the Kubewarden SDKs.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clusteradmissionpolicies"><a class="anchor" href="#_clusteradmissionpolicies"></a>ClusterAdmissionPolicies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ClusterAdmissionPolicies have the field
<a href="https://doc.crds.dev/github.com/kubewarden/kubewarden-controller/policies.kubewarden.io/ClusterAdmissionPolicy/v1#spec-contextAwareResources">spec.contextAwareResources</a>.
This field provides a list a <code>GroupVersionKind</code> resources that the policy needs to access.
This allows policy writers to ship the "permissions" that the policy needs together with the policy.
Moreover, this allows policy operators to review the "permissions" needed by the policy at deployment time.</p>
</div>
<div class="sect2">
<h3 id="_testing_context_aware_policies_locally"><a class="anchor" href="#_testing_context_aware_policies_locally"></a>Testing context aware policies locally</h3>
<div class="paragraph">
<p>As well as running policies in a cluster for end-to-end tests,
you can use the <code>kwctl</code> CLI utility to run policies and mock requests against the cluster.</p>
</div>
<div class="paragraph">
<p>For this, <code>kwctl run</code> can first record all the interactions with the cluster into a file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">kwctl run \
    --allow-context-aware \
    -r request.json \
    --record-host-capabilities-interactions replay-session.yml \
    annotated-policy.wasm</code></pre>
</div>
</div>
<div class="paragraph">
<p>which creates the following <code>replay-session.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># replay-session.yml
---
- type: Exchange
  request: |
    !KubernetesGetResource
    api_version: /v1
    kind: Pod
    name: p-testing
    namespace: local
    disable_cache: true
  response:
    type: Success
    payload: '{"apiVersion":"","kind":"Pod", &lt;snipped&gt; }'</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the replay session,
you can now simulate the cluster interactions without the need of a cluster,
which is ideal for CI and end-to-end tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">kwctl run \
    --allow-context-aware \
    -r request.json \
    --replay-host-capabilities-interactions replay-session.yml \
    annotated-policy.wasm</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_language_sdks"><a class="anchor" href="#_language_sdks"></a>Language SDKs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Language SDK&#8217;s that support cluster context at the moment expose functions that allow policies to retrieve the current state of the cluster.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you want more information about the waPC function used by the SDKs, check the <a href="host-capabilities/06-kubernetes.html" class="xref page">Kubernetes capabilities</a> reference documentation.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_rust"><a class="anchor" href="#_rust"></a>Rust</h3>
<div class="paragraph">
<p>See the functions exposing this functionality at the <a href="https://docs.rs/kubewarden-policy-sdk/0.8.7/kubewarden_policy_sdk">Rust SDK reference docs</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_go"><a class="anchor" href="#_go"></a>Go</h3>
<div class="paragraph">
<p>See the functions exposing this functionality at the <a href="https://pkg.go.dev/github.com/kubewarden/policy-sdk-go">Go SDK reference docs</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rego_policies"><a class="anchor" href="#_rego_policies"></a>Rego policies</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_gatekeeper"><a class="anchor" href="#_gatekeeper"></a>Gatekeeper</h3>
<div class="paragraph">
<p>The context aware information is exposed under the <code>data.inventory</code> key, like Gatekeeper does.</p>
</div>
<div class="paragraph">
<p>The inventory is populated with the resources the policy has been granted access to via the <code>spec.contextAwareResources</code> field.</p>
</div>
</div>
<div class="sect2">
<h3 id="_open_policy_agent"><a class="anchor" href="#_open_policy_agent"></a>Open Policy Agent</h3>
<div class="paragraph">
<p>The context aware information is exposed under the <code>data.kubernetes</code> key,
like
<a href="https://github.com/open-policy-agent/kube-mgmt"><code>kube-mgmt</code></a>
does by default.</p>
</div>
<div class="paragraph">
<p>The inventory is populated with the resources the policy has been granted access to via the <code>spec.contextAwareResources</code> field.</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="04-mutating-policies.html">Mutating policies</a></span>
  <span class="next"><a href="host-capabilities/01-intro-host-capabilities.html">Host capabilities specification</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../../../_/js/site.js"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../_/js/vendor/lunr-languages.js"></script>
<script src="../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../.." data-snippet-length="100" data-stylesheet="../../../../../_/css/search.css"></script>
<script async src="../../../../../search-index.js"></script>
<script src="../../../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../../../_/js/vendor/tabs.js"></script>


  </body>
</html>
