<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Advanced Options and Configuration :: Rancher product documentation</title>
    <link rel="canonical" href="https://documentation.suse.com/cloudnative/rke2/latest/en/advanced.html">
    <link rel="prev" href="helm.html">
    <link rel="next" href="reference/cli_tools.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../_/css/site.css">
<link rel="stylesheet" href="../../../_/css/search.css">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../_/css/vendor/light.css">
<!-- <script src="/docserv/res/lightheaded/analytics.js"
        type="text/javascript"></script> -->
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a class=" navbar-logo" href="https://documentation.suse.com/" aria-label="SUSE Documentation Home"><img class="logo"
            src="../../../_/img/logo.svg" alt="SUSE logo"/></a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">
            <img src="../../../_/img/resources.png" class="langIcon Resurces" alt="Resources" title="Resources">
          </div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/rancher/rke2-product-docs"><i class="fab fa-github"></i>&nbsp;RKE2</a>
            <div class="has-submenu">
              <a class="navbar-item" href="#" ><i class="fas fa-file-alt"></i>&nbsp;Report Issue &nbsp;<i class="fas fa-chevron-right"></i></a>
              <div class="submenu">
                <a class="navbar-item" href="https://scc.suse.com">SCC (Recommended)</a>
                <a class="navbar-item" href="https://github.com/rancher/rke2-product-docs/issues">GitHub Issue</a>
              </div>
            </div>
            <a class="navbar-item" href="https://github.com/rancher/product-docs-playbook/blob/main/CONTRIBUTING.md"><i class="fas fa-user-edit"></i>&nbsp;Contribute</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link"><img src="../../../_/img/language.png" class="langIcon Language" alt="Language"
              title="Language"></div>
          <div class="navbar-dropdown">
            <!--  </div><div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div> -->
              <a role="button" class="navbar-item" id="en" onclick="selectLanguage(this.id)">
                <!--<img src="../../../_/img/engFlag.svg" class="langIcon english">-->
                &nbsp;English
              </a>
              <a role="button" class="navbar-item" id="zh" onclick="selectLanguage(this.id)">
                <!--<img src="../../../_/img/china.svg" class="langIcon china">-->
                &nbsp;中文
              </a>
            <!-- LANGUAGESELECTOR -->
          </div>
        </div>
        <!--
        <div class="navbar-item">
          <a href="https://twitter.com/SUSE">
            <img alt="X-logo" class="x-logo" src="../../../_/img/x-logo-white.png">
          </a>
        </div>
        -->
      </div>
    </div>

    <!--   <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
      </div> -->
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rke2" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="introduction.html">RKE2</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Installation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="install/quickstart.html">Quick Start</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="install/requirements.html">Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="install/configuration.html">Configuration Options</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="install/ha.html">High Availability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="install/methods.html">Installation Methods</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="install/containerd_registry_configuration.html">Containerd Registry Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="install/airgap.html">Air-Gap Install</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="install/windows_airgap.html">Windows Air-Gap Install</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="install/server_roles.html">Managing Server Roles</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="install/uninstall.html">Uninstall</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Upgrades</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="upgrade/upgrade.html">Upgrading SUSE® Rancher Prime: RKE2 Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="upgrade/manual_upgrade.html">Manual Upgrades</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="upgrade/automated_upgrade.html">Automated Upgrades</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/about_hardened_images.html">About Hardened Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/hardening_guide.html">CIS Hardening Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/cis_self_assessment16.html">CIS 1.6 Self-Assessment Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/cis_self_assessment123.html">CIS 1.23 Self-Assessment Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/fips_support.html">FIPS 140-2 Enablement</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/pod_security_policies.html">Default Pod Security Policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/pod_security_standards.html">Default Pod Security Standards</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/secrets_encryption.html">Secrets Encryption</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/selinux.html">SELinux</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/certificates.html">Certificate Management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="security/token.html">Token Management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cluster_access.html">Cluster Access</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="backup_restore.html">Etcd Backup and Restore</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Networking</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="networking/basic_network_options.html">Network Options</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="networking/multus_sriov.html">Multus and SR-IOV</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="networking/networking_services.html">Networking Services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="helm.html">Helm Integration</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="advanced.html">Advanced Options and Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">References</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reference/cli_tools.html">CLI Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reference/linux_agent_config.html">Agent Configuration Reference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reference/logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reference/resource_profiling.html">Resource Profiling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reference/server_config.html">Server Configuration Reference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="reference/windows_agent_config.html">Windows Agent Configuration Reference</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Release Notes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.24.X.html">v1.24.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.25.X.html">v1.25.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.26.X.html">v1.26.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.27.X.html">v1.27.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.28.X.html">v1.28.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.29.X.html">v1.29.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.30.X.html">v1.30.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes/v1.31.X.html">v1.31.X</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="known_issues.html">Known Issues and Limitations</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">RKE2</span>
    <span class="version">Latest</span>
  </div>
  <ul class="components">
        <li class="component">
          <div class="title"><a href="../../../cluster-api/v0.16/en/index.html">Cluster API</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../cluster-api/v0.16/en/index.html">0.16</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.15/en/index.html">0.15</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../cluster-api/v0.11/en/index.html">0.11</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../continuous-delivery/v0.11/en/index.html">Continuous Delivery</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../continuous-delivery/v0.11/en/index.html">0.11</a>
            </li>
            <li class="version">
              <a href="../../../continuous-delivery/v0.10/en/index.html">0.10</a>
            </li>
            <li class="version">
              <a href="../../../continuous-delivery/v0.9/en/index.html">0.9</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../k3s/latest/en/introduction.html">K3s</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../k3s/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../os-manager/1.6/en/index.html">OS Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../os-manager/1.6/en/index.html">1.6</a>
            </li>
            <li class="version">
              <a href="../../../os-manager/1.5/en/index.html">1.5</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../policy-manager/1.22/en/introduction.html">Policy Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../policy-manager/1.22/en/introduction.html">1.22-next</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.21/en/introduction.html">1.21</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.20/en/introduction.html">1.20</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.19/en/introduction.html">1.19</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.18/en/introduction.html">1.18</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.17/en/introduction.html">1.17</a>
            </li>
            <li class="version">
              <a href="../../../policy-manager/1.16/en/introduction.html">1.16</a>
            </li>
          </ul>
        </li>
        <li class="component is-current">
          <div class="title"><a href="introduction.html">RKE2</a></div>
          <ul class="versions">
            <li class="version is-current is-latest">
              <a href="introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">SUSE® Rancher Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.10/en/about-rancher/what-is-rancher.html">v2.10</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.9/en/about-rancher/what-is-rancher.html">v2.9</a>
            </li>
            <li class="version">
              <a href="../../../rancher-manager/v2.8/en/about-rancher/what-is-rancher.html">v2.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../security/5.4/en/overview.html">SUSE® Security</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../security/5.4/en/overview.html">5.4</a>
            </li>
            <li class="version">
              <a href="../../../security/5.3/en/overview.html">5.3</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../storage/1.9.0/en/longhorn-documentation.html">SUSE® Storage</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../storage/1.9.0/en/longhorn-documentation.html">1.9.0 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../storage/1.8.0/en/longhorn-documentation.html">1.8.0 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../storage/1.7.0/en/longhorn-documentation.html">1.7.0</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../virtualization/v1.5/en/introduction/overview.html">SUSE® Virtualization</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../virtualization/v1.5/en/introduction/overview.html">v1.5 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../virtualization/v1.4/en/introduction/overview.html">v1.4 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../virtualization/v1.3/en/introduction/overview.html">v1.3</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html" aria-label="Home" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="introduction.html">RKE2</a></li>
    <li><a href="advanced.html">Advanced Options and Configuration</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/rancher/rke2-product-docs/edit/main/versions/latest/modules/en/pages/advanced.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Advanced Options and Configuration</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section contains advanced information describing the different ways you can run and manage RKE2.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_certificate_rotation"><a class="anchor" href="#_certificate_rotation"></a>Certificate Rotation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, certificates in RKE2 expire in 12 months.</p>
</div>
<div class="paragraph">
<p>If the certificates are expired or have fewer than 90 days remaining before they expire, the certificates are rotated when RKE2 is restarted.</p>
</div>
<div class="paragraph">
<p>As of v1.21.8+rke2r1, certificates can also be rotated manually. To do this, it is best to stop the rke2-server process, rotate the certificates, then start the process up again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl stop rke2-server
rke2 certificate rotate
systemctl start rke2-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>To renew agent certificates, restart rke2-agent in agent nodes. Agent certificates are renewed every time the agent starts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl restart rke2-agent</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to rotate an individual service by passing the <code>--service</code> flag, for example: <code>rke2 certificate rotate --service api-server</code>. See <a href="security/certificates.html#_rotating_client_and_server_certificates_manually" class="xref page">Certificate Management</a> for more details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_auto_deploying_manifests"><a class="anchor" href="#_auto_deploying_manifests"></a>Auto-Deploying Manifests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Any file found in <code>/var/lib/rancher/rke2/server/manifests</code> will automatically be deployed to Kubernetes in a manner similar to <code>kubectl apply</code>.</p>
</div>
<div class="paragraph">
<p>For information about deploying Helm charts using the manifests directory, refer to the section about <a href="helm.html" class="xref page">Helm.</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_containerd"><a class="anchor" href="#_configuring_containerd"></a>Configuring containerd</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RKE2 will generate the <code>config.toml</code> for containerd in <code>/var/lib/rancher/rke2/agent/etc/containerd/config.toml</code>.</p>
</div>
<div class="paragraph">
<p>For advanced customization of this file you can create another file called <code>config.toml.tmpl</code> in the same directory and it will be used instead.</p>
</div>
<div class="paragraph">
<p>The <code>config.toml.tmpl</code> will be treated as a Go template file, and the <code>config.Node</code> structure is being passed to the template. See <a href="https://github.com/k3s-io/k3s/blob/master/pkg/agent/templates/templates.go#L16-L32">this template</a> for an example of how to use the structure to customize the configuration file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_an_http_proxy"><a class="anchor" href="#_configuring_an_http_proxy"></a>Configuring an HTTP proxy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you are running RKE2 in an environment, which only has external connectivity through an HTTP proxy, you can configure your proxy settings on the RKE2 systemd service. These proxy settings will then be used in RKE2 and passed down to the embedded containerd and kubelet.</p>
</div>
<div class="paragraph">
<p>Add the necessary <code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code> and <code>NO_PROXY</code> variables to the environment file of your systemd service, usually:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/etc/default/rke2-server</code></p>
</li>
<li>
<p><code>/etc/default/rke2-agent</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>RKE2 will automatically add the cluster internal Pod and Service IP ranges and cluster DNS domain to the list of <code>NO_PROXY</code> entries. You should ensure that the IP address ranges used by the Kubernetes nodes themselves (i.e. the public and private IPs of the nodes) are included in the <code>NO_PROXY</code> list, or that the nodes can be reached through the proxy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">HTTP_PROXY=http://your-proxy.example.com:8888
HTTPS_PROXY=http://your-proxy.example.com:8888
NO_PROXY=127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to configure the proxy settings for containerd without affecting RKE2 and the Kubelet, you can prefix the variables with <code>CONTAINERD_</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">CONTAINERD_HTTP_PROXY=http://your-proxy.example.com:8888
CONTAINERD_HTTPS_PROXY=http://your-proxy.example.com:8888
CONTAINERD_NO_PROXY=127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_node_labels_and_taints"><a class="anchor" href="#_node_labels_and_taints"></a>Node Labels and Taints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RKE2 agents can be configured with the options <code>node-label</code> and <code>node-taint</code> which adds a label and taint to the kubelet. The two options only add labels and/or taints at registration time, and can only be added once and not removed after that through rke2 commands.</p>
</div>
<div class="paragraph">
<p>If you want to change node labels and taints after node registration you should use <code>kubectl</code>. Refer to the official Kubernetes documentation for details on how to add <a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/">taints</a> and <a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#add-a-label-to-a-node">node labels</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how_agent_node_registration_works"><a class="anchor" href="#_how_agent_node_registration_works"></a>How Agent Node Registration Works</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Agent nodes are registered via a websocket connection initiated by the <code>rke2 agent</code> process, and the connection is maintained by a client-side load balancer running as part of the agent process.</p>
</div>
<div class="paragraph">
<p>Agents register with the server using the cluster secret portion of the join token, along with a randomly generated node-specific password, which is stored on the agent at <code>/etc/rancher/node/password</code>. The server will store the passwords for individual nodes as Kubernetes secrets, and any subsequent attempts must use the same password. Node password secrets are stored in the <code>kube-system</code> namespace with names using the template <code>&lt;host&gt;.node-password.rke2</code>. These secrets are deleted when the corresponding Kubernetes node is deleted.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Prior to RKE2 v1.20.2 servers stored passwords on disk at <code>/var/lib/rancher/rke2/server/cred/node-passwd</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the <code>/etc/rancher/node</code> directory of an agent is removed, the password file should be recreated for the agent prior to startup, or the entry removed from the server or Kubernetes cluster (depending on the RKE2 version).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_starting_the_server_with_the_installation_script"><a class="anchor" href="#_starting_the_server_with_the_installation_script"></a>Starting the Server with the Installation Script</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The installation script provides units for systemd, but does not enable or start the service by default.</p>
</div>
<div class="paragraph">
<p>When running with systemd, logs will be created in <code>/var/log/syslog</code> and viewed using <code>journalctl -u rke2-server</code> or <code>journalctl -u rke2-agent</code>.</p>
</div>
<div class="paragraph">
<p>An example of installing with the install script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -sfL https://get.rke2.io | sh -
systemctl enable rke2-server
systemctl start rke2-server</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_disabling_server_charts"><a class="anchor" href="#_disabling_server_charts"></a>Disabling Server Charts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The server charts bundled with <code>rke2</code> deployed during cluster bootstrapping can be disabled and replaced with alternatives.  A common use case is replacing the bundled <code>rke2-ingress-nginx</code> chart with an alternative.</p>
</div>
<div class="paragraph">
<p>To disable any of the bundled system charts, set the <code>disable</code> parameter in the config file before bootstrapping. An example of disabling all available system charts is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># /etc/rancher/rke2/config.yaml
disable:
  - rke2-coredns
  - rke2-ingress-nginx
  - rke2-metrics-server
  - rke2-snapshot-controller
  - rke2-snapshot-controller-crd
  - rke2-snapshot-validation-webhook</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is the cluster operator&#8217;s responsibility to ensure that components are disabled or replaced with care, as the server charts play important roles in cluster operability.  Refer to the <a href="./architecture.adoc#server-charts">architecture overview</a> for more information on the individual system charts role within the cluster.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_on_classified_aws_regions_or_networks_with_custom_aws_api_endpoints"><a class="anchor" href="#_installation_on_classified_aws_regions_or_networks_with_custom_aws_api_endpoints"></a>Installation on classified AWS regions or networks with custom AWS API endpoints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In public AWS regions, to ensure RKE2 is cloud-enabled, and capable of auto-provisioning certain cloud resources, config RKE2 with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># /etc/rancher/rke2/config.yaml
cloud-provider-name: aws</code></pre>
</div>
</div>
<div class="paragraph">
<p>When installing RKE2 on classified regions (such as SC2S or C2S), there are a few additional pre-requisites to be aware of to ensure RKE2 knows how and where to securely communicate with the appropriate AWS endpoints:</p>
</div>
<div class="openblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure all the common AWS cloud-provider <a href="https://rancher.com/docs/rke/latest/en/config-options/cloud-providers/aws/">prerequisites</a> are met.  These are independent of regions and are always required.</p>
</li>
<li>
<p>Ensure RKE2 knows where to send API requests for <code>ec2</code> and <code>elasticloadbalancing</code> services by creating a <code>cloud.conf</code> file, the below is an example for the <code>us-iso-east-1</code> (C2S) region:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># /etc/rancher/rke2/cloud.conf
[Global]
[ServiceOverride "ec2"]
  Service=ec2
  Region=us-iso-east-1
  URL=https://ec2.us-iso-east-1.c2s.ic.gov
  SigningRegion=us-iso-east-1
[ServiceOverride "elasticloadbalancing"]
  Service=elasticloadbalancing
  Region=us-iso-east-1
  URL=https://elasticloadbalancing.us-iso-east-1.c2s.ic.gov
  SigningRegion=us-iso-east-1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if you are using <a href="https://docs.aws.amazon.com/vpc/latest/privatelink/endpoint-services-overview.html">private AWS endpoints</a>, ensure the appropriate <code>URL</code> is used for each of the private endpoints.</p>
</div>
</li>
<li>
<p>Ensure the appropriate AWS CA bundle is loaded into the system&#8217;s root ca trust store.  This may already be done for you depending on the AMI you are using.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># on CentOS/RHEL 7/8
cp &lt;ca.pem&gt; /etc/pki/ca-trust/source/anchors/
update-ca-trust</code></pre>
</div>
</div>
</li>
<li>
<p>Configure RKE2 to use the <code>aws</code> cloud-provider with the custom <code>cloud.conf</code> created in step 1:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># /etc/rancher/rke2/config.yaml
...
cloud-provider-name: aws
cloud-provider-config: "/etc/rancher/rke2/cloud.conf"
...</code></pre>
</div>
</div>
</li>
<li>
<p><a href="install/methods.html" class="xref page">Install</a> RKE2 normally (most likely in an <a href="install/airgap.html" class="xref page">airgapped</a> capacity)</p>
</li>
<li>
<p>Validate successful installation by confirming the existence of AWS metadata on cluster node labels with <code>kubectl get nodes --show-labels</code></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_control_plane_component_resource_requestslimits"><a class="anchor" href="#_control_plane_component_resource_requestslimits"></a>Control Plane Component Resource Requests/Limits</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following options are available under the <code>server</code> sub-command for RKE2. The options allow for specifying CPU requests and limits for the control plane components within RKE2.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   --control-plane-resource-requests value       (components) Control Plane resource requests [$RKE2_CONTROL_PLANE_RESOURCE_REQUESTS]
   --control-plane-resource-limits value         (components) Control Plane resource limits [$RKE2_CONTROL_PLANE_RESOURCE_LIMITS]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Values are a comma-delimited list of <code>[controlplane-component]-(cpu|memory)=[desired-value]</code>. The possible values for <code>controlplane-component</code> are:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>kube-apiserver
kube-scheduler
kube-controller-manager
kube-proxy
etcd
cloud-controller-manager</pre>
</div>
</div>
<div class="paragraph">
<p>Thus, an example config may value may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># /etc/rancher/rke2/config.yaml
control-plane-resource-requests:
  - kube-apiserver-cpu=500m
  - kube-apiserver-memory=512M
  - kube-scheduler-cpu=250m
  - kube-scheduler-memory=512M
  - etcd-cpu=1000m</code></pre>
</div>
</div>
<div class="paragraph">
<p>The unit values for CPU/memory are identical to Kubernetes resource units (See: <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#resource-units-in-kubernetes">Resource Limits in Kubernetes</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extra_control_plane_component_volume_mounts"><a class="anchor" href="#_extra_control_plane_component_volume_mounts"></a>Extra Control Plane Component Volume Mounts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following options are available under the <code>server</code> sub-command for RKE2. These options specify host-path mounting of directories from the node filesystem into the static pod component that corresponds to the prefixed name.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flag</th>
<th class="tableblock halign-left valign-top">ENV VAR</th>
<th class="tableblock halign-left valign-top"></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kube-apiserver-extra-mount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_KUBE_APISERVER_EXTRA_MOUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kube-apiserver extra volume mounts</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kube-scheduler-extra-mount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_KUBE_SCHEDULER_EXTRA_MOUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">kube-scheduler extra volume mounts</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kube-controller-manager-extra-mount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_KUBE_CONTROLLER_MANAGER_EXTRA_MOUNT</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kube-proxy-extra-mount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_KUBE_PROXY_EXTRA_MOUNT</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--etcd-extra-mount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_ETCD_EXTRA_MOUNT</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--cloud-controller-manager-extra-mount</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_CLOUD_CONTROLLER_MANAGER_EXTRA_MOUNT</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="_rw_host_path_volume_mount"><a class="anchor" href="#_rw_host_path_volume_mount"></a>RW Host Path Volume Mount</h3>
<div class="paragraph">
<p><code>/source/volume/path/on/host:/destination/volume/path/in/staticpod</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_ro_host_path_volume_mount"><a class="anchor" href="#_ro_host_path_volume_mount"></a>RO Host Path Volume Mount</h3>
<div class="paragraph">
<p>In order to mount a volume as read only, append <code>:ro</code> to the end of the volume mount: <code>/source/volume/path/on/host:/destination/volume/path/in/staticpod:ro</code></p>
</div>
<div class="paragraph">
<p>Multiple volume mounts can be specified for the same component by passing the flag values as an array in the config file.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Version Gate</div>
<div class="paragraph">
<p>Prior to April 2024 releases (v1.27.13+rke2r1, v1.28.9+rke2r1, v1.29.4+rke2r1), only directories can be mounted.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># /etc/rancher/rke2/config.yaml
kube-apiserver-extra-mount:
   - "/tmp/foo:/root/foo"
   - "/tmp/bar.txt:/etc/bar.txt:ro"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extra_control_plane_component_environment_variables"><a class="anchor" href="#_extra_control_plane_component_environment_variables"></a>Extra Control Plane Component Environment Variables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following options are available under the <code>server</code> sub-command for RKE2. These options specify additional environment variables in standard format i.e. <code>KEY=VALUE</code> for the static pod component that corresponds to the prefixed name.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flag</th>
<th class="tableblock halign-left valign-top">ENV VAR</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kube-apiserver-extra-env</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_KUBE_APISERVER_EXTRA_ENV</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kube-scheduler-extra-env</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_KUBE_SCHEDULER_EXTRA_ENV</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kube-controller-manager-extra-env</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_KUBE_CONTROLLER_MANAGER_EXTRA_ENV</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kube-proxy-extra-env</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_KUBE_PROXY_EXTRA_ENV</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--etcd-extra-env</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_ETCD_EXTRA_ENV</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--cloud-controller-manager-extra-env</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2_CLOUD_CONTROLLER_MANAGER_EXTRA_ENV</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Multiple environment variables can be specified for the same component by passing the flag values as an array in the config file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml"># /etc/rancher/rke2/config.yaml
kube-apiserver-extra-env:
  - "MY_FOO=FOO"
  - "MY_BAR=BAR"
kube-scheduler-extra-env: "TZ=America/Los_Angeles"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_nvidia_operator"><a class="anchor" href="#_deploy_nvidia_operator"></a>Deploy NVIDIA operator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://github.com/NVIDIA/gpu-operator">NVIDIA operator</a> allows administrators of Kubernetes clusters to manage GPUs just like CPUs. It includes everything needed for pods to be able to operate GPUs.</p>
</div>
<div class="paragraph">
<p>Depending on the underlying OS, some steps need to be fulfilled</p>
</div>
<div id="_tabs_1" class="openblock tabs is-sync data-sync-group-id=GPU Operating System is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_1_sles" class="tab">
<p>SLES</p>
</li>
<li id="_tabs_1_ubuntu" class="tab">
<p>Ubuntu</p>
</li>
<li id="_tabs_1_rhel" class="tab">
<p>RHEL</p>
</li>
</ul>
</div>
<div id="_tabs_1_sles--panel" class="tabpanel" aria-labelledby="_tabs_1_sles">
<div class="paragraph">
<p>The NVIDIA operator cannot automatically install kernel drivers on SLES. NVIDIA drivers must be manually installed on all GPU nodes before deploying the operator in the cluster. It can be done with the following steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># Assuming you are using sle15sp5, if different, change the url accordingly sudo zypper addrepo --refresh 'https://download.nvidia.com/suse/sle15sp5' NVIDIA sudo zypper --gpg-auto-import-keys refresh sudo zypper install -y ---auto-agree-with-licenses nvidia-gl-G06 nvidia-video-G06 nvidia-compute-utils-G06</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then reboot.</p>
</div>
<div class="paragraph">
<p>If everything worked correctly, after the reboot, you should see the NVRM and GCC version of the driver when executing the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat /proc/driver/nvidia/version</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, create the symlink:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo ln -s /sbin/ldconfig /sbin/ldconfig.real ```</code></pre>
</div>
</div>
</div>
<div id="_tabs_1_ubuntu--panel" class="tabpanel" aria-labelledby="_tabs_1_ubuntu">
<div class="paragraph">
<p>The NVIDIA operator can automatically install kernel drivers on Ubuntu using the <code>nvidia-driver-daemonset</code>, although not all versions are supported. You can also pre-install them manually and the operator will detect them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo apt install nvidia-driver-535-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then reboot.</p>
</div>
<div class="paragraph">
<p>If everything worked correctly, after the reboot, you should see a correct output when executing the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat /proc/driver/nvidia/version</code></pre>
</div>
</div>
</div>
<div id="_tabs_1_rhel--panel" class="tabpanel" aria-labelledby="_tabs_1_rhel">
<div class="paragraph">
<p>The NVIDIA operator can automatically install kernel drivers on RHEL using the <code>nvidia-driver-daemonset</code>. You would only need to create the symlink:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo ln -s /sbin/ldconfig /sbin/ldconfig.real</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once the OS is ready and RKE2 is running, install the GPU Operator with the following yaml manifest:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: gpu-operator
  namespace: kube-system
spec:
  repo: https://helm.ngc.nvidia.com/nvidia
  chart: gpu-operator
  targetNamespace: gpu-operator
  createNamespace: true
  valuesContent: |-
    toolkit:
      env:
      - name: CONTAINERD_SOCKET
        value: /run/k3s/containerd/containerd.sock</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The NVIDIA operator restarts containerd with a hangup call which restarts RKE2.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After one minute approximately, you can make the following checks to verify that everything worked as expected:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Check if the operator detected the driver and GPU correctly:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get node $NODENAME -o jsonpath='{.metadata.labels}' | jq | grep "nvidia.com"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see labels specifying driver and GPU (e.g. nvidia.com/gpu.machine or nvidia.com/cuda.driver.major).</p>
</div>
</li>
<li>
<p>Check if the gpu was added (by nvidia-device-plugin-daemonset) as an allocatable resource in the node:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get node $NODENAME -o jsonpath='{.status.allocatable}' | jq</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see <code>"nvidia.com/gpu":</code> followed by the number of gpus in the node.</p>
</div>
</li>
<li>
<p>Check that the container runtime binary was installed by the operator (in particular by the <code>nvidia-container-toolkit-daemonset</code>):</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ls /usr/local/nvidia/toolkit/nvidia-container-runtime</code></pre>
</div>
</div>
</li>
<li>
<p>Verify if containerd config was updated to include the nvidia container runtime:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">grep nvidia /etc/containerd/config.toml</code></pre>
</div>
</div>
</li>
<li>
<p>Run a pod to verify that the GPU resource can successfully be scheduled on a pod and the pod can detect it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Pod
metadata:
  name: nbody-gpu-benchmark
  namespace: default
spec:
  restartPolicy: OnFailure
  runtimeClassName: nvidia
  containers:
  - name: cuda-container
    image: nvcr.io/nvidia/k8s/cuda-sample:nbody
    args: ["nbody", "-gpu", "-benchmark"]
    resources:
      limits:
        nvidia.com/gpu: 1
    env:
    - name: NVIDIA_VISIBLE_DEVICES
      value: all
    - name: NVIDIA_DRIVER_CAPABILITIES
      value: all</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="helm.html">Helm Integration</a></span>
  <span class="next"><a href="reference/cli_tools.html">CLI Tools</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/vendor/lunr-languages.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
<script src="../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../_/js/vendor/tabs.js"></script>


  </body>
</html>
