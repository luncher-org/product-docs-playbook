<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>埋め込みレジストリミラー :: Rancher product documentation</title>
    <link rel="canonical" href="https://documentation.suse.com/cloudnative/k3s/latest/ja/installation/registry-mirror.html">
    <link rel="prev" href="private-registry.html">
    <link rel="next" href="airgap.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../_/css/search.css">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../../_/css/vendor/light.css">
<!-- <script src="/docserv/res/lightheaded/analytics.js"
        type="text/javascript"></script> -->
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a class=" navbar-logo" href="https://documentation.suse.com/" aria-label="SUSE Documentation Home"><img class="logo"
            src="../../../../_/img/logo.svg" alt="SUSE logo"/></a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">
            <img src="../../../../_/img/resources.png" class="langIcon Resurces" alt="Resources" title="Resources">
          </div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/rancher/k3s-product-docs"><i class="fab fa-github"></i>&nbsp;K3s</a>
            <div class="has-submenu">
              <a class="navbar-item" href="#" ><i class="fas fa-file-alt"></i>&nbsp;Report Issue &nbsp;<i class="fas fa-chevron-right"></i></a>
              <div class="submenu">
                <a class="navbar-item" href="https://scc.suse.com">SCC (Recommended)</a>
                <a class="navbar-item" href="https://github.com/rancher/k3s-product-docs/issues">GitHub Issue</a>
              </div>
            </div>
            <a class="navbar-item" href="https://github.com/rancher/product-docs-playbook/blob/main/CONTRIBUTING.md"><i class="fas fa-user-edit"></i>&nbsp;Contribute</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link"><img src="../../../../_/img/language.png" class="langIcon Language" alt="Language"
              title="Language"></div>
          <div class="navbar-dropdown">
            <!--  </div><div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div> -->
              <a role="button" class="navbar-item" id="en" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/engFlag.svg" class="langIcon english">-->
                &nbsp;English
              </a>
              <a role="button" class="navbar-item" id="zh" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/china.svg" class="langIcon china">-->
                &nbsp;中文
              </a>
              <a role="button" class="navbar-item" id="ko" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/koFlag.svg" class="langIcon korea">-->
                &nbsp;한국어
              </a>
              <a role="button" class="navbar-item" id="ja" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/jaFlag.svg" class="langIcon japan">-->
                &nbsp;日本語
              </a>
            <!-- LANGUAGESELECTOR -->
          </div>
        </div>
        <!--
        <div class="navbar-item">
          <a href="https://twitter.com/SUSE">
            <img alt="X-logo" class="x-logo" src="../../../../_/img/x-logo-white.png">
          </a>
        </div>
        -->
      </div>
    </div>

    <!--   <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
      </div> -->
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="k3s" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../en/introduction.html">K3s</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction.html">K3s - 軽量なKubernetes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quick-start.html">クイックスタートガイド</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="installation.html">インストール</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="requirements.html">要件</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="configuration.html">設定オプション</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="private-registry.html">プライベートレジストリの設定</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="registry-mirror.html">埋め込みレジストリミラー</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="airgap.html">エアギャップインストール</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="server-roles.html">サーバーロールの管理</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="packaged-components.html">パッケージ化されたコンポーネントの管理</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="uninstall.html">K3sのアンインストール</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../datastore/datastore.html">クラスタデータストア</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/backup-restore.html">バックアップとリストア</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/ha-embedded.html">高可用性組み込みetcd</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/ha.html">高可用性外部データベース</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/cluster-loadbalancer.html">クラスター・ロードバランサー</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../upgrades/upgrades.html">アップグレード</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrades/killall.html">K3sの停止</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrades/manual.html">手動アップグレード</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrades/automated.html">自動アップグレード</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../security/security.html">セキュリティ</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/secrets-encryption.html">secretの暗号化設定</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/hardening-guide.html">CIS ハードニングガイド</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/self-assessment-1.8.html">CIS 1.8 セルフアセスメントガイド</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/self-assessment-1.7.html">CIS 1.7 セルフアセスメントガイド</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/self-assessment-1.24.html">CIS 1.24 自己評価ガイド</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../cli/cli.html">CLIツール</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/server.html">server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/agent.html">k3s エージェント</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/certificate.html">certificate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/etcd-snapshot.html">etcd-snapshot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/secrets-encrypt.html">secrets-encrypt</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/token.html">token</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture.html">アーキテクチャ</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../cluster-access.html">クラスターアクセス</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../storage.html">ボリュームとストレージ</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../networking/networking.html">ネットワーキング</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/basic-network-options.html">基本的なネットワークオプション</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/distributed-multicloud.html">分散型ハイブリッドまたはマルチクラウドクラスター</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/multus-ipams.html">Multus and IPAM plugins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/networking-services.html">ネットワーキングサービス</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../helm.html">Helm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../advanced.html">高度なオプション / 設定</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Reference</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/env-variables.html">環境変数</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/flag-deprecation.html">フラグの非推奨化</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/resource-profiling.html">リソースプロファイリング</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Release Notes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.32.X.html">v1.32.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.31.X.html">v1.31.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.30.X.html">v1.30.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.29.X.html">v1.29.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.28.X.html">v1.28.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.27.X.html">v1.27.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.26.X.html">v1.26.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.25.X.html">v1.25.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.24.X.html">v1.24.X</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../related-projects.html">関連プロジェクト</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../known-issues.html">既知の問題</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../faq.html">FAQ</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">K3s</span>
    <span class="version">Latest</span>
  </div>
  <ul class="components">
        <li class="component">
          <div class="title"><a href="../../../../cluster-api/v0.16/en/index.html">Cluster API</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../cluster-api/v0.16/en/index.html">0.16</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.15/en/index.html">0.15</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.11/en/index.html">0.11</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../continuous-delivery/v0.11/en/index.html">Continuous Delivery</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../continuous-delivery/v0.11/en/index.html">0.11</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.10/en/index.html">0.10</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.9/en/index.html">0.9</a>
            </li>
          </ul>
        </li>
        <li class="component is-current">
          <div class="title"><a href="../../en/introduction.html">K3s</a></div>
          <ul class="versions">
            <li class="version is-current is-latest">
              <a href="../../en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../os-manager/1.6/en/index.html">OS Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../os-manager/1.6/en/index.html">1.6</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/1.5/en/index.html">1.5</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../policy-manager/1.22/en/introduction.html">Policy Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../policy-manager/1.22/en/introduction.html">1.22-next</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.21/en/introduction.html">1.21</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.20/en/introduction.html">1.20</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.19/en/introduction.html">1.19</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.18/en/introduction.html">1.18</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.17/en/introduction.html">1.17</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.16/en/introduction.html">1.16</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../rke2/latest/en/introduction.html">RKE2</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../rke2/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">SUSE® Rancher Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.10/en/about-rancher/what-is-rancher.html">v2.10</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.9/en/about-rancher/what-is-rancher.html">v2.9</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.8/en/about-rancher/what-is-rancher.html">v2.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../security/5.4/en/overview.html">SUSE® Security</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../security/5.4/en/overview.html">5.4</a>
            </li>
            <li class="version">
              <a href="../../../../security/5.3/en/overview.html">5.3</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../storage/1.9.0/en/longhorn-documentation.html">SUSE® Storage</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../storage/1.9.0/en/longhorn-documentation.html">1.9.0 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.8.0/en/longhorn-documentation.html">1.8.0 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.7.0/en/longhorn-documentation.html">1.7.0</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../virtualization/v1.5/en/introduction/overview.html">SUSE® Virtualization</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../virtualization/v1.5/en/introduction/overview.html">v1.5 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../virtualization/v1.4/en/introduction/overview.html">v1.4 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../virtualization/v1.3/en/introduction/overview.html">v1.3</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html" aria-label="Home" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../en/introduction.html">K3s</a></li>
    <li><a href="installation.html">インストール</a></li>
    <li><a href="registry-mirror.html">埋め込みレジストリミラー</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/rancher/k3s-product-docs/edit/main/versions/latest/modules/ja/pages/installation/registry-mirror.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">埋め込みレジストリミラー</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">バージョンゲート</div>
<div class="paragraph">
<p>埋め込みレジストリミラーは、2024年1月のリリースから実験的な機能として利用可能です：v1.26.13+k3s1、v1.27.10+k3s1、v1.28.6+k3s1、v1.29.1+k3s1 and GA as of December 2024 releases: v1.29.12+k3s1, v1.30.8+k3s1, v1.31.4+k3s1.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>K3sは、Kubernetesクラスター内のノード間でコンテナイメージをピアツーピアで共有できる、ステートレスな分散OCIレジストリミラーである<a href="https://github.com/XenitAB/spegel">Spegel</a>を埋め込んでいます。分散レジストリミラーはデフォルトでは無効になっています。 For K3s to leverage it, you must enable both the <a href="#_enabling_the_distributed_oci_registry_mirror">Distributed OCI Registry Mirror</a> and the <a href="#_enabling_registry_mirroring">Registry mirroring</a> as explained in the following subsections.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enabling_the_distributed_oci_registry_mirror"><a class="anchor" href="#_enabling_the_distributed_oci_registry_mirror"></a>分散OCIレジストリミラーの有効化</h2>
<div class="sectionbody">
<div class="paragraph">
<p>埋め込みレジストリミラーを有効にするには、サーバーノードを<code>--embedded-registry</code>フラグを付けて起動するか、設定ファイルに<code>embedded-registry: true</code>を追加する必要があります。
このオプションを有効にすると、クラスター内のすべてのノードで埋め込みミラーが使用可能になります。</p>
</div>
<div class="paragraph">
<p>クラスター全体で有効にすると、すべてのノードはポート6443でローカルOCIレジストリをホストし、ポート5001でピアツーピアネットワークを介して利用可能なイメージのリストを公開します。
任意のノードのcontainerdイメージストアにあるイメージは、外部レジストリにアクセスせずに他のクラスターのメンバーによってプルされることができます。
<a href="airgap.html#_manually_deploy_images_method" class="xref page">エアギャップイメージtarファイル</a>を介してインポートされたイメージは、Kubeletのガベージコレクションによって削除されないようにcontainerdに固定されます。</p>
</div>
<div class="paragraph">
<p>ピアツーピアポートは、K3sサービスの環境変数<code>K3S_P2P_PORT</code>を設定することで5001から変更できます。ポートはすべてのノードで同じ値に設定する必要があります。
ポートの変更はサポートされておらず、推奨されません。</p>
</div>
<div class="sect2">
<h3 id="_要件"><a class="anchor" href="#_要件"></a>要件</h3>
<div class="paragraph">
<p>埋め込みレジストリミラーが有効になっている場合、すべてのノードは内部IPアドレスを介して、TCPポート5001および6443で相互に接続できる必要があります。
ノードが相互に接続できない場合、分散レジストリが最初に試され、その後他のエンドポイントにフォールバックするため、イメージのプルに時間がかかることがあります。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enabling_registry_mirroring"><a class="anchor" href="#_enabling_registry_mirroring"></a>レジストリミラーリングの有効化</h2>
<div class="sectionbody">
<div class="paragraph">
<p>レジストリのミラーリングを有効にすると、ノードは他のノードからそのレジストリのイメージをプルし、そのレジストリのイメージを他のノードと共有できます。
一部のノードでレジストリのミラーリングが有効になっているが、他のノードでは有効になっていない場合、レジストリが有効になっているノードのみがそのレジストリからイメージを交換します。</p>
</div>
<div class="paragraph">
<p>上流のコンテナレジストリからのイメージのミラーリングを有効にするには、ノードはそのレジストリの<code>registries.yaml</code>の<code>mirrors</code>セクションにエントリを持っている必要があります。
レジストリにはエンドポイントをリストする必要はなく、存在するだけで十分です。
例えば、<code>docker.io</code>および<code>registry.k8s.io</code>からのイメージの分散ミラーリングを有効にするには、すべてのクラスターのノードで以下の内容で<code>registries.yaml</code>を設定します：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">mirrors:
  docker.io:
  registry.k8s.io:</code></pre>
</div>
</div>
<div class="paragraph">
<p>レジストリミラーのエンドポイントも通常通り追加できます。
以下の設定では、イメージのプルは最初に埋め込みミラーを試し、その後<code>mirror.example.com</code>、最後に<code>docker.io</code>を試みます：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">mirrors:
  docker.io:
    endpoint:
      - https://mirror.example.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>プライベートレジストリを直接使用する場合、上流レジストリのミラーとしてではなく、パブリックレジストリと同様にミラーリングを有効にできます - ミラーセクションにリストすることで：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">mirrors:
  mirror.example.com:</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">バージョンゲート</div>
<div class="paragraph">
<p>ワイルドカードサポートは、2024年3月のリリースから利用可能です：v1.26.15+k3s1、v1.27.12+k3s1、v1.28.8+k3s1、v1.29.3+k3s1</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>"*"</code>ワイルドカードミラーエントリを使用して、すべてのレジストリの分散ミラーリングを有効にできます。アスタリスクは必ず引用符で囲む必要があります：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">mirrors:
  "*":</code></pre>
</div>
</div>
<div class="paragraph">
<p>ノードでミラーリングが有効になっているレジストリがない場合、そのノードは分散レジストリに一切参加しません。</p>
</div>
<div class="paragraph">
<p><code>registries.yaml</code>ファイルの構造に関する詳細は、<a href="private-registry.html" class="xref page">プライベートレジストリの設定</a>を参照してください。</p>
</div>
<div class="sect2">
<h3 id="_デフォルトエンドポイントのフォールバック"><a class="anchor" href="#_デフォルトエンドポイントのフォールバック"></a>デフォルトエンドポイントのフォールバック</h3>
<div class="paragraph">
<p>デフォルトでは、containerdはミラーエンドポイントが設定されているレジストリからプルする際にデフォルトエンドポイントにフォールバックします。これを無効にし、
設定されたミラーおよび/または埋め込みミラーからのみイメージをプルしたい場合は、プライベートレジストリ設定の<a href="private-registry.html#_default_endpoint_fallback" class="xref page">デフォルトエンドポイントのフォールバック</a>セクションを参照してください。</p>
</div>
<div class="paragraph">
<p><code>--disable-default-endpoint</code>オプションを使用していて、特定のレジストリから直接プルを許可し、他のレジストリからは許可しない場合は、エンドポイントを明示的に指定してイメージプルがそのレジストリ自体にフォールバックするようにできます：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">mirrors:
  docker.io:           # デフォルトエンドポイントなし、ノードで利用できない場合はプルに失敗
  registry.k8s.io:     # デフォルトエンドポイントなし、ノードで利用できない場合はプルに失敗
  mirror.example.com:  # 明示的なデフォルトエンドポイント、ノードで利用できない場合は上流からプル可能
    endpoint:
      - https://mirror.example.com</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_最新タグ"><a class="anchor" href="#_最新タグ"></a>最新タグ</h3>
<div class="paragraph">
<p>コンテナイメージにタグが指定されていない場合、暗黙のデフォルトタグは<code>latest</code>です。このタグは頻繁に更新され、最新バージョンのイメージを指します。このタグはプルされるタイミングによって異なるリビジョンのイメージを指すため、分散レジストリは他のノードから<code>latest</code>タグをプル<strong>しません</strong>。これにより、containerdは一貫したビューを確保するために上流レジストリまたはレジストリミラーにアクセスすることを強制されます。</p>
</div>
<div class="paragraph">
<p>これは、コンテナイメージに<code>latest</code>タグを使用する際にKubernetesが観察する<a href="https://kubernetes.io/docs/concepts/containers/images/#imagepullpolicy-defaulting">特別な<code>imagePullPolicy</code>のデフォルト設定</a>と一致します。</p>
</div>
<div class="paragraph">
<p><code>latest</code>タグのミラーリングは、K3sサービスの環境変数<code>K3S_P2P_ENABLE_LATEST=true</code>を設定することで有効にできます。上記の理由から、これはサポートされておらず、推奨されません。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_セキュリティ"><a class="anchor" href="#_セキュリティ"></a>セキュリティ</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_認証"><a class="anchor" href="#_認証"></a>認証</h3>
<div class="paragraph">
<p>埋め込みミラーのレジストリAPIへのアクセスには、クラスターのクライアント証明書認証局によって署名された有効なクライアント証明書が必要です。</p>
</div>
<div class="paragraph">
<p>分散ハッシュテーブルのピアツーピアネットワークへのアクセスには、サーバーノードによって制御される事前共有キーが必要です。
ノードは、事前共有キーとクラスター証明書認証局によって署名された証明書の両方を使用して相互に認証します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_潜在的な懸念"><a class="anchor" href="#_潜在的な懸念"></a>潜在的な懸念</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>分散レジストリはピアツーピアの原則に基づいて構築されており、すべてのクラスターメンバー間で同等の特権と信頼を前提としています。
これがクラスターのセキュリティポリシーに一致しない場合、埋め込み分散レジストリを有効にすべきではありません。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>埋め込みレジストリは、ノードが通常アクセスできないイメージを利用可能にする場合があります。
例えば、一部のイメージがKubernetesイメージプルシークレットや<code>registries.yaml</code>の資格情報を介して認証が必要なレジストリ、プロジェクト、リポジトリからプルされる場合、分散レジストリは他のノードがこれらのイメージを資格情報なしで共有できるようにします。</p>
</div>
<div class="paragraph">
<p>あるノードのcontainerdイメージストアにイメージをプッシュする権限を持つユーザーは、他のクラスターノードのイメージを「毒する」ことができるかもしれません。他のノードはそのノードが広告するタグを信頼し、上流レジストリを確認せずに使用します。
イメージの整合性が重要な場合は、タグの代わりにイメージダイジェストを使用するべきです。ダイジェストはこの方法で毒されることはありません。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_エアギャップまたは手動でロードされたイメージの共有"><a class="anchor" href="#_エアギャップまたは手動でロードされたイメージの共有"></a>エアギャップまたは手動でロードされたイメージの共有</h2>
<div class="sectionbody">
<div class="paragraph">
<p>イメージの共有は、ソースレジストリに基づいて制御されます。
エアギャップtarボールを介して直接containerdにロードされたイメージ、または<code>ctr</code>コマンドラインツールを使用してcontainerdのイメージストアに直接ロードされたイメージは、ミラーリングが有効になっているレジストリとしてタグ付けされている場合、ノード間で共有されます。</p>
</div>
<div class="paragraph">
<p>イメージが実際に存在する必要はなく、到達可能である必要もありません。
例えば、架空の上流レジストリとしてイメージをタグ付けし、そのイメージをcontainerdのイメージストアにインポートすることができます。
そのレジストリが<code>registries.yaml</code>にリストされている限り、すべてのクラスターメンバーからそのイメージをプルすることができます。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_イメージのプッシュ"><a class="anchor" href="#_イメージのプッシュ"></a>イメージのプッシュ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>埋め込みレジストリは読み取り専用であり、<code>docker push</code>や他の一般的なOCIレジストリと対話するツールを使用して直接プッシュすることはできません。</p>
</div>
<div class="paragraph">
<p>イメージは、<code>ctr -n k8s.io image pull</code>を実行してイメージをプルするか、<code>docker save</code>で作成されたイメージアーカイブを<code>ctr -n k8s.io image import</code>コマンドを使用してロードすることで、手動で埋め込みレジストリで利用可能にできます。
<code>ctr</code>を使用してイメージを管理する際には、kubeletに表示されるようにするために<code>k8s.io</code>名前空間を指定する必要があることに注意してください。</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="private-registry.html">プライベートレジストリの設定</a></span>
  <span class="next"><a href="airgap.html">エアギャップインストール</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/vendor/lunr-languages.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
<script src="../../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../../_/js/vendor/tabs.js"></script>


  </body>
</html>
