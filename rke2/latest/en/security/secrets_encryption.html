<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Secrets Encryption :: Rancher product documentation</title>
    <link rel="canonical" href="https://documentation.suse.com/cloudnative/rke2/latest/en/security/secrets_encryption.html">
    <link rel="prev" href="pod_security_standards.html">
    <link rel="next" href="selinux.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../_/css/search.css">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../../_/css/vendor/light.css">
<!-- <script src="/docserv/res/lightheaded/analytics.js"
        type="text/javascript"></script> -->
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a class=" navbar-logo" href="https://documentation.suse.com/" aria-label="SUSE Documentation Home"><img class="logo"
            src="../../../../_/img/logo.svg" alt="SUSE logo"/></a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">
            <img src="../../../../_/img/resources.png" class="langIcon Resurces" alt="Resources" title="Resources">
          </div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/rancher/rke2-product-docs"><i class="fab fa-github"></i>&nbsp;RKE2</a>
            <div class="has-submenu">
              <a class="navbar-item" href="#" ><i class="fas fa-file-alt"></i>&nbsp;Report Issue &nbsp;<i class="fas fa-chevron-right"></i></a>
              <div class="submenu">
                <a class="navbar-item" href="https://scc.suse.com">SCC (Recommended)</a>
                <a class="navbar-item" href="https://github.com/rancher/rke2-product-docs/issues">GitHub Issue</a>
              </div>
            </div>
            <a class="navbar-item" href="https://github.com/rancher/product-docs-playbook/blob/main/CONTRIBUTING.md"><i class="fas fa-user-edit"></i>&nbsp;Contribute</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link"><img src="../../../../_/img/language.png" class="langIcon Language" alt="Language"
              title="Language"></div>
          <div class="navbar-dropdown">
            <!--  </div><div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div> -->
              <a role="button" class="navbar-item" id="en" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/engFlag.svg" class="langIcon english">-->
                &nbsp;English
              </a>
              <a role="button" class="navbar-item" id="zh" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/china.svg" class="langIcon china">-->
                &nbsp;中文
              </a>
            <!-- LANGUAGESELECTOR -->
          </div>
        </div>
        <!--
        <div class="navbar-item">
          <a href="https://twitter.com/SUSE">
            <img alt="X-logo" class="x-logo" src="../../../../_/img/x-logo-white.png">
          </a>
        </div>
        -->
      </div>
    </div>

    <!--   <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
      </div> -->
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rke2" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../introduction.html">RKE2</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Installation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/quickstart.html">Quick Start</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/requirements.html">Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/configuration.html">Configuration Options</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/ha.html">High Availability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/methods.html">Installation Methods</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/containerd_registry_configuration.html">Containerd Registry Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/airgap.html">Air-Gap Install</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/windows_airgap.html">Windows Air-Gap Install</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/server_roles.html">Managing Server Roles</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../install/uninstall.html">Uninstall</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Upgrades</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrade/upgrade.html">Upgrading SUSE® Rancher Prime: RKE2 Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrade/manual_upgrade.html">Manual Upgrades</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrade/automated_upgrade.html">Automated Upgrades</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Security</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="about_hardened_images.html">About Hardened Images</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="hardening_guide.html">CIS Hardening Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cis_self_assessment16.html">CIS 1.6 Self-Assessment Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="cis_self_assessment123.html">CIS 1.23 Self-Assessment Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="fips_support.html">FIPS 140-2 Enablement</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pod_security_policies.html">Default Pod Security Policies</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="pod_security_standards.html">Default Pod Security Standards</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="secrets_encryption.html">Secrets Encryption</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="selinux.html">SELinux</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="certificates.html">Certificate Management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="token.html">Token Management</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture.html">Architecture</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../cluster_access.html">Cluster Access</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../backup_restore.html">Etcd Backup and Restore</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Networking</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/basic_network_options.html">Network Options</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/multus_sriov.html">Multus and SR-IOV</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/networking_services.html">Networking Services</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../helm.html">Helm Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../advanced.html">Advanced Options and Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">References</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/cli_tools.html">CLI Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/linux_agent_config.html">Agent Configuration Reference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/resource_profiling.html">Resource Profiling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/server_config.html">Server Configuration Reference</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/windows_agent_config.html">Windows Agent Configuration Reference</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Release Notes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.24.X.html">v1.24.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.25.X.html">v1.25.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.26.X.html">v1.26.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.27.X.html">v1.27.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.28.X.html">v1.28.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.29.X.html">v1.29.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.30.X.html">v1.30.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.31.X.html">v1.31.X</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../known_issues.html">Known Issues and Limitations</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">RKE2</span>
    <span class="version">Latest</span>
  </div>
  <ul class="components">
        <li class="component">
          <div class="title"><a href="../../../../cluster-api/v0.16/en/index.html">Cluster API</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../cluster-api/v0.16/en/index.html">0.16</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.15/en/index.html">0.15</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.11/en/index.html">0.11</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../continuous-delivery/v0.11/en/index.html">Continuous Delivery</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../continuous-delivery/v0.11/en/index.html">0.11</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.10/en/index.html">0.10</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.9/en/index.html">0.9</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../k3s/latest/en/introduction.html">K3s</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../k3s/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../os-manager/1.6/en/index.html">OS Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../os-manager/1.6/en/index.html">1.6</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/1.5/en/index.html">1.5</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../policy-manager/1.22/en/introduction.html">Policy Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../policy-manager/1.22/en/introduction.html">1.22-next</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.21/en/introduction.html">1.21</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.20/en/introduction.html">1.20</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.19/en/introduction.html">1.19</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.18/en/introduction.html">1.18</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.17/en/introduction.html">1.17</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.16/en/introduction.html">1.16</a>
            </li>
          </ul>
        </li>
        <li class="component is-current">
          <div class="title"><a href="../introduction.html">RKE2</a></div>
          <ul class="versions">
            <li class="version is-current is-latest">
              <a href="../introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">SUSE® Rancher Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.10/en/about-rancher/what-is-rancher.html">v2.10</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.9/en/about-rancher/what-is-rancher.html">v2.9</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.8/en/about-rancher/what-is-rancher.html">v2.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../security/5.4/en/overview.html">SUSE® Security</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../security/5.4/en/overview.html">5.4</a>
            </li>
            <li class="version">
              <a href="../../../../security/5.3/en/overview.html">5.3</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../storage/1.9.0/en/longhorn-documentation.html">SUSE® Storage</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../storage/1.9.0/en/longhorn-documentation.html">1.9.0 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.8.0/en/longhorn-documentation.html">1.8.0 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.7.0/en/longhorn-documentation.html">1.7.0</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../virtualization/v1.5/en/introduction/overview.html">SUSE® Virtualization</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../virtualization/v1.5/en/introduction/overview.html">v1.5 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../virtualization/v1.4/en/introduction/overview.html">v1.4 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../virtualization/v1.3/en/introduction/overview.html">v1.3</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html" aria-label="Home" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../introduction.html">RKE2</a></li>
    <li>Security</li>
    <li><a href="secrets_encryption.html">Secrets Encryption</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/rancher/rke2-product-docs/edit/main/versions/latest/modules/en/pages/security/secrets_encryption.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Secrets Encryption</h1>
<div class="sect1">
<h2 id="_secrets_encryption_config"><a class="anchor" href="#_secrets_encryption_config"></a>Secrets Encryption Config</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RKE2 supports <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/">encrypting secrets at rest</a>, and will do the following automatically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate an AES-CBC key</p>
</li>
<li>
<p>Generate an encryption config file with the generated key:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">{
  "kind": "EncryptionConfiguration",
  "apiVersion": "apiserver.config.k8s.io/v1",
  "resources": [
    {
      "resources": [
        "secrets"
      ],
      "providers": [
        {
          "aescbc": {
            "keys": [
              {
                "name": "aescbckey",
                "secret": "xxxxxxxxxxxxxxxxxxx"
              }
            ]
          }
        },
        {
          "identity": {}
        }
      ]
    }
  ]
}</code></pre>
</div>
</div>
</li>
<li>
<p>Pass the config to the Kubernetes APIServer as encryption-provider-config</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once enabled any created secret will be encrypted with this key. Note that if you disable encryption then any encrypted secrets will not be readable until you enable encryption again using the same key.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_secrets_encryption_tool"><a class="anchor" href="#_secrets_encryption_tool"></a>Secrets Encryption Tool</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Version Gate</div>
<div class="paragraph">
<p>Available as of <a href="https://github.com/rancher/rke2/releases/tag/v1.21.8%2Brke2r1">v1.21.8+rke2r1</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>RKE2 contains a subcommand <code>secrets-encrypt</code>, which allows administrators to perform the following tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Adding new encryption keys</p>
</li>
<li>
<p>Rotating and deleting encryption keys</p>
</li>
<li>
<p>Reencrypting secrets</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Failure to follow proper procedure when rotating secrets encryption keys can cause permanent data loss. <a href="../backup_restore.html" class="xref page">Creating a snapshot</a> before rotating is recommended. Proceed with caution.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_encryption_key_rotation_classic"><a class="anchor" href="#_encryption_key_rotation_classic"></a>Encryption Key Rotation Classic</h3>
<div id="_tabs_1" class="openblock tabs is-sync is-loading">
<div class="content">
<div class="ulist tablist">
<ul>
<li id="_tabs_1_single_server" class="tab">
<p>Single-Server</p>
</li>
<li id="_tabs_1_high_availability" class="tab">
<p>High-Availability</p>
</li>
</ul>
</div>
<div id="_tabs_1_single_server--panel" class="tabpanel" aria-labelledby="_tabs_1_single_server">
<div class="paragraph">
<p>To rotate secrets encryption keys on a single-node cluster:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Prepare:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">rke2 secrets-encrypt prepare</code></pre>
</div>
</div>
</li>
<li>
<p>Restart the <code>kube-apiserver</code> pod:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh"># Get the kube-apiserver container ID export CONTAINER_RUNTIME_ENDPOINT="unix:///var/run/k3s/containerd/containerd.sock" crictl ps --name kube-apiserver # Stop the pod crictl stop &lt;CONTAINER_ID&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Rotate:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">rke2 secrets-encrypt rotate</code></pre>
</div>
</div>
</li>
<li>
<p>Restart the <code>kube-apiserver</code> pod again</p>
</li>
<li>
<p>Reencrypt:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">rke2 secrets-encrypt reencrypt</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div id="_tabs_1_high_availability--panel" class="tabpanel" aria-labelledby="_tabs_1_high_availability">
<div class="paragraph">
<p>To rotate secrets encryption keys on HA setups:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In this example, 3 servers are used to for a HA cluster, referred to as S1, S2, S3. While not required, it is recommended that you pick one server node from which to run the <code>secrets-encrypt</code> commands.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Prepare on S1</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">rke2 secrets-encrypt prepare</code></pre>
</div>
</div>
</li>
<li>
<p>Sequentially Restart S1, S2, S3</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">systemctl restart rke2-server.service</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the systemctl command to return before restarting the next server.</p>
</div>
</li>
<li>
<p>Rotate on S1</p>
<div class="listingblock sh">
<div class="content">
<pre>rke2 secrets-encrypt rotate</pre>
</div>
</div>
</li>
<li>
<p>Sequentially Restart S1, S2, S3</p>
</li>
<li>
<p>Reencrypt on S1</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">rke2 secrets-encrypt reencrypt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait until reencryption is finished, either via server logs <code>journalctl -u rke2-server</code> or via <code>rke2 secrets-encrypt status</code>. The status will return <code>reencrypt_finished</code> when done.</p>
</div>
</li>
<li>
<p>Sequentially Restart S1, S2, S3</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_secrets_encryption_status"><a class="anchor" href="#_secrets_encryption_status"></a>Secrets Encryption Status</h3>
<div class="paragraph">
<p>The <code>secrets-encrypt status</code> subcommand displays information about the current status of secrets encryption on the node.</p>
</div>
<div class="paragraph">
<p>An example of the command on a single-server node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">$ rke2 secrets-encrypt status
Encryption Status: Enabled
Current Rotation Stage: start
Server Encryption Hashes: All hashes match

Active  Key Type  Name
------  --------  ----
 *      AES-CBC   aescbckey</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another example on HA cluster, after rotating the keys, but before restarting the servers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">$ rke2 secrets-encrypt status
Encryption Status: Enabled
Current Rotation Stage: rotate
Server Encryption Hashes: hash does not match between node-1 and node-2

Active  Key Type  Name
------  --------  ----
 *      AES-CBC   aescbckey-2021-12-10T22:54:38Z
        AES-CBC   aescbckey</code></pre>
</div>
</div>
<div class="paragraph">
<p>Details on each section are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Encryption Status</strong>: Displayed whether secrets encryption is disabled or enabled on the node</p>
</li>
<li>
<p><strong>Current Rotation Stage</strong>: Indicates the current rotation stage on the node. Stages are: <code>start</code>, <code>prepare</code>, <code>rotate</code>, <code>reencrypt_request</code>, <code>reencrypt_active</code>, <code>reencrypt_finished</code></p>
</li>
<li>
<p><strong>Server Encryption Hashes</strong>: Useful for HA clusters, this indicates whether all servers are on the same stage with their local files. This can be used to identify whether a restart of servers is required before proceeding to the next stage. In the HA example above, node-1 and node-2 have different hashes, indicating that they currently do not have the same encryption configuration. Restarting the servers will sync up their configuration.</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Key Table</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Active</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The <code>*</code> indicates which, if any, of the keys are currently used for secrets encryption. The active key is used by Kubernetes to encrypt any new secrets.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Key Type</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RKE2 only supports the <code>AES-CBC</code> key type. Find more info <a href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/#providers">here.</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the encryption key. Default is <code>aescbckey-&lt;DATE_AND_TIME&gt;</code>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="pod_security_standards.html">Default Pod Security Standards</a></span>
  <span class="next"><a href="selinux.html">SELinux</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/vendor/lunr-languages.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
<script src="../../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../../_/js/vendor/tabs.js"></script>


  </body>
</html>
