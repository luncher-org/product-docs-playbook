<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>k3s token :: Rancher product documentation</title>
    <link rel="canonical" href="https://documentation.suse.com/cloudnative/k3s/latest/zh/cli/token.html">
    <link rel="prev" href="secrets-encrypt.html">
    <link rel="next" href="../architecture.html">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../_/css/search.css">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../../_/css/vendor/light.css">
<!-- <script src="/docserv/res/lightheaded/analytics.js"
        type="text/javascript"></script> -->
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a class=" navbar-logo" href="https://documentation.suse.com/" aria-label="SUSE Documentation Home"><img class="logo"
            src="../../../../_/img/logo.svg" alt="SUSE logo"/></a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">
            <img src="../../../../_/img/resources.png" class="langIcon Resurces" alt="Resources" title="Resources">
          </div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/rancher/k3s-product-docs"><i class="fab fa-github"></i>&nbsp;K3s</a>
            <div class="has-submenu">
              <a class="navbar-item" href="#" ><i class="fas fa-file-alt"></i>&nbsp;Report Issue &nbsp;<i class="fas fa-chevron-right"></i></a>
              <div class="submenu">
                <a class="navbar-item" href="https://scc.suse.com">SCC (Recommended)</a>
                <a class="navbar-item" href="https://github.com/rancher/k3s-product-docs/issues">GitHub Issue</a>
              </div>
            </div>
            <a class="navbar-item" href="https://github.com/rancher/product-docs-playbook/blob/main/CONTRIBUTING.md"><i class="fas fa-user-edit"></i>&nbsp;Contribute</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link"><img src="../../../../_/img/language.png" class="langIcon Language" alt="Language"
              title="Language"></div>
          <div class="navbar-dropdown">
            <!--  </div><div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div> -->
              <a role="button" class="navbar-item" id="en" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/engFlag.svg" class="langIcon english">-->
                &nbsp;English
              </a>
              <a role="button" class="navbar-item" id="zh" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/china.svg" class="langIcon china">-->
                &nbsp;中文
              </a>
              <a role="button" class="navbar-item" id="ko" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/koFlag.svg" class="langIcon korea">-->
                &nbsp;한국어
              </a>
              <a role="button" class="navbar-item" id="ja" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../_/img/jaFlag.svg" class="langIcon japan">-->
                &nbsp;日本語
              </a>
            <!-- LANGUAGESELECTOR -->
          </div>
        </div>
        <!--
        <div class="navbar-item">
          <a href="https://twitter.com/SUSE">
            <img alt="X-logo" class="x-logo" src="../../../../_/img/x-logo-white.png">
          </a>
        </div>
        -->
      </div>
    </div>

    <!--   <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
      </div> -->
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="k3s" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../en/introduction.html">K3s</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../introduction.html">K3s - 轻量级 Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../quick-start.html">快速入门指南</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../installation/installation.html">安装</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/requirements.html">Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/configuration.html">Configuration Options</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/private-registry.html">Private Registry Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/registry-mirror.html">Embedded Registry Mirror</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/airgap.html">Air-Gap Install</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/server-roles.html">Managing Server Roles</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/packaged-components.html">Managing Packaged Components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../installation/uninstall.html">Uninstalling K3s</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../datastore/datastore.html">集群数据存储</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/backup-restore.html">备份和恢复</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/ha-embedded.html">高可用嵌入式 etcd</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/ha.html">高可用外部数据库</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../datastore/cluster-loadbalancer.html">Cluster Load Balancer</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../upgrades/upgrades.html">升级</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrades/killall.html">停止 K3s</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrades/manual.html">手动升级</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../upgrades/automated.html">自动升级</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../security/security.html">安全</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/secrets-encryption.html">Secret 加密配置</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/hardening-guide.html">CIS Hardening Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/self-assessment-1.8.html">CIS 1.8 Self Assessment Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/self-assessment-1.7.html">CIS 1.7 Self Assessment Guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/self-assessment-1.24.html">CIS 1.24 Self Assessment Guide</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="cli.html">CLI 工具</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="server.html">server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="agent.html">agent</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="certificate.html">certificate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="etcd-snapshot.html">etcd-snapshot</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="secrets-encrypt.html">secrets-encrypt</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="token.html">token</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../architecture.html">架构</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../cluster-access.html">集群访问</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../storage.html">卷和存储</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../networking/networking.html">Networking</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/basic-network-options.html">Basic Network Options</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/distributed-multicloud.html">Distributed hybrid or multicloud cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/multus-ipams.html">Multus and IPAM plugins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../networking/networking-services.html">网络</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../helm.html">Helm</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../advanced.html">高级选项和配置</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">参考</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/env-variables.html">环境变量</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/flag-deprecation.html">Flag Deprecation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../reference/resource-profiling.html">资源分析</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <span class="nav-text">Release Notes</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.32.X.html">v1.32.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.31.X.html">v1.31.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.30.X.html">v1.30.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.29.X.html">v1.29.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.28.X.html">v1.28.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.27.X.html">v1.27.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.26.X.html">v1.26.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.25.X.html">v1.25.X</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../release-notes/v1.24.X.html">v1.24.X</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../related-projects.html">Related Projects</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../known-issues.html">已知问题</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../faq.html">常见问题</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">K3s</span>
    <span class="version">Latest</span>
  </div>
  <ul class="components">
        <li class="component">
          <div class="title"><a href="../../../../cluster-api/v0.16/en/index.html">Cluster API</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../cluster-api/v0.16/en/index.html">0.16</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.15/en/index.html">0.15</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.14/en/index.html">0.14</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.13/en/index.html">0.13</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.12/en/index.html">0.12</a>
            </li>
            <li class="version">
              <a href="../../../../cluster-api/v0.11/en/index.html">0.11</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../continuous-delivery/v0.11/en/index.html">Continuous Delivery</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../continuous-delivery/v0.11/en/index.html">0.11</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.10/en/index.html">0.10</a>
            </li>
            <li class="version">
              <a href="../../../../continuous-delivery/v0.9/en/index.html">0.9</a>
            </li>
          </ul>
        </li>
        <li class="component is-current">
          <div class="title"><a href="../../en/introduction.html">K3s</a></div>
          <ul class="versions">
            <li class="version is-current is-latest">
              <a href="../../en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../os-manager/1.6/en/index.html">OS Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../os-manager/1.6/en/index.html">1.6</a>
            </li>
            <li class="version">
              <a href="../../../../os-manager/1.5/en/index.html">1.5</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../policy-manager/1.22/en/introduction.html">Policy Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../policy-manager/1.22/en/introduction.html">1.22-next</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.21/en/introduction.html">1.21</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.20/en/introduction.html">1.20</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.19/en/introduction.html">1.19</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.18/en/introduction.html">1.18</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.17/en/introduction.html">1.17</a>
            </li>
            <li class="version">
              <a href="../../../../policy-manager/1.16/en/introduction.html">1.16</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../rke2/latest/en/introduction.html">RKE2</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../rke2/latest/en/introduction.html">Latest</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">SUSE® Rancher Manager</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html">Latest</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.10/en/about-rancher/what-is-rancher.html">v2.10</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.9/en/about-rancher/what-is-rancher.html">v2.9</a>
            </li>
            <li class="version">
              <a href="../../../../rancher-manager/v2.8/en/about-rancher/what-is-rancher.html">v2.8</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../security/5.4/en/overview.html">SUSE® Security</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../security/5.4/en/overview.html">5.4</a>
            </li>
            <li class="version">
              <a href="../../../../security/5.3/en/overview.html">5.3</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../storage/1.9.0/en/longhorn-documentation.html">SUSE® Storage</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../storage/1.9.0/en/longhorn-documentation.html">1.9.0 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.8.0/en/longhorn-documentation.html">1.8.0 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../storage/1.7.0/en/longhorn-documentation.html">1.7.0</a>
            </li>
          </ul>
        </li>
        <li class="component">
          <div class="title"><a href="../../../../virtualization/v1.5/en/introduction/overview.html">SUSE® Virtualization</a></div>
          <ul class="versions">
            <li class="version is-latest">
              <a href="../../../../virtualization/v1.5/en/introduction/overview.html">v1.5 (Dev)</a>
            </li>
            <li class="version">
              <a href="../../../../virtualization/v1.4/en/introduction/overview.html">v1.4 (Latest)</a>
            </li>
            <li class="version">
              <a href="../../../../virtualization/v1.3/en/introduction/overview.html">v1.3</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../rancher-manager/latest/en/about-rancher/what-is-rancher.html" aria-label="Home" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../en/introduction.html">K3s</a></li>
    <li><a href="cli.html">CLI 工具</a></li>
    <li><a href="token.html">token</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/rancher/k3s-product-docs/edit/main/versions/latest/modules/zh/pages/cli/token.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">k3s token</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>K3s 使用 Token 来保护加入节点的过程 and to encrypt confidential information that is persisted to the datastore。Token 用于验证加入的节点和集群。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_token_格式"><a class="anchor" href="#_token_格式"></a>Token 格式</h2>
<div class="sectionbody">
<div class="paragraph">
<p>K3s Token 可以使用安全（secure）或短（short）格式。安全格式能让客户端在发送凭证之前验证加入的集群的身份，因此首选安全格式。</p>
</div>
<div class="sect2">
<h3 id="_secure"><a class="anchor" href="#_secure"></a>Secure</h3>
<div class="paragraph">
<p>安全 Token 格式（有时称为"`完整`" Token 格式）包含以下部分：</p>
</div>
<div class="paragraph">
<p><code>&lt;prefix&gt;&lt;cluster CA hash&gt;::&lt;credentials&gt;</code></p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>prefix</code>：固定的 <code>K10</code> 前缀，用来标识 token 格式</p>
</li>
<li>
<p><code>cluster CA hash</code>：集群的 Server CA 证书的哈希，用于为加入的节点验证 Server。</p>
<div class="ulist">
<ul>
<li>
<p>对于自签名 CA 证书，这是存储在磁盘上的 PEM 格式证书的 SHA256 总和。</p>
</li>
<li>
<p>对于自定义 CA 证书，这是根证书的 DER 编码的 SHA256 总和，也称为证书指纹。</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>credentials</code>：用户名和密码，或持有者 Token，用于验证加入集群的节点。</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_tls_引导"><a class="anchor" href="#_tls_引导"></a>TLS 引导</h4>
<div class="paragraph">
<p>如果指定了安全 Token，在传输凭证之前，加入的节点会执行以下步骤来认证连接的 Server：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>禁用 TLS 验证后，从要加入的 Server 上的 <code>/cacerts</code> 下载 CA 包。</p>
</li>
<li>
<p>如上所述计算 CA 证书的 SHA256 哈希值。</p>
</li>
<li>
<p>比较计算出的 SHA256 哈希值与 Token 中的哈希值。</p>
</li>
<li>
<p>如果哈希值匹配，则验证 Server 提供的证书是否可以由 Server 的 CA 包进行验证。</p>
</li>
<li>
<p>如果 Server 证书有效，你需要使用基础或持有者 Token 认证（根据 Token 的类型）来提供加入集群的凭证。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_short"><a class="anchor" href="#_short"></a>Short</h3>
<div class="paragraph">
<p>短 Token 格式仅包括用于验证加入集群的节点的密码或持有者 Token。</p>
</div>
<div class="paragraph">
<p>如果使用了短 Token，则加入的节点会隐式信任 Server 提供的 CA 包，以及跳过 TLS 引导过程中的步骤 2-4。初始连接可能容易受到<a href="https://en.wikipedia.org/wiki/Man-in-the-middle_attack">中间人</a>攻击。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_token_类型"><a class="anchor" href="#_token_类型"></a>Token 类型</h2>
<div class="sectionbody">
<div class="paragraph">
<p>K3s 支持三种类型的 Token。默认情况下只有 Server Token 可用，其他类型的 Token 必须由管理员配置或创建。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">类型</th>
<th class="tableblock halign-left valign-top">CLI 选项</th>
<th class="tableblock halign-left valign-top">环境变量</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--token</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>K3S_TOKEN</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Agent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--agent-token</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>K3S_AGENT_TOKEN</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bootstrap</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>n/a</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>n/a</code></p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="_server"><a class="anchor" href="#_server"></a>Server</h3>
<div class="paragraph">
<p>如果在启动集群中的第一个 Server 时未提供 Token，则会使用随机密码创建。Server Token 始终以安全格式写入 <code>/var/lib/rancher/k3s/server/token</code>。</p>
</div>
<div class="paragraph">
<p>The server token can be used to join both server and agent nodes to the cluster. Anyone with access to the server token essentially has full administrator access to the cluster. This token should be guarded carefully.</p>
</div>
<div class="paragraph">
<p>The server token is also used as the <a href="https://en.wikipedia.org/wiki/PBKDF2">PBKDF2</a> passphrase to encrypt confidential information that is persisted to the datastore known as bootstrap data. Bootstrap data is essential to set up new server nodes or restore from a snapshot. For this reason, the token must be backed up alongside the cluster datastore itself.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>除非使用了自定义 CA 证书，否则在启动集群的第一个 Server 时只能使用短 Token 格式（仅密码）。这是因为只有在 Server 生成自签名集群 CA 证书后才能知道集群 CA 哈希值。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>有关使用自定义 CA 证书的更多信息，请参阅 <a href="certificate.html" class="xref page"><code>k3s certificate</code> 文档</a>。<br>
有关备份集群的更多信息，请参阅<a href="../datastore/backup-restore.html" class="xref page">备份和恢复</a>文档。</p>
</div>
</div>
<div class="sect2">
<h3 id="_agent"><a class="anchor" href="#_agent"></a>Agent</h3>
<div class="paragraph">
<p>默认情况下，Agent Token 与 Server Token 相同。你可以通过更改集群中所有 Server 上的 CLI 选项或环境变量，在集群启动之前或之后设置 Agent Token。Agent Token 类似于 Server Token，是静态配置的并且不会过期。</p>
</div>
<div class="paragraph">
<p>Agent Token 以安全格式写入 <code>/var/lib/rancher/k3s/server/agent-token</code>。如果未指定 Agent Token，则此文件是指向 Server Token 的链接。</p>
</div>
</div>
<div class="sect2">
<h3 id="_bootstrap"><a class="anchor" href="#_bootstrap"></a>Bootstrap</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">版本</div>
<div class="paragraph">
<p>从 2023-02 版本（v1.26.2+k3s1、v1.25.7+k3s1、v1.24.11+k3s1、v1.23.17+k3s1）开始，支持 <code>k3s token</code> 命令以及使用 Bootstrap Token 加入节点。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>K3s supports dynamically generated, automatically expiring agent <a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/">bootstrap tokens</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_k3s_token"><a class="anchor" href="#_k3s_token"></a>k3s token</h2>
<div class="sectionbody">
<div class="paragraph">
<p>K3s Bootstrap Token 使用与 <code>kubeadm token</code> Bootstrap Token 相同的生成和验证代码，<code>k3s token</code> CLI 也是类似的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME:
   k3s token - Manage bootstrap tokens

USAGE:
   k3s token command [command options] [arguments...]

COMMANDS:
   create    Create bootstrap tokens on the server
   delete    Delete bootstrap tokens on the server
   generate  Generate and print a bootstrap token, but do not create it on the server
   list      List bootstrap tokens on the server

OPTIONS:
   --help, -h  show help</pre>
</div>
</div>
<h3 id="_k3s_token_create_token" class="discrete"><code>k3s token create [token]</code></h3>
<div class="paragraph">
<p>创建一个新 Token。<code>[token]</code> 是要写入的实际 Token，由 <code>k3s token generate</code> 生成。如果没有指定 Token，将生成一个随机 Token。</p>
</div>
<div class="paragraph">
<p>安全格式的 Token（包括集群 CA 哈希）会写入到 stdout。Token 的 secret 部分只显示一次，因此你需要保存此命令的输出。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">标志</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--data-dir</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">保存状态的（数据）文件夹，如果不是 root，则默认为 <code>/var/lib/rancher/k3s 或 ${HOME}/.rancher/k3s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kubeconfig</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">要连接到 [$KUBECONFIG] 的（集群）Server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--description</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">有关如何使用此 Token 的描述</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--groups</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">该 Token 用于认证的其他组（默认值：&#8220;system:bootstrappers:k3s:default-node-token&#8221;）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--ttl</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">自动删除 Token 的时间（例如 1s、2m、3h）。如果设置为 <code>0</code>，Token 将永不过期（默认值：24h0m0s）</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--usages</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">描述可使用此 Token 的方式。(默认值："signing,authentication")</p></td>
</tr>
</tbody>
</table>
<h3 id="_k3s_token_delete" class="discrete"><code>k3s token delete</code></h3>
<div class="paragraph">
<p>删除一个或多个 Token。你可以提供完整的 Token，也可以仅提供 Token ID。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">标志</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--data-dir</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">保存状态的（数据）文件夹，如果不是 root，则默认为 <code>/var/lib/rancher/k3s 或 ${HOME}/.rancher/k3s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kubeconfig</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">要连接到 [$KUBECONFIG] 的（集群）Server</p></td>
</tr>
</tbody>
</table>
<h3 id="_k3s_token_generate" class="discrete"><code>k3s token generate</code></h3>
<div class="paragraph">
<p>生成一个随机的 Bootstrap Token。</p>
</div>
<div class="paragraph">
<p>你不需要使用此命令来生成 Token。只要格式为 <code>[a-z0-9]{6}.[a-z0-9]{16}</code>（其中第一部分是 Token ID，第二部分是 Secret），你就可以自己进行操作。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">标志</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--data-dir</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">保存状态的（数据）文件夹，如果不是 root，则默认为 <code>/var/lib/rancher/k3s 或 ${HOME}/.rancher/k3s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kubeconfig</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">要连接到 [$KUBECONFIG] 的（集群）Server</p></td>
</tr>
</tbody>
</table>
<h3 id="_k3s_token_list" class="discrete"><code>k3s token list</code></h3>
<div class="paragraph">
<p>列出 Bootstrap Token，这将显示 Token 的 ID、描述和剩余 TTL。</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">标志</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--data-dir</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">保存状态的（数据）文件夹，如果不是 root，则默认为 <code>/var/lib/rancher/k3s 或 ${HOME}/.rancher/k3s</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kubeconfig</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">要连接到 [$KUBECONFIG] 的（集群）Server</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--output</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">输出格式。可选值：text、json（默认值：<code>text</code>）</p></td>
</tr>
</tbody>
</table>
<div class="sect2">
<h3 id="_k3s_token_rotate"><a class="anchor" href="#_k3s_token_rotate"></a><code>k3s token rotate</code></h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Version Gate</div>
<div class="paragraph">
<p>Available as of the October 2023 releases (v1.28.2+k3s1, v1.27.7+k3s1, v1.26.10+k3s1, v1.25.15+k3s1).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Rotate original server token with a new server token. After running this command, all servers and any agents that originally joined with the old token must be restarted with the new token.</p>
</div>
<div class="paragraph">
<p>If you do not specify a new token, one will be generated for you.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Flag</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--data-dir</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Folder to hold state (default: /var/lib/rancher/k3s or ${HOME}/.rancher/k3s if not root)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--kubeconfig</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server to connect to [$KUBECONFIG]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--server</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Server to connect to (default: "https://127.0.0.1:6443") [$K3S_URL]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--token</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Existing token used to join a server or agent to a cluster [$K3S_TOKEN]</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>--new-token</code> value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">New token that replaces existing token</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Snapshots taken before the rotation will require the old server token when restoring the cluster.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="secrets-encrypt.html">secrets-encrypt</a></span>
  <span class="next"><a href="../architecture.html">架构</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/vendor/lunr-languages.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
<script src="../../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../../_/js/vendor/tabs.js"></script>


  </body>
</html>
